<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p h·ªá th·ªëng</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        /* French romantic background elements */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="fleur" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23fleur)"/></svg>') repeat;
            opacity: 0.3;
            z-index: 1;
        }
        
        .login-container { 
            max-width: 550px; 
            width: 90%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            padding: 50px 40px;
            position: relative;
            z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            border-radius: 27px;
            z-index: -1;
            opacity: 0.7;
            animation: gradientShift 8s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff); }
            25% { background: linear-gradient(45deg, #feca57, #48dbfb, #ff9ff3, #54a0ff, #ff6b6b); }
            50% { background: linear-gradient(45deg, #48dbfb, #ff9ff3, #54a0ff, #ff6b6b, #feca57); }
            75% { background: linear-gradient(45deg, #ff9ff3, #54a0ff, #ff6b6b, #feca57, #48dbfb); }
        }
        
        h2 { 
            text-align: center; 
            margin-bottom: 40px;
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            white-space: nowrap;
        }
        
        h2::after {
            content: '‚ú®';
            position: absolute;
            right: -30px;
            top: 0;
            font-size: 1.5rem;
            animation: sparkle 2s ease-in-out infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        }
        
        .form-group { 
            margin-bottom: 25px;
            position: relative;
        }
        
        label { 
            display: block; 
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }
        
        input[type="text"], input[type="password"] { 
            width: 100%; 
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            transition: all 0.3s ease;
            outline: none;
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }
        
        .password-container { position: relative; }
        
        .password-toggle { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #667eea;
            font-size: 18px;
            transition: all 0.3s ease;
            padding: 5px;
            border-radius: 50%;
        }
        
        .password-toggle:hover { 
            color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-50%) scale(1.1);
        }
        
        .password-container input[type="password"], 
        .password-container input[type="text"] { 
            padding-right: 50px; 
        }
        
        .btn { 
            width: 100%; 
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'Crimson Text', serif;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover { 
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled { 
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .error { 
            color: #e53e3e;
            text-align: center; 
            margin-bottom: 15px;
            font-weight: 600;
            background: rgba(229, 62, 62, 0.1);
            padding: 10px;
            border-radius: 10px;
            border-left: 4px solid #e53e3e;
        }
        .com-status { 
            font-size: 14px; 
            color: #667eea; 
            text-align: center; 
            margin-top: 20px; 
            padding: 12px 20px; 
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .serial-permission {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .serial-permission h4 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .serial-permission p {
            margin: 8px 0;
            font-size: 15px;
            color: #4a5568;
            line-height: 1.6;
        }
        .serial-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .serial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .serial-btn:disabled {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .detected-ports {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        .port-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }
        .port-item:last-child {
            border-bottom: none;
        }
        .port-name {
            font-weight: 600;
            color: #667eea;
            font-family: 'Playfair Display', serif;
        }
        .port-info {
            color: #4a5568;
            font-size: 13px;
        }
        .help-section {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            font-size: 14px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .help-section h4 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 16px;
            font-family: 'Playfair Display', serif;
            font-weight: 600;
        }
        .help-steps {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        /* Floating elements for romantic atmosphere */
        .floating-hearts {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .heart {
            position: absolute;
            color: rgba(255, 255, 255, 0.3);
            font-size: 20px;
            animation: float 6s ease-in-out infinite;
        }
        
        .heart:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
        .heart:nth-child(2) { top: 60%; left: 80%; animation-delay: 2s; }
        .heart:nth-child(3) { top: 80%; left: 20%; animation-delay: 4s; }
        .heart:nth-child(4) { top: 30%; left: 70%; animation-delay: 1s; }
        .heart:nth-child(5) { top: 70%; left: 60%; animation-delay: 3s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; }
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .login-container {
                margin: 20px;
                padding: 30px 25px;
            }
            
            h2 {
                font-size: 2rem;
            }
            
            h2::after {
                right: -25px;
                font-size: 1.2rem;
            }
            
            .success-card {
                padding: 30px 25px;
                margin: 20px;
                max-width: calc(100vw - 40px);
                min-width: 280px;
            }
            
            .success-icon {
                width: 80px;
                height: 80px;
                margin-bottom: 20px;
            }
            
            .success-icon::before {
                font-size: 40px;
            }
            
            .success-title {
                font-size: 24px;
                margin-bottom: 15px;
            }
            
            .success-subtitle {
                font-size: 14px;
                margin-bottom: 25px;
            }
            
            .progress-container {
                height: 8px;
                margin-bottom: 20px;
            }
            
            .loading-text {
                font-size: 14px;
            }
        }
        
        @media (max-width: 768px) {
            .success-card {
                padding: 40px 30px;
                margin: 30px;
                max-width: calc(100vw - 60px);
            }
        }
        
        @media (min-width: 1200px) {
            .success-card {
                max-width: 600px;
                padding: 60px 50px;
            }
        }
        .help-steps li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .help-steps li:before {
            content: "üìå ";
            margin-right: 8px;
        }
        .help-steps li:last-child {
            border-bottom: none;
        }
        .browser-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }
        .toggle-help {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px;
        }
        .toggle-help:hover {
            background: #5a6268;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            color: #666;
        }
        
        /* French Romantic Login Success Animation */
        .login-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(15px);
            overflow: hidden;
        }
        
        /* Floating hearts in success overlay */
        .login-success-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="successHearts" patternUnits="userSpaceOnUse" width="30" height="30"><circle cx="15" cy="15" r="3" fill="rgba(255,255,255,0.2)"/><circle cx="5" cy="25" r="2" fill="rgba(255,255,255,0.15)"/></pattern></defs><rect width="100" height="100" fill="url(%23successHearts)"/></svg>') repeat;
            opacity: 0.4;
            animation: floatPattern 20s linear infinite;
        }
        
        @keyframes floatPattern {
            0% { transform: translateY(0px) translateX(0px); }
            100% { transform: translateY(-100px) translateX(-100px); }
        }
        
        .login-success-overlay.show {
            display: flex;
            opacity: 1;
            visibility: visible;
        }
        
        /* ·∫®n form ƒëƒÉng nh·∫≠p khi popup hi·ªÉn th·ªã */
        .login-success-overlay.show ~ .login-container {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: all 0.5s ease;
        }
        
        .login-success-overlay.show ~ .floating-hearts {
            opacity: 0;
            transition: all 0.5s ease;
        }
        
        .success-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border-radius: 25px;
            padding: 50px 40px;
            text-align: center;
            box-shadow: 
                0 30px 80px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: scale(0.8) translateY(30px);
            animation: romanticCardEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards 0.1s;
            max-width: 550px;
            min-width: 320px;
            width: 90%;
            max-width: min(550px, 90vw);
            position: relative;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .success-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff);
            border-radius: 27px;
            z-index: -1;
            opacity: 0.6;
            animation: gradientShift 6s ease infinite;
        }
        
        .success-icon {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 35px;
            position: relative;
            transform: scale(0);
            animation: romanticIconPulse 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards 0.3s;
            box-shadow: 
                0 15px 40px rgba(76, 175, 80, 0.4),
                0 0 0 8px rgba(76, 175, 80, 0.1);
        }
        
        .success-icon::before {
            content: '‚ú®';
            font-size: 60px;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
            animation: sparkleRotate 2s ease-in-out infinite;
        }
        
        .success-icon::after {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            opacity: 0;
            animation: romanticRipple 1.2s ease-out 0.6s;
            z-index: -1;
        }
        
        .success-title {
            color: #2c3e50;
            font-size: 32px;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
            margin-bottom: 20px;
            opacity: 0;
            animation: romanticFadeInUp 0.8s ease-out forwards 0.4s;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .success-subtitle {
            color: #4a5568;
            font-size: 18px;
            font-family: 'Crimson Text', serif;
            margin-bottom: 35px;
            opacity: 0;
            animation: romanticFadeInUp 0.8s ease-out forwards 0.5s;
            line-height: 1.6;
        }
        
        .progress-container {
            width: 100%;
            height: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            opacity: 0;
            animation: romanticFadeInUp 0.8s ease-out forwards 0.6s;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            width: 0%;
            animation: romanticProgressFill 3s ease-out forwards 0.8s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s ease-in-out infinite;
        }
        
        .loading-text {
            color: #667eea;
            font-size: 16px;
            font-family: 'Crimson Text', serif;
            opacity: 0;
            animation: romanticFadeInUp 0.8s ease-out forwards 0.7s;
            font-weight: 500;
        }
        
        @keyframes romanticCardEntrance {
            0% { 
                transform: scale(0.8) translateY(30px) rotate(-5deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.05) translateY(-10px) rotate(2deg);
            }
            100% { 
                transform: scale(1) translateY(0) rotate(0deg);
                opacity: 1;
            }
        }
        
        @keyframes romanticIconPulse {
            0% { 
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.2) rotate(10deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        @keyframes romanticRipple {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        @keyframes romanticFadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes sparkleRotate {
            0%, 100% { 
                transform: rotate(0deg) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: rotate(180deg) scale(1.1); 
                opacity: 1; 
            }
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes romanticProgressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- French Romantic Login Success Animation Overlay -->
    <div id="loginSuccessOverlay" class="login-success-overlay">
        <div class="success-card">
            <div class="success-icon"></div>
            <div class="success-title">ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</div>
            <div class="success-subtitle">ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch√≠nh...</div>
            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>
            <div class="loading-text">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
        </div>
    </div>
    
    <!-- Floating hearts for romantic atmosphere -->
    <div class="floating-hearts">
        <div class="heart">üíñ</div>
        <div class="heart">üíï</div>
        <div class="heart">üíó</div>
        <div class="heart">üíù</div>
        <div class="heart">üíò</div>
    </div>
    
    <div class="login-container">
        <h2>ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h2>
        
        <!-- Serial Port Permission Section -->
        <div class="serial-permission" id="serialPermission" style="display: none;">
            <h4>üîå K·∫øt n·ªëi COM Port</h4>
            <p>Ch·ªçn c·ªïng COM ƒë·ªÉ k·∫øt n·ªëi m√°y qu√©t:</p>
            
            <!-- COM Port Selection -->
            <div id="comPortSelection" style="margin: 15px 0;">
                <label for="comPortSelect" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    Ch·ªçn c·ªïng COM:
                </label>
                <select id="comPortSelect" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Ch·ªçn c·ªïng COM --</option>
                </select>
                <div id="comPortInfo" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
            </div>
            
            <!-- Action Buttons -->
            <div style="margin: 15px 0;">
                <button class="serial-btn" id="connectComBtn" onclick="connectToSelectedPort()" disabled>
                    üîå K·∫øt n·ªëi COM Port
                </button>
                <button class="serial-btn" id="disconnectComBtn" onclick="disconnectComPort()" disabled style="background: #dc3545;">
                    ‚ùå Ng·∫Øt k·∫øt n·ªëi
                </button>
                <button class="serial-btn" id="testComBtn" onclick="testComInput()" style="background: #ff9800;">
                    üß™ Test Input
                </button>
            </div>
            
            <!-- Connection Status -->
            <div id="connectionStatus" style="margin: 15px 0; padding: 10px; border-radius: 4px; background: #f8f9fa; border: 1px solid #e9ecef;">
                <div id="comStatus">Ch∆∞a k·∫øt n·ªëi COM port</div>
                <div id="inputStatus" style="font-size: 12px; color: #666; margin-top: 5px;">
                    Ch·ªù d·ªØ li·ªáu t·ª´ m√°y qu√©t...
                </div>
            </div>
            
            <!-- Input Display -->
            <div id="inputDisplay" style="margin: 15px 0; padding: 10px; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; display: none;">
                <h5 style="margin: 0 0 10px 0; color: #1976d2;">üì± D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:</h5>
                <div id="receivedData" style="font-family: monospace; background: white; padding: 8px; border-radius: 3px; border: 1px solid #ccc;"></div>
                <div id="inputActions" style="margin-top: 10px;">
                    <button class="serial-btn" onclick="copyToClipboard()" style="background: #28a745; font-size: 12px; padding: 5px 10px;">
                        üìã Copy
                    </button>
                    <button class="serial-btn" onclick="clearInput()" style="background: #6c757d; font-size: 12px; padding: 5px 10px;">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>
            
            <button class="toggle-help" onclick="toggleHelp()">
                H∆∞·ªõng d·∫´n chi ti·∫øt
            </button>
        </div>
        
        <!-- Help Section -->
        <div class="help-section" id="helpSection" style="display: none;">
            <h4>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Serial Ports</h4>
            <ul class="help-steps">
                <li><strong>B∆∞·ªõc 1:</strong> K·∫øt n·ªëi m√°y qu√©t v√†o c·ªïng USB</li>
                <li><strong>B∆∞·ªõc 2:</strong> Click "Y√™u c·∫ßu quy·ªÅn truy c·∫≠p"</li>
                <li><strong>B∆∞·ªõc 3:</strong> Ch·ªçn m√°y qu√©t trong popup v√† click "K·∫øt n·ªëi"</li>
                <li><strong>B∆∞·ªõc 4:</strong> Click "Qu√©t COM Ports" ƒë·ªÉ ph√°t hi·ªán thi·∫øt b·ªã</li>
                <li><strong>B∆∞·ªõc 5:</strong> Th√¥ng tin s·∫Ω ƒë∆∞·ª£c g·ª≠i l√™n server t·ª± ƒë·ªông</li>
            </ul>
            
            <div class="browser-warning">
                <strong>L∆∞u √Ω:</strong> Ch·ªâ ho·∫°t ƒë·ªông tr√™n Chrome/Edge m·ªõi nh·∫•t. Firefox/Safari ch∆∞a h·ªó tr·ª£.
            </div>
            
            <h4>üîß X·ª≠ l√Ω s·ª± c·ªë:</h4>
            <ul class="help-steps">
                <li><strong>Kh√¥ng th·∫•y n√∫t:</strong> Ki·ªÉm tra tr√¨nh duy·ªát Chrome/Edge</li>
                <li><strong>Kh√¥ng t√¨m th·∫•y m√°y qu√©t:</strong> R√∫t ra c·∫Øm l·∫°i, ki·ªÉm tra driver</li>
                <li><strong>T·ª´ ch·ªëi quy·ªÅn:</strong> Click kh√≥a ·ªü thanh ƒë·ªãa ch·ªâ ‚Üí Cho ph√©p</li>
                <li><strong>L·ªói k·∫øt n·ªëi:</strong> Refresh trang v√† th·ª≠ l·∫°i</li>
            </ul>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                <input type="text" id="username" name="username" required placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p c·ªßa b·∫°n">
            </div>
            <div class="form-group">
                <label for="password">M·∫≠t kh·∫©u</label>
                <div class="password-container">
                    <input type="password" id="password" name="password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n">
                    <button type="button" class="password-toggle" onclick="togglePassword()">üëÅÔ∏è</button>
                </div>
            </div>
            <div class="error" id="errorMsg"></div>
            <button type="submit" class="btn">ƒêƒÉng Nh·∫≠p</button>
            <div class="com-status" id="comStatus">Ch∆∞a ph√°t hi·ªán COM ports</div>
        </form>
    </div>
    
    <script>
        let serialPorts = [];
        let hasSerialAccess = false;
        let helpVisible = false;
        let currentPort = null;
        let isConnected = false;
        let isListening = false;
        let assignedComPort = null;
        
        // H√†m ki·ªÉm tra h·ªó tr·ª£ Web Serial API m·ªôt c√°ch ch√≠nh x√°c
        function checkSerialSupport() {
            try {
                // Ki·ªÉm tra navigator.serial c√≥ t·ªìn t·∫°i kh√¥ng
                if (typeof navigator === 'undefined') {
                    return { supported: false, reason: 'Navigator kh√¥ng t·ªìn t·∫°i' };
                }
                
                if (!('serial' in navigator)) {
                    return { supported: false, reason: 'serial kh√¥ng c√≥ trong navigator' };
                }
                
                // Ki·ªÉm tra c√°c method c·∫ßn thi·∫øt
                if (typeof navigator.serial.requestPort !== 'function') {
                    return { supported: false, reason: 'requestPort kh√¥ng ph·∫£i function' };
                }
                
                if (typeof navigator.serial.getPorts !== 'function') {
                    return { supported: false, reason: 'getPorts kh√¥ng ph·∫£i function' };
                }
                
                // Ki·ªÉm tra user agent ƒë·ªÉ x√°c ƒë·ªãnh tr√¨nh duy·ªát
                const userAgent = navigator.userAgent.toLowerCase();
                const isChrome = userAgent.includes('chrome') && !userAgent.includes('edg');
                const isEdge = userAgent.includes('edg');
                const isFirefox = userAgent.includes('firefox');
                const isSafari = userAgent.includes('safari') && !userAgent.includes('chrome');
                
                let browserInfo = 'Unknown';
                if (isChrome) browserInfo = 'Chrome';
                else if (isEdge) browserInfo = 'Edge';
                else if (isFirefox) browserInfo = 'Firefox';
                else if (isSafari) browserInfo = 'Safari';
                
                return { 
                    supported: true, 
                    browser: browserInfo,
                    userAgent: userAgent
                };
                
            } catch (error) {
                return { supported: false, reason: 'L·ªói ki·ªÉm tra: ' + error.message };
            }
        }
        
        // Ki·ªÉm tra h·ªó tr·ª£ Web Serial API khi trang load
        function initSerialSupport() {
            const serialPermission = document.getElementById('serialPermission');
            const supportInfo = checkSerialSupport();
            
            console.log('Serial support check:', supportInfo);
            
            if (!supportInfo.supported) {
                serialPermission.innerHTML = `
                    <h4>‚ùå Kh√¥ng h·ªó tr·ª£ Serial API</h4>
                    <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Serial API.</p>
                    <div class="browser-warning">
                        <strong>L√Ω do:</strong> ${supportInfo.reason}<br>
                        <strong>Y√™u c·∫ßu:</strong> Chrome 89+ ho·∫∑c Edge 89+ ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.
                    </div>
                    <div class="debug-info">
                        <strong>Debug info:</strong><br>
                        User Agent: ${navigator.userAgent}<br>
                        Navigator: ${typeof navigator}<br>
                        Serial in navigator: ${'serial' in navigator}<br>
                        Serial type: ${typeof navigator.serial}
                    </div>
                `;
            } else {
                // Hi·ªÉn th·ªã th√¥ng tin debug n·∫øu c·∫ßn
                const debugInfo = document.createElement('div');
                debugInfo.className = 'debug-info';
                debugInfo.innerHTML = `
                    <strong>Debug info:</strong><br>
                    Browser: ${supportInfo.browser}<br>
                    Serial API: Supported<br>
                    User Agent: ${supportInfo.userAgent}
                `;
                serialPermission.appendChild(debugInfo);
            }
        }
        
        // Toggle help section
        function toggleHelp() {
            const helpSection = document.getElementById('helpSection');
            const toggleBtn = document.querySelector('.toggle-help');
            
            if (helpVisible) {
                helpSection.style.display = 'none';
                toggleBtn.textContent = 'H∆∞·ªõng d·∫´n chi ti·∫øt';
                helpVisible = false;
            } else {
                helpSection.style.display = 'block';
                toggleBtn.textContent = '·∫®n h∆∞·ªõng d·∫´n';
                helpVisible = true;
            }
        }
        
        // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p serial ports
        async function requestSerialAccess() {
            try {
                const requestBtn = document.getElementById('requestSerialBtn');
                const scanBtn = document.getElementById('scanPortsBtn');
                
                requestBtn.disabled = true;
                requestBtn.textContent = '‚è≥ ƒêang y√™u c·∫ßu quy·ªÅn...';
                
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p serial ports
                const port = await navigator.serial.requestPort();
                
                hasSerialAccess = true;
                requestBtn.textContent = 'ƒê√£ c√≥ quy·ªÅn truy c·∫≠p';
                requestBtn.style.background = '#4caf50';
                scanBtn.disabled = false;
                
                console.log('Serial access granted:', port);
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showMessage('success', 'ƒê√£ c·∫•p quy·ªÅn truy c·∫≠p serial ports! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ qu√©t COM ports.');
                
            } catch (error) {
                console.error('Serial access denied:', error);
                document.getElementById('requestSerialBtn').textContent = 'T·ª´ ch·ªëi quy·ªÅn truy c·∫≠p';
                document.getElementById('requestSerialBtn').style.background = '#f44336';
                
                let errorMsg = 'L·ªói khi y√™u c·∫ßu quy·ªÅn truy c·∫≠p: ' + error.message;
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p. Vui l√≤ng th·ª≠ l·∫°i v√† ch·ªçn "Cho ph√©p".';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'Kh√¥ng t√¨m th·∫•y serial ports. Vui l√≤ng k·∫øt n·ªëi thi·∫øt b·ªã v√† th·ª≠ l·∫°i.';
                }
                
                showMessage('error', errorMsg);
            }
        }
        
        // Qu√©t serial ports
        async function scanSerialPorts() {
            try {
                const scanBtn = document.getElementById('scanPortsBtn');
                const detectedPorts = document.getElementById('detectedPorts');
                const portsList = document.getElementById('portsList');
                
                scanBtn.disabled = true;
                scanBtn.textContent = '‚è≥ ƒêang qu√©t...';
                
                // L·∫•y danh s√°ch ports ƒë√£ ƒë∆∞·ª£c c·∫•p quy·ªÅn
                const ports = await navigator.serial.getPorts();
                
                serialPorts = [];
                portsList.innerHTML = '';
                
                if (ports.length === 0) {
                    portsList.innerHTML = '<div style="color: #999; font-style: italic;">Kh√¥ng c√≥ serial ports n√†o ƒë∆∞·ª£c c·∫•p quy·ªÅn</div>';
                    showMessage('error', 'Kh√¥ng t√¨m th·∫•y serial ports. Vui l√≤ng y√™u c·∫ßu quy·ªÅn truy c·∫≠p tr∆∞·ªõc.');
                } else {
                    for (const port of ports) {
                        try {
                            const info = port.getInfo();
                            const portData = {
                                path: `COM${info.usbVendorId}-${info.usbProductId}` || 'Unknown',
                                manufacturer: info.usbVendorId ? `Vendor: ${info.usbVendorId}` : 'Unknown',
                                vendorId: info.usbVendorId || null,
                                productId: info.usbProductId || null,
                                isAvailable: true,
                                isLikelyScanner: checkIfScanner(info),
                                confidence: checkIfScanner(info) ? 'high' : 'medium',
                                deviceType: checkIfScanner(info) ? 'Scanner Device' : 'Serial Device'
                            };
                            
                            serialPorts.push(portData);
                            
                            // Hi·ªÉn th·ªã port
                            const portDiv = document.createElement('div');
                            portDiv.className = 'port-item';
                            portDiv.innerHTML = `
                                <div>
                                    <div class="port-name">${portData.path}</div>
                                    <div class="port-info">${portData.manufacturer}</div>
                                </div>
                                <div>
                                    <span style="background: ${portData.isLikelyScanner ? '#4caf50' : '#ff9800'}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                        ${portData.isLikelyScanner ? 'üì± Scanner' : 'üîå Device'}
                                    </span>
                                </div>
                            `;
                            portsList.appendChild(portDiv);
                        } catch (error) {
                            console.error('Error getting port info:', error);
                        }
                    }
                }
                
                detectedPorts.style.display = 'block';
                scanBtn.disabled = false;
                scanBtn.textContent = 'üîç Qu√©t l·∫°i COM Ports';
                
                // G·ª≠i d·ªØ li·ªáu l√™n server
                await sendComPortsToServer();
                
            } catch (error) {
                console.error('Error scanning serial ports:', error);
                showMessage('error', 'L·ªói khi qu√©t serial ports: ' + error.message);
                
                document.getElementById('scanPortsBtn').disabled = false;
                document.getElementById('scanPortsBtn').textContent = 'üîç Qu√©t COM Ports';
            }
        }
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i l√† m√°y qu√©t kh√¥ng
        function checkIfScanner(info) {
            // M·ªôt s·ªë Vendor ID ph·ªï bi·∫øn c·ªßa m√°y qu√©t
            const scannerVendors = [
                '0x05e0', // Symbol Technologies
                '0x0c2e', // Honeywell
                '0x05e0', // Motorola
                '0x0c2e', // Datalogic
                '0x05e0', // Zebra
                '0x0c2e'  // Generic Scanner
            ];
            
            if (info.usbVendorId) {
                const vendorId = '0x' + info.usbVendorId.toString(16).padStart(4, '0');
                return scannerVendors.includes(vendorId.toLowerCase());
            }
            
            return false;
        }
        
        // G·ª≠i COM ports l√™n server
        async function sendComPortsToServer() {
            try {
                const hostname = window.location.hostname;
                const platform = navigator.platform;
                
                console.log('Sending COM ports to server:', serialPorts);
                
                const response = await fetch('/api/machine/register-com-ports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comPorts: serialPorts,
                        hostname,
                        platform
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('COM ports registered successfully:', result.data);
                    const comStatus = document.getElementById('comStatus');
                    comStatus.textContent = `‚úÖ ƒê√£ ph√°t hi·ªán ${serialPorts.length} COM ports`;
                    comStatus.style.color = '#28a745';
                    showMessage('success', `‚úÖ ƒê√£ g·ª≠i ${serialPorts.length} COM ports l√™n server th√†nh c√¥ng!`);
                } else {
                    console.error('Failed to register COM ports:', result.message);
                    const comStatus = document.getElementById('comStatus');
                    comStatus.textContent = '‚ùå L·ªói g·ª≠i COM ports';
                    comStatus.style.color = '#dc3545';
                    showMessage('error', 'L·ªói g·ª≠i COM ports: ' + result.message);
                }
            } catch (error) {
                console.error('Error sending COM ports:', error);
                const comStatus = document.getElementById('comStatus');
                comStatus.textContent = '‚ùå L·ªói k·∫øt n·ªëi';
                comStatus.style.color = '#dc3545';
                showMessage('error', 'L·ªói k·∫øt n·ªëi server: ' + error.message);
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(type, message) {
            // X√≥a th√¥ng b√°o c≈©
            const oldMessage = document.querySelector('.success-message, .error-message, .warning-message');
            if (oldMessage) {
                oldMessage.remove();
            }
            
            // T·∫°o th√¥ng b√°o m·ªõi
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 
                                  type === 'warning' ? 'warning-message' : 'error-message';
            messageDiv.textContent = message;
            
            // Th√™m v√†o sau serial permission section
            const serialSection = document.getElementById('serialPermission');
            serialSection.appendChild(messageDiv);
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // T·ª± ƒë·ªông k·∫øt n·ªëi COM port
        async function autoConnectToComPort(assignedPort) {
            try {
                console.log('Auto connecting to COM port:', assignedPort);
                
                // Ki·ªÉm tra h·ªó tr·ª£ Web Serial API
                const supportInfo = checkSerialSupport();
                if (!supportInfo.supported) {
                    throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial API');
                }
                
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p serial ports
                const port = await navigator.serial.requestPort();
                
                // L·∫•y th√¥ng tin port (kh√¥ng c·∫ßn ki·ªÉm tra kh·ªõp v·ªõi assigned port)
                const portInfo = port.getInfo();
                console.log('Connected to port:', portInfo);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                hasSerialAccess = true;
                const requestBtn = document.getElementById('requestSerialBtn');
                const scanBtn = document.getElementById('scanPortsBtn');
                
                if (requestBtn) {
                    requestBtn.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi COM';
                    requestBtn.style.background = '#4caf50';
                }
                
                if (scanBtn) {
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'üîç Qu√©t COM Ports';
                }
                
                // C·∫≠p nh·∫≠t COM status
                const comStatus = document.getElementById('comStatus');
                if (comStatus) {
                    comStatus.textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi ${assignedPort}`;
                    comStatus.style.color = '#28a745';
                }
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showMessage('success', `‚úÖ ƒê√£ t·ª± ƒë·ªông k·∫øt n·ªëi COM port ${assignedPort}!`);
                
                // Test c√°c c·∫•u h√¨nh COM port kh√°c nhau
                await testComPortConfigurations(port, assignedPort);
                
                console.log('Auto connect successful:', portInfo);
                return port;
                
            } catch (error) {
                console.error('Auto connect failed:', error);
                
                let errorMsg = 'L·ªói t·ª± ƒë·ªông k·∫øt n·ªëi: ' + error.message;
                
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p. Vui l√≤ng th·ª≠ l·∫°i v√† ch·ªçn "Cho ph√©p".';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = `Kh√¥ng t√¨m th·∫•y COM port ${assignedPort}. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi thi·∫øt b·ªã.`;
                }
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i l·ªói
                const comStatus = document.getElementById('comStatus');
                if (comStatus) {
                    comStatus.textContent = `‚ùå L·ªói k·∫øt n·ªëi ${assignedPort}`;
                    comStatus.style.color = '#dc3545';
                }
                
                throw new Error(errorMsg);
            }
        }
        
        // B·∫Øt ƒë·∫ßu l·∫Øng nghe input t·ª´ COM port
        async function startListeningToComPort(port, comPort) {
            try {
                console.log(`üîå Attempting to open COM port: ${comPort}`);
                
                // M·ªü port v·ªõi c·∫•u h√¨nh c∆° b·∫£n
                await port.open({ 
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                
                console.log(`‚úÖ COM port ${comPort} opened successfully`);
                console.log(`üîå Started listening to COM port: ${comPort}`);
                
                // L·∫•y reader ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu
                const reader = port.readable.getReader();
                console.log(`üìñ Reader created for ${comPort}`);
                
                // L·∫Øng nghe d·ªØ li·ªáu li√™n t·ª•c
                while (true) {
                    try {
                        console.log(`‚è≥ Waiting for data from ${comPort}...`);
                        const { value, done } = await reader.read();
                        
                        if (done) {
                            console.log('üì± COM port reader closed');
                            break;
                        }
                        
                        console.log(`üì¶ Raw data received from ${comPort}:`, value);
                        
                        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh string
                        const inputData = new TextDecoder().decode(value);
                        console.log(`üìù Decoded data from ${comPort}:`, inputData);
                        
                        if (inputData.trim()) {
                            console.log(`üì± Received from ${comPort}:`, inputData);
                            
                            // G·ª≠i input l√™n server ƒë·ªÉ in log
                            await sendComInputToServer(comPort, inputData);
                        } else {
                            console.log(`‚ö†Ô∏è Empty data received from ${comPort}`);
                        }
                        
                    } catch (readError) {
                        console.error('‚ùå Error reading from COM port:', readError);
                        break;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error starting COM port listener:', error);
                console.error('Error details:', error.message);
            }
        }
        
        // G·ª≠i input t·ª´ COM port l√™n server
        async function sendComInputToServer(comPort, inputData) {
            try {
                // L·∫•y th√¥ng tin user t·ª´ sessionStorage
                const assignedComPort = sessionStorage.getItem('assignedComPort');
                const username = getCurrentUsername(); // C·∫ßn implement function n√†y
                
                const response = await fetch('/api/com-input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: username || 'Unknown',
                        comPort: comPort,
                        inputData: inputData.trim(),
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Input logged to server successfully');
                } else {
                    console.error('‚ùå Failed to log input to server:', result.message);
                }
                
            } catch (error) {
                console.error('‚ùå Error sending COM input to server:', error);
            }
        }
        
        // L·∫•y username hi·ªán t·∫°i
        function getCurrentUsername() {
            try {
                // Th·ª≠ l·∫•y t·ª´ sessionStorage
                const token = sessionStorage.getItem('auth_token') || sessionStorage.getItem('checkerAuthToken');
                if (token) {
                    // Decode JWT token ƒë·ªÉ l·∫•y username
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.username;
                }
                return null;
            } catch (error) {
                console.error('Error getting username:', error);
                return null;
            }
        }
        
        // Test COM port v·ªõi c√°c c·∫•u h√¨nh kh√°c nhau
        async function testComPortConfigurations(port, comPort) {
            const configurations = [
                { baudRate: 9600, dataBits: 8, stopBits: 1, parity: 'none', name: 'Standard' },
                { baudRate: 115200, dataBits: 8, stopBits: 1, parity: 'none', name: 'High Speed' },
                { baudRate: 4800, dataBits: 8, stopBits: 1, parity: 'none', name: 'Low Speed' },
                { baudRate: 9600, dataBits: 7, stopBits: 1, parity: 'even', name: '7-bit Even' },
                { baudRate: 9600, dataBits: 8, stopBits: 2, parity: 'none', name: '2 Stop Bits' }
            ];
            
            for (const config of configurations) {
                try {
                    console.log(`üß™ Testing ${config.name} configuration...`);
                    
                    // ƒê√≥ng port tr∆∞·ªõc khi th·ª≠ c·∫•u h√¨nh m·ªõi
                    if (port.readable) {
                        await port.close();
                        console.log(`üîí Port ${comPort} closed`);
                    }
                    
                    // M·ªü port v·ªõi c·∫•u h√¨nh m·ªõi
                    await port.open(config);
                    console.log(`‚úÖ Port ${comPort} opened with ${config.name} config`);
                    
                    // Test ƒë·ªçc d·ªØ li·ªáu trong 5 gi√¢y
                    const reader = port.readable.getReader();
                    const timeout = setTimeout(() => {
                        reader.cancel();
                    }, 5000);
                    
                    try {
                        const { value, done } = await reader.read();
                        clearTimeout(timeout);
                        
                        if (!done && value && value.length > 0) {
                            const inputData = new TextDecoder().decode(value);
                            console.log(`üéâ SUCCESS with ${config.name}:`, inputData);
                            
                            // G·ª≠i l√™n server
                            await sendComInputToServer(comPort, inputData);
                            
                            // B·∫Øt ƒë·∫ßu listening v·ªõi c·∫•u h√¨nh n√†y
                            startListeningToComPort(port, comPort);
                            return;
                        }
                    } catch (readError) {
                        clearTimeout(timeout);
                        console.log(`‚ùå ${config.name} failed:`, readError.message);
                    }
                    
                } catch (error) {
                    console.log(`‚ùå ${config.name} configuration failed:`, error.message);
                }
            }
            
            console.log('‚ùå All configurations failed. Please check device connection.');
        }
        
        // Load COM ports v√†o dropdown
        async function loadComPorts() {
            try {
                const select = document.getElementById('comPortSelect');
                const comPortInfo = document.getElementById('comPortInfo');
                
                // Clear existing options
                select.innerHTML = '<option value="">-- Ch·ªçn c·ªïng COM --</option>';
                
                // L·∫•y danh s√°ch COM ports t·ª´ server
                const response = await fetch('/api/admin/all-com-ports', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data.ports) {
                        result.data.ports.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port.path;
                            option.textContent = `${port.path} - ${port.assignedToUser || 'Available'}`;
                            select.appendChild(option);
                        });
                        
                        comPortInfo.textContent = `T√¨m th·∫•y ${result.data.ports.length} COM ports`;
                    } else {
                        comPortInfo.textContent = 'Kh√¥ng t√¨m th·∫•y COM ports';
                    }
                } else {
                    // Fallback: s·ª≠ d·ª•ng assigned COM port
                    if (assignedComPort) {
                        const option = document.createElement('option');
                        option.value = assignedComPort;
                        option.textContent = `${assignedComPort} - ƒê√£ ph√¢n quy·ªÅn`;
                        select.appendChild(option);
                        select.value = assignedComPort;
                        comPortInfo.textContent = `COM port ƒë√£ ph√¢n quy·ªÅn: ${assignedComPort}`;
                    } else {
                        comPortInfo.textContent = 'Ch∆∞a c√≥ COM port ƒë∆∞·ª£c ph√¢n quy·ªÅn';
                    }
                }
                
                // Enable connect button if port selected
                select.addEventListener('change', function() {
                    const connectBtn = document.getElementById('connectComBtn');
                    connectBtn.disabled = !this.value;
                });
                
            } catch (error) {
                console.error('Error loading COM ports:', error);
                showMessage('error', 'L·ªói t·∫£i danh s√°ch COM ports: ' + error.message);
            }
        }
        
        // K·∫øt n·ªëi ƒë·∫øn COM port ƒë√£ ch·ªçn
        async function connectToSelectedPort() {
            try {
                const selectedPort = document.getElementById('comPortSelect').value;
                if (!selectedPort) {
                    showMessage('error', 'Vui l√≤ng ch·ªçn c·ªïng COM!');
                    return;
                }
                
                console.log('üîå Connecting to COM port:', selectedPort);
                
                // Ki·ªÉm tra h·ªó tr·ª£ Web Serial API
                const supportInfo = checkSerialSupport();
                if (!supportInfo.supported) {
                    throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Serial API');
                }
                
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p serial ports
                const port = await navigator.serial.requestPort();
                currentPort = port;
                
                // M·ªü port v·ªõi c·∫•u h√¨nh c∆° b·∫£n
                await port.open({ 
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                
                console.log('‚úÖ COM port opened successfully');
                
                // C·∫≠p nh·∫≠t UI
                updateConnectionStatus(true, selectedPort);
                
                // B·∫Øt ƒë·∫ßu listening
                startListeningToComPort(port, selectedPort);
                
                showMessage('success', `‚úÖ ƒê√£ k·∫øt n·ªëi COM port ${selectedPort}!`);
                
            } catch (error) {
                console.error('‚ùå Error connecting to COM port:', error);
                
                let errorMsg = 'L·ªói k·∫øt n·ªëi COM port: ' + error.message;
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p. Vui l√≤ng th·ª≠ l·∫°i v√† ch·ªçn "Cho ph√©p".';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'Kh√¥ng t√¨m th·∫•y COM port. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi thi·∫øt b·ªã.';
                }
                
                showMessage('error', errorMsg);
                updateConnectionStatus(false);
            }
        }
        
        // Ng·∫Øt k·∫øt n·ªëi COM port
        async function disconnectComPort() {
            try {
                if (currentPort && isConnected) {
                    await currentPort.close();
                    console.log('üîå COM port disconnected');
                }
                
                currentPort = null;
                isConnected = false;
                isListening = false;
                
                updateConnectionStatus(false);
                showMessage('info', 'ƒê√£ ng·∫Øt k·∫øt n·ªëi COM port');
                
            } catch (error) {
                console.error('‚ùå Error disconnecting COM port:', error);
                showMessage('error', 'L·ªói ng·∫Øt k·∫øt n·ªëi: ' + error.message);
            }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
        function updateConnectionStatus(connected, portName = null) {
            const comStatus = document.getElementById('comStatus');
            const inputStatus = document.getElementById('inputStatus');
            const connectBtn = document.getElementById('connectComBtn');
            const disconnectBtn = document.getElementById('disconnectComBtn');
            const select = document.getElementById('comPortSelect');
            
            isConnected = connected;
            
            if (connected) {
                comStatus.textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi ${portName}`;
                comStatus.style.color = '#28a745';
                inputStatus.textContent = 'ƒêang l·∫Øng nghe d·ªØ li·ªáu t·ª´ m√°y qu√©t...';
                inputStatus.style.color = '#17a2b8';
                
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                select.disabled = true;
            } else {
                comStatus.textContent = 'Ch∆∞a k·∫øt n·ªëi COM port';
                comStatus.style.color = '#dc3545';
                inputStatus.textContent = 'Ch·ªù d·ªØ li·ªáu t·ª´ m√°y qu√©t...';
                inputStatus.style.color = '#6c757d';
                
                connectBtn.disabled = !select.value;
                disconnectBtn.disabled = true;
                select.disabled = false;
            }
        }
        
        // B·∫Øt ƒë·∫ßu l·∫Øng nghe input t·ª´ COM port
        async function startListeningToComPort(port, comPort) {
            try {
                console.log(`üîå Started listening to COM port: ${comPort}`);
                
                // L·∫•y reader ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu
                const reader = port.readable.getReader();
                isListening = true;
                
                // L·∫Øng nghe d·ªØ li·ªáu li√™n t·ª•c
                while (isListening) {
                    try {
                        const { value, done } = await reader.read();
                        
                        if (done) {
                            console.log('üì± COM port reader closed');
                            break;
                        }
                        
                        // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu th√†nh string
                        const inputData = new TextDecoder().decode(value);
                        
                        if (inputData.trim()) {
                            console.log(`üì± Received from ${comPort}:`, inputData);
                            
                            // Hi·ªÉn th·ªã d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
                            displayReceivedData(inputData.trim());
                            
                            // G·ª≠i input l√™n server ƒë·ªÉ in log
                            await sendComInputToServer(comPort, inputData);
                        }
                        
                    } catch (readError) {
                        console.error('Error reading from COM port:', readError);
                        break;
                    }
                }
                
            } catch (error) {
                console.error('Error starting COM port listener:', error);
                showMessage('error', 'L·ªói l·∫Øng nghe COM port: ' + error.message);
            }
        }
        
        // Hi·ªÉn th·ªã d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c
        function displayReceivedData(data) {
            const inputDisplay = document.getElementById('inputDisplay');
            const receivedData = document.getElementById('receivedData');
            const inputStatus = document.getElementById('inputStatus');
            
            // Hi·ªÉn th·ªã input display
            inputDisplay.style.display = 'block';
            
            // Th√™m d·ªØ li·ªáu m·ªõi
            const timestamp = new Date().toLocaleTimeString();
            const newData = `[${timestamp}] ${data}`;
            
            if (receivedData.textContent) {
                receivedData.textContent += '\n' + newData;
            } else {
                receivedData.textContent = newData;
            }
            
            // Scroll to bottom
            receivedData.scrollTop = receivedData.scrollHeight;
            
            // C·∫≠p nh·∫≠t status
            inputStatus.textContent = `Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu l√∫c ${timestamp}`;
            inputStatus.style.color = '#28a745';
            
            // Auto scroll to bottom
            receivedData.scrollTop = receivedData.scrollHeight;
        }
        
        // Copy d·ªØ li·ªáu v√†o clipboard
        function copyToClipboard() {
            const receivedData = document.getElementById('receivedData');
            const text = receivedData.textContent;
            
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('success', '‚úÖ ƒê√£ copy d·ªØ li·ªáu v√†o clipboard!');
                }).catch(err => {
                    console.error('Copy failed:', err);
                    showMessage('error', 'L·ªói copy d·ªØ li·ªáu');
                });
            } else {
                showMessage('warning', 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ copy');
            }
        }
        
        // Clear d·ªØ li·ªáu
        function clearInput() {
            const receivedData = document.getElementById('receivedData');
            const inputDisplay = document.getElementById('inputDisplay');
            
            receivedData.textContent = '';
            inputDisplay.style.display = 'none';
            
            const inputStatus = document.getElementById('inputStatus');
            inputStatus.textContent = 'Ch·ªù d·ªØ li·ªáu t·ª´ m√°y qu√©t...';
            inputStatus.style.color = '#6c757d';
            
            showMessage('info', 'ƒê√£ x√≥a d·ªØ li·ªáu');
        }
        
        // Test g·ª≠i input gi·∫£ l√™n server
        async function testComInput() {
            try {
                const selectedPort = document.getElementById('comPortSelect').value;
                const username = getCurrentUsername();
                
                if (!selectedPort) {
                    showMessage('error', 'Vui l√≤ng ch·ªçn c·ªïng COM tr∆∞·ªõc!');
                    return;
                }
                
                console.log('üß™ Testing COM input to server...');
                
                // Test data
                const testData = [
                    '1234567890',
                    'ABC123DEF456',
                    'QR_CODE_TEST_DATA',
                    '9876543210'
                ];
                
                for (let i = 0; i < testData.length; i++) {
                    const inputData = testData[i];
                    
                    console.log(`üì§ Sending test data ${i + 1}: ${inputData}`);
                    
                    // Hi·ªÉn th·ªã d·ªØ li·ªáu test
                    displayReceivedData(`[TEST] ${inputData}`);
                    
                    const response = await fetch('/api/com-input', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: username || 'test_user',
                            comPort: selectedPort,
                            inputData: inputData,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log(`‚úÖ Test data ${i + 1} sent successfully`);
                    } else {
                        console.error(`‚ùå Test data ${i + 1} failed:`, result.message);
                    }
                    
                    // Wait 1 second between tests
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                console.log('üéâ COM input test completed! Check server console for logs.');
                showMessage('success', 'üéâ COM input test completed! Check server console for logs.');
                
            } catch (error) {
                console.error('‚ùå Error testing COM input:', error);
                showMessage('error', '‚ùå Error testing COM input: ' + error.message);
            }
        }
        
        // H√†m hi·ªÉn th·ªã animation ƒëƒÉng nh·∫≠p th√†nh c√¥ng
        function showLoginSuccessAnimation(callback) {
            const overlay = document.getElementById('loginSuccessOverlay');
            overlay.classList.add('show');
            
            // Ch·ªù animation ho√†n th√†nh r·ªìi chuy·ªÉn h∆∞·ªõng
            setTimeout(() => {
                if (callback) callback();
            }, 1800); // 1.8 gi√¢y ƒë·ªÉ animation ho√†n th√†nh
        }
        
        // LOGIN FORM - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG C≈®
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = '';
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await res.json();
                
                if (result.success) {
                    const role = result.role;
                    const assignedComPort = result.assignedComPort;
                    const allowedPorts = result.allowedPorts || [];
                    
                    // L∆∞u token v√†o sessionStorage => phi√™n theo tab, kh√¥ng chia s·∫ª sang tab kh√°c
                    if (result.token) {
                        try { 
                            sessionStorage.setItem('auth_token', result.token);
                            // Checker/packer UI expects checkerAuthToken key
                            if (role === 'checker' || role === 'packer' || role === 'warehouse_manager' || role === 'warehouse_staff') sessionStorage.setItem('checkerAuthToken', result.token);
                        } catch {}
                    }
                    
                    // L∆∞u th√¥ng tin COM port v√†o sessionStorage
                    if (assignedComPort) {
                        try {
                            sessionStorage.setItem('assignedComPort', assignedComPort);
                            sessionStorage.setItem('allowedPorts', JSON.stringify(allowedPorts));
                            console.log('Assigned COM Port:', assignedComPort);
                            console.log('Allowed Ports:', allowedPorts);
                        } catch (e) {
                            console.error('Error saving COM port info:', e);
                        }
                    }
                    
                    // Kh√¥ng hi·ªÉn th·ªã COM port section ·ªü trang login n·ªØa
                    // COM port s·∫Ω ƒë∆∞·ª£c qu·∫£n l√Ω ·ªü trang checker-home
                    
                    // C·∫£ checker v√† packer ƒë·ªÅu v√†o trang m·ªôt m√†n h√¨nh (checker-home)
                    if (role === 'packer' || role === 'checker') {
                        // Wait until server recognizes the session (cookie set) before navigating.
                        // Some browsers may delay applying Set-Cookie from a fetch; poll /api/me until server returns success.
                        const maxAttempts = 10;
                        const delay = ms => new Promise(r => setTimeout(r, ms));
                        for (let i = 0; i < maxAttempts; i++) {
                            try {
                                // Include Authorization header if token is present in sessionStorage
                                const token = (() => { try { return sessionStorage.getItem('auth_token') || sessionStorage.getItem('checkerAuthToken'); } catch (e) { return null; } })();
                                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                                const check = await fetch('/api/me', { credentials: 'include', headers });
                                const chk = await check.json();
                                if (chk && chk.success) {
                                    showLoginSuccessAnimation(() => {
                                        window.location.href = '/checker-home';
                                    });
                                    return;
                                }
                            } catch (e) {}
                            // small backoff
                            await delay(100);
                        }
                        // fallback: navigate anyway (server also accepts JWT for checker-home if provided)
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/checker-home';
                        });
                        return;
                    }
                    // C√°c role kh√°c: d√πng redirect n·∫øu server cung c·∫•p
                    if (result.redirect) {
                        // Use a small delay to ensure cookie has been set in browser when credentials: 'include' is used
                        showLoginSuccessAnimation(() => {
                            window.location.href = result.redirect;
                        });
                        return;
                    }
                    // Fallback theo role
                    if (role === 'admin') {
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/admin';
                        });
                    } else if (role === 'packer') {
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/dashboard';
                        });
                    } else if (role === 'warehouse_manager') {
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/warehouse-manager';
                        });
                    } else if (role === 'warehouse_staff') {
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/warehouse-staff';
                        });
                    } else {
                        showLoginSuccessAnimation(() => {
                            window.location.href = '/';
                        });
                    }
                } else {
                    errorMsg.textContent = result.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
                }
            } catch (err) {
                errorMsg.textContent = 'L·ªói h·ªá th·ªëng';
            }
        });
        
        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            initSerialSupport();
            checkAssignedComPort();
            
            // Load COM ports n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
            const token = sessionStorage.getItem('auth_token') || sessionStorage.getItem('checkerAuthToken');
            if (token) {
                loadComPorts();
            }
        });
        
        // Ki·ªÉm tra COM port ƒë√£ ƒë∆∞·ª£c ph√¢n quy·ªÅn
        function checkAssignedComPort() {
            try {
                const assignedComPort = sessionStorage.getItem('assignedComPort');
                const allowedPorts = JSON.parse(sessionStorage.getItem('allowedPorts') || '[]');
                
                if (assignedComPort) {
                    console.log('Found assigned COM port:', assignedComPort);
                    console.log('Allowed ports:', allowedPorts);
                    
                    // C·∫≠p nh·∫≠t giao di·ªán ƒë·ªÉ hi·ªÉn th·ªã COM port ƒë√£ ƒë∆∞·ª£c ph√¢n quy·ªÅn
                    const comStatus = document.getElementById('comStatus');
                    if (comStatus) {
                        comStatus.textContent = `‚úÖ COM port ƒë√£ ph√¢n quy·ªÅn: ${assignedComPort}`;
                        comStatus.style.color = '#28a745';
                    }
                    
                    // C·∫≠p nh·∫≠t n√∫t request
                    const requestBtn = document.getElementById('requestSerialBtn');
                    if (requestBtn) {
                        requestBtn.textContent = '‚úÖ ƒê√£ c√≥ COM port';
                        requestBtn.style.background = '#4caf50';
                        requestBtn.disabled = true;
                    }
                    
                    // Enable scan button
                    const scanBtn = document.getElementById('scanPortsBtn');
                    if (scanBtn) {
                        scanBtn.disabled = false;
                        scanBtn.textContent = 'üîç K·∫øt n·ªëi COM Port';
                    }
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o
                    showMessage('success', `‚úÖ B·∫°n ƒë√£ ƒë∆∞·ª£c ph√¢n quy·ªÅn s·ª≠ d·ª•ng COM port: ${assignedComPort}`);
                }
            } catch (error) {
                console.error('Error checking assigned COM port:', error);
            }
        }

        // Function to toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'üëÅÔ∏è';
            }
        }
    </script>
</body>
</html>
