<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check ƒê∆°n H√†ng - Order Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .search-section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .search-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1.1rem;
            min-width: 300px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .orders-section {
            display: none;
        }

        .orders-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.1rem;
            font-weight: 700;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            font-size: 1.25rem;
        }

        .order-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .order-card.verified {
            border-color: #28a745;
            background: #f8fff9;
        }

        .order-card.verified::before {
            content: "Ho√†n th√†nh";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        .order-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        .order-info {
            margin-bottom: 10px;
            font-size: 1.18rem;
        }

        .order-info strong {
            color: #667eea;
        }

        .verify-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .scan-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .scan-input {
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
            text-align: center;
            font-weight: bold;
        }

        .scan-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }

        .scan-btn {
            padding: 12px 20px;
            font-size: 1rem;
            border-radius: 8px;
            min-width: 120px;
        }

        .scan-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .scan-status.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .scan-status.progress {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .scan-status.completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .global-scan-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        .global-scan-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .global-scan-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .global-scan-input {
            padding: 15px 20px;
            border: 3px solid #667eea;
            border-radius: 10px;
            font-size: 1.1rem;
            min-width: 250px;
            text-align: center;
            font-weight: bold;
            background: white;
        }

        .global-scan-input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
        }

        .global-scan-btn {
            padding: 15px 25px;
            font-size: 1.1rem;
            border-radius: 10px;
            min-width: 120px;
        }

        .scan-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover {
            background: #5a6fd8;
            color: white;
        }

        .scan-instructions {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .scan-instructions p {
            margin: 0;
            color: #1565c0;
            font-size: 0.9rem;
        }

        .scanner-mode .global-scan-input {
            border-color: #4caf50;
            background: #f1f8e9;
        }

        .scanner-mode .global-scan-input:focus {
            border-color: #2e7d32;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
        }

        .test-codes {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .test-codes h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1rem;
        }

        .test-codes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .test-code-item {
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 0.85rem;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .test-code-item:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .orders-table-container {
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .orders-table-container h3 {
            background: #667eea;
            color: white;
            margin: 0;
            padding: 15px 20px;
            font-size: 1.2rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .orders-table th {
            background: #f8f9fa;
            color: #495057;
            font-weight: bold;
            padding: 16px 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
            font-size: 1.18rem;
        }

        .orders-table td {
            padding: 14px 10px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            font-size: 1.15rem;
            font-size: 1.15rem !important;
        }

        .orders-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-completed {
            background: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }

        .status-progress {
            background: #fff3cd !important;
            color: #856404;
            font-weight: bold;
        }

        .status-blocked {
            background: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }

        .status-error {
            background: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }

        .status-pending {
            background: #e2e3e5 !important;
            color: #383d41;
        }

        .quantity-display {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .quantity-required {
            color: #495057;
        }

        .quantity-scanned {
            color: #28a745;
        }

        .quantity-excess {
            color: #dc3545;
        }

        .quantity-insufficient {
            color: #ffc107;
        }

        .scan-input-small {
            width: 120px;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
        }

        .scan-btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-left: 5px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-badge.progress {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-badge.blocked {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge.pending {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 600px;
            width: 95%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            animation: modalSlideIn 0.3s ease-out forwards;
        }

        @keyframes modalSlideIn {
            to {
                transform: scale(1);
            }
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .modal-icon.success {
            color: #22c55e;
        }

        .modal-title {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .modal-message {
            font-size: 1.5rem;
            color: #374151;
            line-height: 1.8;
            margin-bottom: 35px;
            font-weight: 500;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 18px 36px;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .filter-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 12px;
            border: 1px solid #ced4da;
            background: white;
            color: #495057;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn:hover {
            background: #5a6fd8;
            color: white;
        }

        .reset-btn {
            background: #dc3545 !important;
            color: white !important;
            border-color: #dc3545 !important;
        }

        .reset-btn:hover {
            background: #c82333 !important;
            color: white !important;
        }

        .progress-section {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
            font-weight: 600;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .navigation {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 20px;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 0 10px;
        }

        .nav-link:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-field {
                min-width: auto;
            }
            
            .orders-grid {
                grid-template-columns: 1fr;
            }
            
            .verify-inputs {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:right;margin-bottom:10px;">
            <button id="cancelBtn" style="background:#6c757d;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;margin-right:10px;">H·ªßy</button>
            <button id="logoutBtn" style="background:#e83e8c;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="header">
            <h1>Check ƒê∆°n H√†ng</h1>
            <p>Ki·ªÉm tra v√† x√°c nh·∫≠n ƒë∆°n h√†ng theo m√£ v·∫≠n ƒë∆°n</p>
        </div>

        <div class="content">
            <div class="navigation">
                <!-- Nav links ·∫©n v·ªõi checker -->
            </div>

            <div class="search-section">
                <h2>T√¨m ki·∫øm ƒë∆°n h√†ng</h2>
                <div class="input-group">
                    <input type="text" id="maVanDonInput" class="input-field" placeholder="Nh·∫≠p m√£ v·∫≠n ƒë∆°n...">
                    <button class="btn" id="searchBtn" onclick="searchOrders()">
                        T√¨m ki·∫øm
                    </button>
                </div>
                <div style="margin-top:30px;text-align:center;">
                    <form id="uploadForm" enctype="multipart/form-data" style="display:inline-block;">
                        <input type="file" id="xlsxFileInput" name="xlsxFile" accept=".xlsx,.xls" style="padding:10px;">
                        <button type="submit" class="btn" id="uploadBtn">T·∫£i l√™n file Excel</button>
                    </form>
                    <div id="uploadProcessing" style="display:none;margin-top:18px;">
                        <div class="french-loader">
                            <div class="french-spinner"></div>
                            <div class="french-text">
                                <span style="display:inline-block;vertical-align:middle;">
                                    <svg id="svgLoadingIcon" width="48" height="48" viewBox="0 0 48 48" style="vertical-align:middle;">
                                        <circle cx="24" cy="24" r="20" stroke="#667eea" stroke-width="6" fill="none" opacity="0.2"/>
                                        <circle cx="24" cy="24" r="20" stroke="#667eea" stroke-width="6" fill="none" stroke-linecap="round" stroke-dasharray="31.4 94.2" stroke-dashoffset="0">
                                            <animateTransform attributeName="transform" type="rotate" from="0 24 24" to="360 24 24" dur="1s" repeatCount="indefinite"/>
                                        </circle>
                                    </svg>
                                </span>
                                <span style="margin-left:8px;" id="uploadStepText">ƒêang t·∫£i file l√™n...</span>
                            </div>
                            <div style="width:100%;margin-top:18px;position:relative;height:38px;">
                                <div id="uploadProgressBar" style="height:12px;width:100%;background:#e9ecef;border-radius:8px;overflow:hidden;position:absolute;top:18px;left:0;">
                                    <div id="uploadProgressFill" style="height:100%;width:0%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.4s;"></div>
                                </div>
                                <div id="truckIcon" style="position:absolute;top:0;left:0;width:38px;height:38px;pointer-events:none;transition:left 0.4s;">
                                    <svg width="38" height="38" viewBox="0 0 38 38">
                                        <rect x="4" y="16" width="20" height="10" rx="3" fill="#667eea"/>
                                        <rect x="24" y="20" width="8" height="6" rx="2" fill="#764ba2"/>
                                        <circle cx="10" cy="28" r="4" fill="#e9ecef" stroke="#667eea" stroke-width="2"/>
                                        <circle cx="28" cy="28" r="4" fill="#e9ecef" stroke="#764ba2" stroke-width="2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="uploadResultIcon" style="display:none;font-size:2.5rem;margin-top:10px;"></div>
                    <div class="alert alert-success" id="uploadSuccessAlert" style="display:none;"></div>
                    <div class="alert alert-error" id="uploadErrorAlert" style="display:none;"></div>
        /* French loader style */
        .french-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: linear-gradient(135deg, #f8f9ff 60%, #e3e3e3 100%);
            border-radius: 18px;
            box-shadow: 0 6px 24px rgba(102,126,234,0.12);
            padding: 24px 32px;
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            font-size: 1.15rem;
            color: #3a3a3a;
            border: 2px solid #667eea;
            margin-bottom: 10px;
        }
        .french-spinner {
            width: 48px;
            height: 48px;
            border: 6px solid #667eea;
            border-top: 6px solid #f8f9ff;
            border-radius: 50%;
            animation: french-spin 1s linear infinite;
            box-shadow: 0 2px 8px rgba(102,126,234,0.18);
        }
        @keyframes french-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .french-text {
            font-size: 1.18rem;
            font-weight: 500;
            color: #667eea;
            letter-spacing: 0.02em;
            font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
            margin-top: 8px;
        }
                </div>
            </div>

            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <div class="orders-section" id="ordersSection">
                <h2>Danh s√°ch m·∫∑t h√†ng</h2>
                <div class="progress-section" id="progressSection">
                    <h3>Ti·∫øn ƒë·ªô x√°c nh·∫≠n</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">0/0 m·∫∑t h√†ng ƒë√£ x√°c nh·∫≠n</p>
                </div>

                <!-- Danh s√°ch m√£ h√†ng d·∫°ng b·∫£ng -->
                <div class="orders-table-container" id="ordersTableContainer" style="display: none;">
                    <h3>Danh s√°ch m√£ h√†ng trong ƒë∆°n v·∫≠n ƒë∆°n: <span id="tableMaVanDon"></span></h3>
                    
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <span><strong>L·ªçc theo tr·∫°ng th√°i:</strong></span>
                        <button class="filter-btn active" onclick="filterOrders('all')" id="filterAll">T·∫•t c·∫£</button>
                        <button class="filter-btn" onclick="filterOrders('pending')" id="filterPending">Ch·ªù qu√©t</button>
                        <button class="filter-btn" onclick="filterOrders('progress')" id="filterProgress">ƒêang qu√©t</button>
                        <button class="filter-btn" onclick="filterOrders('completed')" id="filterCompleted">Ho√†n th√†nh</button>
                        <button class="filter-btn" onclick="filterOrders('error')" id="filterError">L·ªói</button>
                        <button class="filter-btn reset-btn" onclick="resetScanStatus()" id="resetBtn">Reset Qu√©t</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="orders-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ ƒë√≥ng g√≥i</th>
                                    <th>M√£ v·∫≠n ƒë∆°n</th>
                                    <th>M√£ ƒë∆°n h√†ng</th>
                                    <th>M√£ h√†ng</th>
                                    <th>S·ªë l∆∞·ª£ng y√™u c·∫ßu</th>
                                    <th>ƒê√£ qu√©t</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Status</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="orders-grid" id="ordersGrid">
                    <!-- Danh s√°ch ƒë∆°n h√†ng s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // X·ª≠ l√Ω upload file Excel
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('xlsxFileInput');
            const file = fileInput.files[0];
            const resultIcon = document.getElementById('uploadResultIcon');
            resultIcon.style.display = 'none';
            const stepText = document.getElementById('uploadStepText');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressFill = document.getElementById('uploadProgressFill');
            if (!file) {
                showUploadError('Vui l√≤ng ch·ªçn file Excel (.xlsx, .xls)');
                return;
            }
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProcessing').style.display = 'block';
            hideUploadAlerts();
            stepText.textContent = 'ƒêang t·∫£i file l√™n...';
            progressFill.style.width = '10%';
            try {
                // B∆∞·ªõc 1: Upload file
                progressFill.style.width = '30%';
                stepText.textContent = 'ƒêang g·ª≠i file l√™n server...';
                moveTruck(30);
                const formData = new FormData();
                formData.append('file', file); // S·ª≠a key th√†nh 'file' cho backend checker
                // Th√™m JWT v√†o header n·∫øu c√≥
                let token = sessionStorage.getItem('jwt');
                const response = await fetch('/api/checker/upload', {
                    method: 'POST',
                    body: formData,
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                progressFill.style.width = '60%';
                stepText.textContent = 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...';
                moveTruck(60);
                const result = await response.json();
                progressFill.style.width = '100%';
                stepText.textContent = 'Ho√†n t·∫•t x·ª≠ l√Ω!';
                moveTruck(100);
                setTimeout(() => {
                    document.getElementById('uploadProcessing').style.display = 'none';
                    moveTruck(0);
                }, 800);
                if (result.success) {
                    resultIcon.textContent = '‚úÖ';
                    resultIcon.style.color = '#28a745';
                    resultIcon.style.display = 'block';
                    showUploadSuccess(result.message);
                } else {
                    resultIcon.textContent = '‚ùå';
                    resultIcon.style.color = '#dc3545';
                    resultIcon.style.display = 'block';
                    showUploadError(result.message || 'T·∫£i l√™n th·∫•t b·∫°i');
                }
            } catch (error) {
                document.getElementById('uploadProcessing').style.display = 'none';
                moveTruck(0);
                resultIcon.textContent = '‚ùå';
                resultIcon.style.color = '#dc3545';
                resultIcon.style.display = 'block';
                showUploadError('L·ªói t·∫£i l√™n: ' + error.message);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                progressFill.style.width = '0%';
                stepText.textContent = 'ƒêang t·∫£i file l√™n...';
            }

            // H√†m di chuy·ªÉn xe t·∫£i theo %
            function moveTruck(percent) {
                const truck = document.getElementById('truckIcon');
                const bar = document.getElementById('uploadProgressBar');
                if (!truck || !bar) return;
                const barWidth = bar.offsetWidth;
                const maxLeft = barWidth - truck.offsetWidth;
                const left = Math.max(0, Math.min(maxLeft, Math.round(barWidth * percent / 100)));
                truck.style.left = left + 'px';
            }
        });

        function showUploadSuccess(message) {
            hideUploadAlerts();
            const alert = document.getElementById('uploadSuccessAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideUploadAlerts, 6000);
        }
        function showUploadError(message) {
            hideUploadAlerts();
            const alert = document.getElementById('uploadErrorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideUploadAlerts, 8000);
        }
        function hideUploadAlerts() {
            document.getElementById('uploadSuccessAlert').style.display = 'none';
            document.getElementById('uploadErrorAlert').style.display = 'none';
        }
        // X·ª≠ l√Ω n√∫t H·ªßy - unblock ƒë∆°n h√†ng v√† quay l·∫°i trang tr∆∞·ªõc
        document.getElementById('cancelBtn').onclick = async function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy v√† quay l·∫°i trang tr∆∞·ªõc? T·∫•t c·∫£ ƒë∆°n h√†ng ƒëang ki·ªÉm tra s·∫Ω ƒë∆∞·ª£c m·ªü kh√≥a.')) {
                // Unblock ƒë∆°n h√†ng tr∆∞·ªõc khi r·ªùi kh·ªèi
                await unblockOrders();
                // Quay l·∫°i trang tr∆∞·ªõc ƒë√≥
                goBackToPreviousPage();
            }
        };

        // X·ª≠ l√Ω n√∫t ƒêƒÉng xu·∫•t
        document.getElementById('logoutBtn').onclick = async function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t? T·∫•t c·∫£ ƒë∆°n h√†ng ƒëang ki·ªÉm tra s·∫Ω ƒë∆∞·ª£c m·ªü kh√≥a.')) {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            }
        };
        let currentOrders = [];
        let currentMaVanDon = '';
        let scanMode = 'manual'; // 'manual' ho·∫∑c 'scanner'
        
        // Unblock ƒë∆°n h√†ng khi user r·ªùi kh·ªèi trang
        let blockedOrders = new Set(); // Track c√°c ƒë∆°n h√†ng ƒëang b·ªã block b·ªüi user hi·ªán t·∫°i
        let blockedVanDon = null; // Track ƒë∆°n v·∫≠n ƒë∆°n ƒëang b·ªã block
        
        // L∆∞u trang tr∆∞·ªõc ƒë√≥ ƒë·ªÉ quay l·∫°i
        let previousPage = null;

        // L∆∞u tr·∫°ng th√°i block khi t√¨m ki·∫øm th√†nh c√¥ng
        function trackBlockedVanDon(maVanDon) {
            blockedVanDon = maVanDon;
        }

        // Function ƒë·ªÉ quay l·∫°i trang tr∆∞·ªõc ƒë√≥
        function goBackToPreviousPage() {
            console.log(`üîÑ ƒêang quay l·∫°i trang tr∆∞·ªõc: ${previousPage}`);
            
            if (previousPage && previousPage !== window.location.href) {
                // Ki·ªÉm tra xem trang tr∆∞·ªõc c√≥ ph·∫£i l√† trang h·ª£p l·ªá kh√¥ng
                const validPages = ['/checker-home', '/dashboard', '/admin'];
                const isValidPage = validPages.some(page => previousPage.includes(page));
                
                if (isValidPage) {
                    window.location.href = previousPage;
                } else {
                    // N·∫øu trang tr∆∞·ªõc kh√¥ng h·ª£p l·ªá, quay v·ªÅ trang m·∫∑c ƒë·ªãnh theo role
                    goBackToDefaultPageByRole();
                }
            } else {
                // N·∫øu kh√¥ng c√≥ trang tr∆∞·ªõc ho·∫∑c l√† c√πng trang, quay v·ªÅ trang m·∫∑c ƒë·ªãnh theo role
                goBackToDefaultPageByRole();
            }
        }

        // Function ƒë·ªÉ quay v·ªÅ trang m·∫∑c ƒë·ªãnh theo role
        async function goBackToDefaultPageByRole() {
            try {
                const response = await fetch('/api/me');
                const result = await response.json();
                
                if (result.success) {
                    if (result.role === 'packer') {
                        window.location.href = '/dashboard';
                    } else if (result.role === 'checker') {
                        window.location.href = '/checker-home';
                    } else {
                        window.location.href = '/dashboard'; // admin v√† user kh√°c
                    }
                } else {
                    window.location.href = '/dashboard'; // fallback
                }
            } catch (error) {
                window.location.href = '/dashboard'; // fallback n·∫øu c√≥ l·ªói
            }
        }

        // Function ƒë·ªÉ l∆∞u trang tr∆∞·ªõc ƒë√≥
        function savePreviousPage() {
            // Ki·ªÉm tra sessionStorage tr∆∞·ªõc
            const savedPage = sessionStorage.getItem('previousPage');
            if (savedPage && savedPage !== window.location.pathname) {
                previousPage = savedPage;
                console.log(`üìÑ ƒê√£ l∆∞u trang tr∆∞·ªõc t·ª´ sessionStorage: ${previousPage}`);
                return;
            }
            
            // L∆∞u referrer n·∫øu c√≥
            if (document.referrer && document.referrer !== window.location.href) {
                // L·∫•y path t·ª´ referrer URL
                const referrerUrl = new URL(document.referrer);
                previousPage = referrerUrl.pathname;
                
                // N·∫øu referrer l√† trang ch·ªß ho·∫∑c kh√¥ng h·ª£p l·ªá, m·∫∑c ƒë·ªãnh theo role
                if (previousPage === '/' || previousPage === '/index.html') {
                    // Ki·ªÉm tra role c·ªßa user ƒë·ªÉ quy·∫øt ƒë·ªãnh trang m·∫∑c ƒë·ªãnh
                    getUserRoleAndSetDefaultPage();
                    return;
                }
            } else {
                // N·∫øu kh√¥ng c√≥ referrer, m·∫∑c ƒë·ªãnh theo role
                getUserRoleAndSetDefaultPage();
                return;
            }
            
            // L∆∞u v√†o sessionStorage ƒë·ªÉ s·ª≠ d·ª•ng sau n√†y
            sessionStorage.setItem('previousPage', previousPage);
            console.log(`üìÑ ƒê√£ l∆∞u trang tr∆∞·ªõc: ${previousPage}`);
        }

        // Function ƒë·ªÉ l·∫•y role v√† set trang m·∫∑c ƒë·ªãnh
        async function getUserRoleAndSetDefaultPage() {
            try {
                const response = await fetch('/api/me');
                const result = await response.json();
                
                if (result.success) {
                    if (result.role === 'packer') {
                        previousPage = '/dashboard';
                    } else if (result.role === 'checker') {
                        previousPage = '/checker-home';
                    } else {
                        previousPage = '/dashboard'; // admin v√† user kh√°c
                    }
                } else {
                    previousPage = '/dashboard'; // fallback
                }
            } catch (error) {
                previousPage = '/dashboard'; // fallback n·∫øu c√≥ l·ªói
            }
            
            // L∆∞u v√†o sessionStorage
            sessionStorage.setItem('previousPage', previousPage);
            console.log(`üìÑ ƒê√£ l∆∞u trang tr∆∞·ªõc theo role: ${previousPage}`);
        }

        async function searchOrders() {
            const maVanDon = document.getElementById('maVanDonInput').value.trim();
            
            if (!maVanDon) {
                showError('Vui l√≤ng nh·∫≠p m√£ v·∫≠n ƒë∆°n');
                return;
            }

            // Clear t·∫•t c·∫£ timeout v√† modal c≈© khi t√¨m ki·∫øm m·ªõi
            clearAllTimeouts();
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').textContent = 'üîç ƒêang t√¨m ki·∫øm...';

            try {
                console.log(`üîç ƒêang t√¨m ki·∫øm ƒë∆°n v·∫≠n ƒë∆°n: ${maVanDon}`);
                const response = await fetch(`/api/orders/by-van-don/${maVanDon}`);
                const result = await response.json();
                console.log('üìã K·∫øt qu·∫£ t√¨m ki·∫øm:', result);

                if (result.success) {
                    currentOrders = result.data.orders;
                    currentMaVanDon = maVanDon;
                    trackBlockedVanDon(maVanDon); // Track ƒë∆°n v·∫≠n ƒë∆°n ƒë√£ b·ªã block
                    console.log(`‚úÖ T√¨m th·∫•y ${currentOrders.length} ƒë∆°n h√†ng, ƒë√£ block cho user hi·ªán t·∫°i`);
                    displayOrders(currentOrders);
                    showSuccess(result.message);
                    ensureInputFocus();
                } else {
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p b·ªã block khi t√¨m ki·∫øm
                    if (result.blocked) {
                        console.log(`üö´ ƒê∆°n v·∫≠n ƒë∆°n b·ªã block: ${result.message}`);
                        showError(result.message, 'warning');
                    } else if (result.data && result.data.allCompleted) {
                        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh
                        console.log(`‚úÖ T·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh: ${result.message}`);
                        
                        // ƒê·∫£m b·∫£o kh√¥ng c√≥ modal n√†o kh√°c ƒë∆∞·ª£c hi·ªÉn th·ªã
                        const existingModal = document.querySelector('.modal-overlay');
                        if (existingModal) {
                            existingModal.remove();
                        }
                        
                        // Clear t·∫•t c·∫£ timeout c√≥ th·ªÉ ƒëang ch·∫°y
                        clearAllTimeouts();
                        
                        showSuccess(result.message);
                        ensureInputFocus();
                    ensureInputFocus();
                    } else {
                        console.log(`‚ùå L·ªói t√¨m ki·∫øm: ${result.message}`);
                        showError(result.message);
                ensureInputFocus();
                    ensureInputFocus();
                    }
                    hideOrdersSection();
                }

            } catch (error) {
                showError('L·ªói t√¨m ki·∫øm: ' + error.message);
                ensureInputFocus();
                hideOrdersSection();
            } finally {
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'üîç T√¨m ki·∫øm';
            }
        }

        function displayOrders(orders) {
            console.log(`üì¶ Hi·ªÉn th·ªã ${orders.length} ƒë∆°n h√†ng`);
            const ordersGrid = document.getElementById('ordersGrid');
            if (!ordersGrid) {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y element ordersGrid');
                return;
            }
            ordersGrid.innerHTML = '';

            orders.forEach((order, index) => {
                const orderCard = document.createElement('div');
                orderCard.className = `order-card ${order.verified ? 'verified' : ''}`;
                orderCard.innerHTML = `
                    <h3>M·∫∑t h√†ng ${order.stt}</h3>
                    <div class="order-info">
                        <strong>M√£ ƒë√≥ng g√≥i:</strong> ${order.maDongGoi}
                    </div>
                    <div class="order-info">
                        <strong>M√£ ƒë∆°n h√†ng:</strong> ${order.maDonHang}
                    </div>
                    <div class="order-info">
                        <strong>M√£ h√†ng:</strong> <span class="ma-hang">${order.maHang}</span>
                    </div>
                    <div class="order-info">
                        <strong>S·ªë l∆∞·ª£ng y√™u c·∫ßu:</strong> ${order.soLuong}
                    </div>
                    <div class="order-info">
                        <strong>ƒê√£ qu√©t:</strong> ${order.scannedQuantity || 0}/${order.soLuong}
                    </div>
                    ${order.verified ? `
                        <div class="order-info" style="color: #28a745; font-weight: bold;">
                            Ho√†n th√†nh l√∫c: ${new Date(order.verifiedAt).toLocaleString('vi-VN')}
                        </div>
                    ` : `
                        <div class="verify-section">
                            <div class="scan-inputs">
                                <input type="text" class="scan-input ma-hang-input" placeholder="Qu√©t m√£ h√†ng..." data-order-index="${index}" autocomplete="off">
                                <button class="btn scan-btn" onclick="scanOrder(${index})">Qu√©t</button>
                            </div>
                            <div class="scan-status ${getScanStatusClass(order)}" id="scanStatus${index}">
                                ${getScanStatusText(order)}
                            </div>
                        </div>
                    `}
                `;
                ordersGrid.appendChild(orderCard);
            });

            updateProgress();
            displayOrdersTable();
            document.getElementById('ordersSection').style.display = 'block';
            console.log('‚úÖ ƒê√£ hi·ªÉn th·ªã ordersSection');
        }

        async function scanOrder(orderIndex) {
            const order = currentOrders[orderIndex];
            const maHangInput = document.querySelector(`.ma-hang-input[data-order-index="${orderIndex}"]`);
            const maHangNhap = maHangInput.value.trim();

            if (!maHangNhap) {
                showError('Vui l√≤ng nh·∫≠p m√£ h√†ng ƒë·ªÉ qu√©t');
                return;
            }

            // Ki·ªÉm tra m√£ h√†ng c√≥ ƒë√∫ng kh√¥ng
            if (maHangNhap !== order.maHang) {
                showError(`M√£ h√†ng kh√¥ng ƒë√∫ng! Y√™u c·∫ßu: ${order.maHang}, Nh·∫≠p: ${maHangNhap}`);
                maHangInput.value = '';
                ensureInputFocus();
                return;
            }

            try {
                const response = await fetch('/api/orders/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maVanDon: currentMaVanDon,
                        maHang: maHangNhap
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    ensureInputFocus();
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                    order.scannedQuantity = result.data.soLuongDaQuet;
                    order.verified = result.data.verified;
                    order.verifiedAt = result.data.verifiedAt;
                    
                    // Track blocked order n·∫øu ƒë∆°n h√†ng ch∆∞a ho√†n th√†nh
                    if (!order.verified) {
                        trackBlockedOrder(currentMaVanDon, order.maHang);
                    }
                    
                    // Hi·ªÉn th·ªã l·∫°i danh s√°ch
                    displayOrders(currentOrders);
                    displayOrdersTable();
                    
                    // X√≥a input v√† focus l·∫°i
                    maHangInput.value = '';
                    ensureInputFocus();
                    
                    // X√≥a global scan input n·∫øu ƒëang s·ª≠ d·ª•ng
                    document.getElementById('globalScanInput').value = '';
                    
                    // N·∫øu ho√†n th√†nh
                    if (result.data.progress.isCompleted) {
                        setTimeoutWrapper(() => {
                            showVanDonConfirmDialog();
                        }, 1000);
                    }
                } else {
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p b·ªã block
                    if (result.blocked) {
                        showError(result.message, 'warning');
                    } else {
                        showError(result.message);
                ensureInputFocus();
                    ensureInputFocus();
                    }
                    maHangInput.value = '';
                    ensureInputFocus();
                }

            } catch (error) {
                showError('L·ªói qu√©t m√£: ' + error.message);
                ensureInputFocus();
                maHangInput.value = '';
                ensureInputFocus();
            }
        }

        function getScanStatusClass(order) {
            if (order.verified) return 'completed';
            if (order.block && order.checkingBy) return 'blocked';
            if (order.scannedQuantity > 0) return 'progress';
            return 'pending';
        }

        function getScanStatusText(order) {
            if (order.verified) return 'Ho√†n th√†nh';
            if (order.block && order.checkingBy) return `ƒêang qu√©t b·ªüi ${order.checkingBy}`;
            if (order.scannedQuantity > 0) return `ƒê√£ qu√©t ${order.scannedQuantity}/${order.soLuong}`;
            return 'Ch·ªù qu√©t';
        }

        function switchScanMode(mode) {
            scanMode = mode;
            
            // C·∫≠p nh·∫≠t tabs
            document.getElementById('manualTab').classList.toggle('active', mode === 'manual');
            document.getElementById('scannerTab').classList.toggle('active', mode === 'scanner');
            
            // C·∫≠p nh·∫≠t container class
            const container = document.querySelector('.global-scan-section');
            container.classList.toggle('scanner-mode', mode === 'scanner');
            
            // C·∫≠p nh·∫≠t placeholder v√† instructions
            const input = document.getElementById('globalScanInput');
            const instructions = document.getElementById('scanInstructions');
            
            if (mode === 'manual') {
                input.placeholder = 'Nh·∫≠p m√£ h√†ng ƒë·ªÉ test...';
                instructions.innerHTML = '<p><strong>H∆∞·ªõng d·∫´n:</strong> Nh·∫≠p m√£ h√†ng b·∫•t k·ª≥ t·ª´ danh s√°ch b√™n d∆∞·ªõi ƒë·ªÉ test ch·ª©c nƒÉng</p>';
                document.getElementById('testCodes').style.display = 'block';
            } else {
                input.placeholder = 'Qu√©t m√£ h√†ng b·∫±ng m√°y qu√©t...';
                instructions.innerHTML = '<p><strong>Ch·∫ø ƒë·ªô m√°y qu√©t:</strong> S·ª≠ d·ª•ng m√°y qu√©t ƒë·ªÉ qu√©t m√£ h√†ng, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông nh·∫≠n di·ªán v√† x·ª≠ l√Ω</p>';
                document.getElementById('testCodes').style.display = 'none';
            }
            
            // Focus v√†o input
            ensureInputFocus();
        }

        async function globalScan() {
            const maHangNhap = document.getElementById('globalScanInput').value.trim();

            if (!maHangNhap) {
                const message = scanMode === 'manual' ? 'Vui l√≤ng nh·∫≠p m√£ h√†ng ƒë·ªÉ test' : 'Vui l√≤ng qu√©t m√£ h√†ng';
                showError(message);
                return;
            }

            // T√¨m ƒë∆°n h√†ng c√≥ m√£ h√†ng n√†y
            const orderIndex = currentOrders.findIndex(order => order.maHang === maHangNhap);

            if (orderIndex === -1) {
                const message = scanMode === 'manual' ? 
                    `Kh√¥ng t√¨m th·∫•y m√£ h√†ng "${maHangNhap}" trong ƒë∆°n v·∫≠n ƒë∆°n n√†y. Vui l√≤ng ki·ªÉm tra l·∫°i danh s√°ch b√™n d∆∞·ªõi.` :
                    `M√£ h√†ng "${maHangNhap}" kh√¥ng c√≥ trong ƒë∆°n v·∫≠n ƒë∆°n n√†y. Vui l√≤ng qu√©t l·∫°i.`;
                showError(message);
                document.getElementById('globalScanInput').value = '';
                ensureInputFocus();
                return;
            }

            // G·ªçi h√†m scanOrder v·ªõi index t√¨m ƒë∆∞·ª£c
            await scanOrder(orderIndex);
            
            // X√≥a global scan input sau khi qu√©t
            document.getElementById('globalScanInput').value = '';
            document.getElementById('globalScanInput').focus();
        }

        function updateProgress() {
            const verifiedCount = currentOrders.filter(order => order.verified).length;
            const totalCount = currentOrders.length;
            const percentage = totalCount > 0 ? (verifiedCount / totalCount) * 100 : 0;

            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = 
                `${verifiedCount}/${totalCount} m·∫∑t h√†ng ƒë√£ x√°c nh·∫≠n (${percentage.toFixed(1)}%)`;
        }

        function updateTestCodes() {
            const testCodesList = document.getElementById('testCodesList');
            testCodesList.innerHTML = '';
            
            // L·∫•y 10 m√£ h√†ng ƒë·∫ßu ti√™n ƒë·ªÉ test
            const testOrders = currentOrders.slice(0, 10);
            
            testOrders.forEach(order => {
                const codeItem = document.createElement('div');
                codeItem.className = 'test-code-item';
                codeItem.textContent = order.maHang;
                codeItem.onclick = () => {
                    document.getElementById('globalScanInput').value = order.maHang;
                    globalScan();
                };
                testCodesList.appendChild(codeItem);
            });
        }

        function displayOrdersTable(filter = 'all') {
            const tableBody = document.getElementById('ordersTableBody');
            const tableContainer = document.getElementById('ordersTableContainer');
            const tableMaVanDon = document.getElementById('tableMaVanDon');
            
            tableBody.innerHTML = '';
            tableMaVanDon.textContent = currentMaVanDon;
            
            // L·ªçc ƒë∆°n h√†ng theo filter
            let filteredOrders = currentOrders;
            if (filter !== 'all') {
                filteredOrders = currentOrders.filter(order => {
                    const scannedQuantity = order.scannedQuantity || 0;
                    const requiredQuantity = order.soLuong;
                    
                    if (filter === 'completed') return order.verified;
                    if (filter === 'progress') return !order.verified && scannedQuantity > 0 && scannedQuantity <= requiredQuantity;
                    if (filter === 'error') return !order.verified && scannedQuantity > requiredQuantity;
                    if (filter === 'pending') return !order.verified && scannedQuantity === 0;
                    return true;
                });
            }
            
            filteredOrders.forEach((order, index) => {
                const row = document.createElement('tr');
                
                // X√°c ƒë·ªãnh tr·∫°ng th√°i v√† m√†u s·∫Øc
                const scannedQuantity = order.scannedQuantity || 0;
                const requiredQuantity = order.soLuong;
                let statusClass = '';
                let statusText = '';
                let quantityClass = '';
                let statusBadgeClass = '';
                let statusBadgeText = '';
                
                if (order.verified) {
                    statusClass = 'status-completed';
                    statusText = 'Ho√†n th√†nh';
                    quantityClass = 'quantity-scanned';
                    statusBadgeClass = 'completed';
                    statusBadgeText = 'DONE';
                } else if (order.block && order.checkingBy) {
                    statusClass = 'status-blocked';
                    statusText = `ƒêang qu√©t b·ªüi ${order.checkingBy}`;
                    quantityClass = 'quantity-insufficient';
                    statusBadgeClass = 'blocked';
                    statusBadgeText = 'BLOCK';
                } else if (scannedQuantity > requiredQuantity) {
                    statusClass = 'status-error';
                    statusText = 'Th·ª´a h√†ng';
                    quantityClass = 'quantity-excess';
                    statusBadgeClass = 'error';
                    statusBadgeText = 'ERROR';
                } else if (scannedQuantity > 0) {
                    statusClass = 'status-progress';
                    statusText = `ƒêang qu√©t (${scannedQuantity}/${requiredQuantity})`;
                    quantityClass = 'quantity-insufficient';
                    statusBadgeClass = 'progress';
                    statusBadgeText = 'SCAN';
                } else {
                    statusClass = 'status-pending';
                    statusText = 'Ch·ªù qu√©t';
                    quantityClass = 'quantity-required';
                    statusBadgeClass = 'pending';
                    statusBadgeText = 'WAIT';
                }
                
                row.className = statusClass;
                row.innerHTML = `
                    <td>${order.stt}</td>
                    <td>${order.maDongGoi}</td>
                    <td>${order.maVanDon}</td>
                    <td>${order.maDonHang}</td>
                    <td><strong>${order.maHang}</strong></td>
                    <td class="quantity-display quantity-required">${requiredQuantity}</td>
                    <td class="quantity-display ${quantityClass}">${scannedQuantity}</td>
                    <td>${statusText}</td>
                    <td><span class="status-badge ${statusBadgeClass}">${statusBadgeText}</span></td>
                    <td>
                        ${!order.verified ? `
                            <input type="text" class="scan-input-small" id="tableScanInput${index}" placeholder="Qu√©t m√£..." data-order-index="${index}">
                            <button class="btn scan-btn-small" onclick="scanOrderFromTable(${index})">Qu√©t</button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            tableContainer.style.display = 'block';
        }

        function filterOrders(filter) {
            // C·∫≠p nh·∫≠t active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            
            // Hi·ªÉn th·ªã l·∫°i b·∫£ng v·ªõi filter
            displayOrdersTable(filter);
        }

        async function resetScanStatus() {
            if (!currentMaVanDon) {
                showError('Vui l√≤ng t√¨m ƒë∆°n h√†ng tr∆∞·ªõc.');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset tr·∫°ng th√°i qu√©t cho ƒë∆°n v·∫≠n ƒë∆°n ${currentMaVanDon}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/reset-scan/${currentMaVanDon}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    ensureInputFocus();
                    
                    // C·∫≠p nh·∫≠t l·∫°i danh s√°ch
                    await searchOrders();
                } else {
                    showError(result.message);
                    ensureInputFocus();
                }

            } catch (error) {
                showError('L·ªói reset tr·∫°ng th√°i: ' + error.message);
                ensureInputFocus();
            }
        }

        async function scanOrderFromTable(orderIndex) {
            const order = currentOrders[orderIndex];
            const maHangInput = document.getElementById(`tableScanInput${orderIndex}`);
            const maHangNhap = maHangInput.value.trim();

            if (!maHangNhap) {
                showError('Vui l√≤ng nh·∫≠p m√£ h√†ng ƒë·ªÉ qu√©t');
                return;
            }

            // Ki·ªÉm tra m√£ h√†ng c√≥ ƒë√∫ng kh√¥ng
            if (maHangNhap !== order.maHang) {
                showError(`M√£ h√†ng kh√¥ng ƒë√∫ng! Y√™u c·∫ßu: ${order.maHang}, Nh·∫≠p: ${maHangNhap}`);
                maHangInput.value = '';
                ensureInputFocus();
                return;
            }

            try {
                const response = await fetch('/api/orders/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maVanDon: currentMaVanDon,
                        maHang: maHangNhap
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    ensureInputFocus();
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
                    order.scannedQuantity = result.data.soLuongDaQuet;
                    order.verified = result.data.verified;
                    order.verifiedAt = result.data.verifiedAt;
                    
                    // Track blocked order n·∫øu ƒë∆°n h√†ng ch∆∞a ho√†n th√†nh
                    if (!order.verified) {
                        trackBlockedOrder(currentMaVanDon, order.maHang);
                    }
                    
                    // C·∫≠p nh·∫≠t progress
                    updateProgress();
                    
                    // Hi·ªÉn th·ªã l·∫°i b·∫£ng v√† grid
                    displayOrdersTable();
                    displayOrders(currentOrders);
                    
                    // X√≥a input v√† focus l·∫°i
                    maHangInput.value = '';
                    ensureInputFocus();
                    
                    // Th√¥ng b√°o qu√©t th√†nh c√¥ng
                    if (order.verified) {
                        showSuccess(`ƒê√£ qu√©t th√†nh c√¥ng m√£ h√†ng ${order.maHang}! (${order.scannedQuantity}/${order.soLuong})`);
                    } else {
                        showSuccess(`ƒê√£ qu√©t m√£ h√†ng ${order.maHang}! (${order.scannedQuantity}/${order.soLuong})`);
                    }
                    
                    // N·∫øu ho√†n th√†nh
                    if (result.data.progress.isCompleted) {
                        setTimeoutWrapper(() => {
                            showVanDonConfirmDialog();
                        }, 1000);
                    }
                } else {
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p b·ªã block
                    if (result.blocked) {
                        showError(result.message, 'warning');
                    } else {
                        showError(result.message);
                ensureInputFocus();
                    ensureInputFocus();
                    }
                    maHangInput.value = '';
                    ensureInputFocus();
                }

            } catch (error) {
                showError('L·ªói qu√©t m√£: ' + error.message);
                ensureInputFocus();
                maHangInput.value = '';
                ensureInputFocus();
            }
        }

        function showSuccess(message) {
            hideAlerts();
            // ƒê·∫£m b·∫£o kh√¥ng c√≥ modal n√†o ƒëang hi·ªÉn th·ªã
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideAlerts, 5000);
        }

        function showError(message) {
            hideAlerts();
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideAlerts, 8000);
        }

        // Function ƒë·∫£m b·∫£o input lu√¥n ƒë∆∞·ª£c focus
        function ensureInputFocus() {
            const maHangInput = document.getElementById('maHangInput');
            const globalScanInput = document.getElementById('globalScanInput');
            
            if (maHangInput) {
                // Clear value tr∆∞·ªõc khi focus
                maHangInput.value = '';
                // Focus v√† click ƒë·ªÉ ƒë·∫£m b·∫£o s·∫µn s√†ng nh·∫≠n input
                maHangInput.focus();
                maHangInput.click();
                // ƒê·∫£m b·∫£o cursor ·ªü cu·ªëi input
                setTimeout(() => {
                    maHangInput.setSelectionRange(0, 0);
                }, 10);
            }
            
            if (globalScanInput) {
                // Clear value tr∆∞·ªõc khi focus
                globalScanInput.value = '';
                // Focus v√† click ƒë·ªÉ ƒë·∫£m b·∫£o s·∫µn s√†ng nh·∫≠n input
                globalScanInput.focus();
                globalScanInput.click();
                // ƒê·∫£m b·∫£o cursor ·ªü cu·ªëi input
                setTimeout(() => {
                    globalScanInput.setSelectionRange(0, 0);
                }, 10);
            }
        }

        function hideAlerts() {
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
        }

        // Clear t·∫•t c·∫£ timeout c√≥ th·ªÉ ƒëang ch·∫°y
        let timeoutIds = [];
        function clearAllTimeouts() {
            timeoutIds.forEach(id => clearTimeout(id));
            timeoutIds = [];
        }

        // Wrapper cho setTimeout ƒë·ªÉ track timeout IDs
        function setTimeoutWrapper(callback, delay) {
            const id = setTimeout(callback, delay);
            timeoutIds.push(id);
            return id;
        }

        function hideOrdersSection() {
            document.getElementById('ordersSection').style.display = 'none';
            currentOrders = [];
            currentMaVanDon = '';
        }

        // Enter ƒë·ªÉ t√¨m ki·∫øm
        document.getElementById('maVanDonInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchOrders();
            }
        });

        // T·ª± ƒë·ªông qu√©t khi nh·∫≠p m√£ h√†ng
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('ma-hang-input')) {
                const orderIndex = parseInt(e.target.getAttribute('data-order-index'));
                const maHangNhap = e.target.value.trim();
                const order = currentOrders[orderIndex];
                
                if (order && maHangNhap === order.maHang) {
                    // T·ª± ƒë·ªông qu√©t khi m√£ h√†ng ƒë√∫ng
                    setTimeout(() => {
                        scanOrder(orderIndex);
                    }, 100);
                }
            }
        });

        // T·ª± ƒë·ªông qu√©t cho global scan input
        document.getElementById('globalScanInput').addEventListener('input', function(e) {
            const maHangNhap = e.target.value.trim();
            if (maHangNhap) {
                // T√¨m ƒë∆°n h√†ng c√≥ m√£ h√†ng n√†y
                const orderIndex = currentOrders.findIndex(order => order.maHang === maHangNhap);
                if (orderIndex !== -1) {
                    // T·ª± ƒë·ªông qu√©t khi t√¨m th·∫•y m√£ h√†ng (ch·ªâ trong ch·∫ø ƒë·ªô scanner)
                    if (scanMode === 'scanner') {
                        setTimeout(() => {
                            globalScan();
                        }, 100);
                    }
                }
            }
        });

        // Enter ƒë·ªÉ qu√©t global
        document.getElementById('globalScanInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                globalScan();
            }
        });

        // T·ª± ƒë·ªông qu√©t cho table scan inputs
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('scan-input-small')) {
                const orderIndex = parseInt(e.target.getAttribute('data-order-index'));
                const maHangNhap = e.target.value.trim();
                const order = currentOrders[orderIndex];
                
                if (order && maHangNhap === order.maHang) {
                    // T·ª± ƒë·ªông qu√©t khi m√£ h√†ng ƒë√∫ng (ch·ªâ trong ch·∫ø ƒë·ªô scanner)
                    if (scanMode === 'scanner') {
                        setTimeout(() => {
                            scanOrderFromTable(orderIndex);
                        }, 100);
                    }
                }
            }
        });

        // Enter ƒë·ªÉ qu√©t table
        document.addEventListener('keypress', function(e) {
            if (e.target.classList.contains('scan-input-small') && e.key === 'Enter') {
                const orderIndex = parseInt(e.target.getAttribute('data-order-index'));
                scanOrderFromTable(orderIndex);
            }
        });

        // L∆∞u tr·∫°ng th√°i block khi qu√©t th√†nh c√¥ng
        function trackBlockedOrder(maVanDon, maHang) {
            blockedOrders.add(`${maVanDon}-${maHang}`);
        }
        
        // Unblock ƒë∆°n h√†ng khi r·ªùi kh·ªèi trang
        async function unblockOrders() {
            let unblockedCount = 0;
            
            // Unblock to√†n b·ªô ƒë∆°n v·∫≠n ƒë∆°n hi·ªán t·∫°i n·∫øu c√≥
            if (currentMaVanDon) {
                try {
                    const response = await fetch('/api/orders/unblock-van-don', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            maVanDon: currentMaVanDon
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log(`üîì ƒê√£ unblock ƒë∆°n v·∫≠n ƒë∆°n ${currentMaVanDon}`);
                        unblockedCount++;
                    }
                } catch (error) {
                    console.log('L·ªói unblock ƒë∆°n v·∫≠n ƒë∆°n:', error);
                }
            }
            
            // Unblock t·ª´ng ƒë∆°n h√†ng ri√™ng l·∫ª (backup)
            for (const orderKey of blockedOrders) {
                const [maVanDon, maHang] = orderKey.split('-');
                try {
                    const response = await fetch('/api/orders/unblock', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            maVanDon: maVanDon,
                            maHang: maHang
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        unblockedCount++;
                    }
                } catch (error) {
                    console.log('L·ªói unblock ƒë∆°n h√†ng:', error);
                }
            }
            
            // Reset tracking
            blockedOrders.clear();
            blockedVanDon = null;
            currentMaVanDon = '';
            currentOrders = [];
            
            return unblockedCount;
        }
        
        // L∆∞u trang tr∆∞·ªõc khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            savePreviousPage();
        });

        // Event listeners ƒë·ªÉ unblock khi r·ªùi kh·ªèi trang
        window.addEventListener('beforeunload', unblockOrders);
        window.addEventListener('pagehide', unblockOrders);
        
        // Unblock khi user ƒë√≥ng tab ho·∫∑c navigate
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                unblockOrders();
            }
        });

        // Hi·ªÉn th·ªã dialog x√°c nh·∫≠n m√£ v·∫≠n ƒë∆°n
        function showVanDonConfirmDialog() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-icon success">‚úì</div>
                    <div class="modal-title">X√°c nh·∫≠n ho√†n th√†nh</div>
                    <div class="modal-message">
                        B·∫°n ƒë√£ qu√©t ƒë·ªß t·∫•t c·∫£ m√£ h√†ng trong ƒë∆°n v·∫≠n ƒë∆°n <strong>${currentMaVanDon}</strong>.<br>
                        Vui l√≤ng qu√©t l·∫°i m√£ v·∫≠n ƒë∆°n ƒë·ªÉ x√°c nh·∫≠n ho√†n th√†nh:
                    </div>
                    <div style="margin: 20px 0;">
                        <input type="text" id="vanDonConfirmInput" class="scan-input" 
                               placeholder="Qu√©t l·∫°i m√£ v·∫≠n ƒë∆°n..." 
                               style="width: 100%; text-align: center; font-size: 1.2rem; padding: 15px;">
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn primary" onclick="confirmVanDonComplete()">X√°c nh·∫≠n</button>
                        <button class="modal-btn secondary" onclick="closeVanDonDialog()">H·ªßy</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus v√†o input v√† x·ª≠ l√Ω Enter
            const input = document.getElementById('vanDonConfirmInput');
            ensureInputFocus();
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmVanDonComplete();
                }
            });
        }

        // ƒê√≥ng dialog x√°c nh·∫≠n m√£ v·∫≠n ƒë∆°n
        function closeVanDonDialog() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // X√°c nh·∫≠n ho√†n th√†nh ƒë∆°n v·∫≠n ƒë∆°n
        async function confirmVanDonComplete() {
            const input = document.getElementById('vanDonConfirmInput');
            const maVanDonInput = input.value.trim();
            
            if (!maVanDonInput) {
                showError('Vui l√≤ng nh·∫≠p m√£ v·∫≠n ƒë∆°n ƒë·ªÉ x√°c nh·∫≠n');
                return;
            }
            
            if (maVanDonInput !== currentMaVanDon) {
                showError(`M√£ v·∫≠n ƒë∆°n kh√¥ng ƒë√∫ng! Y√™u c·∫ßu: ${currentMaVanDon}, Nh·∫≠p: ${maVanDonInput}`);
                input.value = '';
                ensureInputFocus();
                return;
            }
            
            try {
                const response = await fetch('/api/orders/complete-van-don', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        maVanDon: currentMaVanDon
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeVanDonDialog();
                    showSuccess(result.message);
                    ensureInputFocus();
                    
                    // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒë∆°n h√†ng
                    await searchOrders();
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o ho√†n th√†nh v√† h·ªèi c√≥ mu·ªën quay l·∫°i kh√¥ng
                    setTimeout(() => {
                        alert('ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c qu√©t ho√†n t·∫•t');
                        if (confirm('B·∫°n c√≥ mu·ªën quay l·∫°i trang tr∆∞·ªõc kh√¥ng?')) {
                            goBackToPreviousPage();
                        }
                    }, 1000);
                } else {
                    showError(result.message);
                ensureInputFocus();
                    ensureInputFocus();
                    input.value = '';
                    ensureInputFocus();
                }
                
            } catch (error) {
                showError('L·ªói x√°c nh·∫≠n ƒë∆°n v·∫≠n ƒë∆°n: ' + error.message);
                ensureInputFocus();
                input.value = '';
            }
        }
    </script>
</body>
<script src="/userbar.js"></script>
</html>
