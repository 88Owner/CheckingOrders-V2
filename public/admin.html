<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã h·ªá th·ªëng - Order Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .admin-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .admin-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #667eea;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .success-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .success-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-message {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .table-container {
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .table-container h3 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 18px 25px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .admin-table th,
        .admin-table td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .admin-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .admin-table tbody tr {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .admin-table tbody tr:hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f1f3f4 100%);
            border-left-color: #667eea;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .admin-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        .admin-table tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, #f8f9ff 0%, #f1f3f4 100%);
        }

        .role-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .role-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .role-badge.admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .role-badge.checker {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .role-badge.packer {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .role-badge.user {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .role-badge.warehouse_manager {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .role-badge.warehouse_staff {
            background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
            color: white;
        }

        /* Enhanced button styles for table actions */
        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            margin: 2px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            min-width: 80px;
        }

        .btn-small:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-small.btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-small.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-small.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-message {
            font-size: 16px;
            font-weight: 500;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            transition: all 0.3s ease;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .admin-section {
                padding: 20px;
            }
        }

        .machines-list {
            margin-top: 20px;
        }

        .machines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .machine-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .machine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .machine-header h3 {
            margin: 0;
            color: #333;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .machine-info {
            margin-bottom: 15px;
        }

        .machine-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }

        .com-ports-section h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .port-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }

        .port-item.available {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }

        .port-item.unavailable {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
        }

        .port-path {
            font-weight: bold;
            color: #333;
        }

        .port-manufacturer {
            color: #666;
            flex: 1;
            margin: 0 10px;
        }

        .port-confidence {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .port-confidence.high {
            background: #28a745;
            color: white;
        }

        .port-confidence.medium {
            background: #ffc107;
            color: #333;
        }

        .port-confidence.low {
            background: #6c757d;
            color: white;
        }

        .scanner-badge {
            background: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }

        .no-ports {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* Pagination Styles */
        .pagination-btn {
            padding: 8px 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .pagination-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
        }

        .pagination-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            border-color: #ddd;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:right; margin-top:20px;">
            <button id="logoutBtn" style="background:#e83e8c;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;">ƒêƒÉng xu·∫•t</button>
        </div>
        
        <div class="header">
            <h1>Qu·∫£n tr·ªã h·ªá th·ªëng</h1>
            <p>Qu·∫£n l√Ω t√†i kho·∫£n v√† c·∫•u h√¨nh h·ªá th·ªëng</p>
        </div>

        <div class="content">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>T·ªïng ƒë∆°n h√†ng</h3>
                    <div class="number" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>T·ªïng t√†i kho·∫£n</h3>
                    <div class="number" id="totalAccounts">0</div>
                </div>
                <div class="stat-card">
                    <h3>ƒê∆°n h√†ng ƒë√£ x√°c nh·∫≠n</h3>
                    <div class="number" id="verifiedOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>ƒê∆°n h√†ng ƒëang x·ª≠ l√Ω</h3>
                    <div class="number" id="processingOrders">0</div>
                </div>
            </div>

            <!-- Account Management -->
            <div class="admin-section">
                <h2>üë• Qu·∫£n l√Ω t√†i kho·∫£n</h2>
                
                <form id="registerForm">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                        <label for="role">Quy·ªÅn</label>
                        <select id="role" name="role" required>
                            <option value="">Ch·ªçn quy·ªÅn</option>
                            <option value="admin">Admin</option>
                            <option value="checker">Checker</option>
                            <option value="packer">Packer</option>
                            <option value="warehouse_manager">Qu·∫£n l√Ω kho ph√¥i</option>
                            <option value="warehouse_staff">Nh√¢n vi√™n kho ph√¥i</option>
                            <option value="user">User</option>
                        </select>
                </div>
                    <button type="submit" class="btn btn-success">T·∫°o t√†i kho·∫£n</button>
            </form>

                <div class="table-container">
                    <h3>Danh s√°ch t√†i kho·∫£n</h3>
                    <div class="table-responsive">
                        <table class="admin-table">
                <thead>
                    <tr>
                        <th>T√™n ƒëƒÉng nh·∫≠p</th>
                        <th>Quy·ªÅn</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- COM Port Management - ·∫®N -->
            <div class="admin-section" style="display: none;">
                <h2>üîå Qu·∫£n l√Ω ph√¢n quy·ªÅn COM Port</h2>
                <p>Ph√¢n quy·ªÅn c·ªïng COM cho user - Nh·∫≠p th·ªß c√¥ng t√™n COM port</p>
                
                <!-- Form nh·∫≠p COM port th·ªß c√¥ng -->
                <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4>üìù Ph√¢n quy·ªÅn COM Port cho User</h4>
                    <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="newComPort">T√™n COM Port:</label>
                            <input type="text" id="newComPort" placeholder="VD: COM3, COM4, COM5..." 
                                   style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="selectedUserId">Ch·ªçn User:</label>
                            <select id="selectedUserId" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">-- Ch·ªçn User --</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="addNewComPort()" class="btn btn-success" style="margin-top: 20px;">
                                ‚ûï Ph√¢n quy·ªÅn COM Port
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="loadComPortManagement()" class="btn btn-success">
                        üîÑ L√†m m·ªõi danh s√°ch
                    </button>
                    <button onclick="loadAllComPorts()" class="btn" style="background: #17a2b8;">
                        üìã Xem t·∫•t c·∫£ COM Ports
                    </button>
                </div>
                
                <!-- Th·ªëng k√™ COM Port -->
                <div id="comStats" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                    <h4>üìä Th·ªëng k√™ COM Port</h4>
                    <div id="comStatsContent"></div>
                </div>
                
                <!-- Danh s√°ch User v√† COM Port -->
                <div class="table-container">
                    <h3>üë• Danh s√°ch User & COM Port</h3>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">User</th>
                                    <th style="width: 120px;">Role</th>
                                    <th style="width: 150px;">COM hi·ªán t·∫°i</th>
                                    <th style="width: 200px;">Ch·ªçn COM m·ªõi</th>
                                    <th style="width: 100px;">Tr·∫°ng th√°i</th>
                                    <th style="width: 150px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="comManagementTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">üîå</div>
                                        <div>Click "L√†m m·ªõi danh s√°ch COM" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Danh s√°ch COM Port kh·∫£ d·ª•ng -->
                <div class="table-container" style="margin-top: 20px;">
                    <h3>üîå Danh s√°ch COM Port kh·∫£ d·ª•ng</h3>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">COM Port</th>
                                    <th style="width: 150px;">Nh√† s·∫£n xu·∫•t</th>
                                    <th style="width: 100px;">ƒê·ªô tin c·∫≠y</th>
                                    <th style="width: 120px;">Tr·∫°ng th√°i</th>
                                    <th style="width: 150px;">User ƒëang d√πng</th>
                                    <th style="width: 200px;">Ghi ch√∫</th>
                                </tr>
                            </thead>
                            <tbody id="comPortsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                                        <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
                                        <div>Ch∆∞a c√≥ d·ªØ li·ªáu COM Port</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- COM Port Management - T·∫•t c·∫£ m√°y - ·∫®N -->
            <div class="admin-section" style="display: none;">
                <h2>üîå Qu·∫£n l√Ω COM Ports - T·∫•t c·∫£ m√°y</h2>
                <p>Xem v√† qu·∫£n l√Ω COM ports c·ªßa t·∫•t c·∫£ m√°y ƒë√£ truy c·∫≠p h·ªá th·ªëng</p>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="loadAllMachines()" class="btn btn-success">
                        üîÑ L√†m m·ªõi danh s√°ch m√°y
                    </button>
                    <button onclick="loadAllMachines(true)" class="btn" style="background: #ff9800;">
                        üîÑ Force refresh
                    </button>
                </div>
                
                <!-- Th·ªëng k√™ -->
                <div id="machinesStats" class="stats-container" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">T·ªïng m√°y:</span>
                        <span class="stat-value" id="totalMachines">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">M√°y online:</span>
                        <span class="stat-value" id="onlineMachines">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">T·ªïng COM ports:</span>
                        <span class="stat-value" id="totalComPorts">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">COM ports kh·∫£ d·ª•ng:</span>
                        <span class="stat-value" id="availableComPorts">0</span>
                    </div>
                </div>
                
                <!-- Danh s√°ch m√°y -->
                <div id="machinesList" class="machines-list">
                    <p class="loading">ƒêang t·∫£i danh s√°ch m√°y...</p>
                </div>
            </div>

            <!-- Order Management -->
            <div class="admin-section">
                <h2>üì¶ Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-danger" onclick="clearAllOrders()">X√≥a t·∫•t c·∫£ ƒë∆°n h√†ng</button>
                    <button class="btn" onclick="refreshStats()">L√†m m·ªõi th·ªëng k√™</button>
                    <button class="btn" onclick="exportData()">Xu·∫•t d·ªØ li·ªáu</button>
                </div>

                <!-- Search and Filter -->
                <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 2px solid #e9ecef;">
                    <h4>üîç T√¨m ki·∫øm ƒë∆°n h√†ng</h4>
                    <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="searchInput">T·ª´ kh√≥a:</label>
                            <input type="text" id="searchInput" placeholder="T√¨m theo m√£ ƒë∆°n h√†ng, m√£ v·∫≠n ƒë∆°n, m√£ h√†ng..." 
                                   style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div style="min-width: 150px;">
                            <label for="statusFilter">Tr·∫°ng th√°i:</label>
                            <select id="statusFilter" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="verified">ƒê√£ x√°c nh·∫≠n</option>
                                <option value="pending">Ch∆∞a x√°c nh·∫≠n</option>
                            </select>
                        </div>
                        <div>
                            <button onclick="searchOrders()" class="btn btn-success" style="margin-top: 20px;">
                                üîç T√¨m ki·∫øm
                            </button>
                            <button onclick="clearSearch()" class="btn" style="margin-top: 20px; background: #6c757d;">
                                üóëÔ∏è X√≥a b·ªô l·ªçc
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3>Danh s√°ch ƒë∆°n h√†ng</h3>
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ ƒë√≥ng g√≥i</th>
                                    <th>M√£ v·∫≠n ƒë∆°n</th>
                                    <th>M√£ ƒë∆°n h√†ng</th>
                                    <th>M√£ h√†ng</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Nh√¢n vi√™n</th>
                                    <th>Th·ªùi gian qu√©t</th>
                                    <th>Ng√†y import</th>
                    </tr>
                </thead>
                            <tbody id="ordersTableBody">
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationContainer" style="margin-top: 20px; text-align: center; padding: 20px;">
                        <div id="paginationInfo" style="margin-bottom: 15px; color: #666; font-size: 14px;">
                            Hi·ªÉn th·ªã 0 - 0 c·ªßa 0 ƒë∆°n h√†ng
                        </div>
                        <div id="paginationButtons" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                            <!-- Pagination buttons will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let comPortsData = [];
        let usersData = [];
        let authToken = null;
        let statsInterval = null;
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalOrders = 0;
        let allOrders = [];
        let filteredOrders = [];

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            
            // Add Enter key support for search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchOrders();
                }
            });
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            stopRealtimeStats();
        });

        // Initialize authentication and load data
        async function initializeAuth() {
            try {
                // Get token from session
                const response = await fetch('/api/admin/token', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.token;
                    console.log('‚úÖ Admin token loaded successfully');
                    
                    // Load all data after getting token
                    await Promise.all([
                        loadAccounts(),
                        loadRecentOrders(),
                        refreshStats()
                    ]);
                    
                    // Load machines data separately (since this section is hidden)
                    try {
                        await loadAllMachines();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Failed to load machines data:', error);
                    }
                    
                    // Start real-time stats updates
                    startRealtimeStats();
                } else {
                    console.error('‚ùå Failed to get admin token:', result.message);
                    showError('L·ªói x√°c th·ª±c: ' + result.message);
                }
            } catch (error) {
                console.error('‚ùå Error initializing auth:', error);
                showError('L·ªói kh·ªüi t·∫°o: ' + error.message);
            }
        }

        // Start real-time stats updates
        function startRealtimeStats() {
            // Clear existing interval
            if (statsInterval) {
                clearInterval(statsInterval);
            }
            
            // Update stats every 30 seconds
            statsInterval = setInterval(async () => {
                try {
                    await refreshStats();
                    console.log('üîÑ Stats updated automatically');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to update stats automatically:', error);
                }
            }, 30000); // 30 seconds
            
            console.log('‚úÖ Real-time stats updates started');
        }

        // Stop real-time stats updates
        function stopRealtimeStats() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
                console.log('‚èπÔ∏è Real-time stats updates stopped');
            }
        }

        // Handle logout
        document.getElementById('logoutBtn').onclick = async function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                // Stop real-time updates
                stopRealtimeStats();
                
                await fetch('/api/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login';
                }
        };

        // Handle account registration
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role')
            };

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    e.target.reset();
                    loadAccounts();
                    refreshStats();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('L·ªói t·∫°o t√†i kho·∫£n: ' + error.message);
            }
        });

        // Load accounts
    async function loadAccounts(showLoading = true, suppressAlerts = false) {
            try {
                console.log('üìã Loading accounts list, showLoading:', showLoading);
                
                if (showLoading) {
                    // Show loading state in table
                    const tbody = document.getElementById('accountsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: #667eea;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
                                    ƒêang t·∫£i danh s√°ch t√†i kho·∫£n...
                                </td>
                            </tr>
                        `;
                    }
                }
                
                console.log('üîÑ Fetching accounts from API...');
                const response = await fetch('/api/accounts', {
                    credentials: 'include'
                });
                
                console.log('üì° Accounts API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üìÑ Accounts API response data:', result);
                
                if (result.success) {
                    console.log('‚úÖ Accounts data received, displaying...');
                    displayAccounts(result.data);
                } else {
                    console.error('‚ùå API returned error:', result.message);
                    if (!suppressAlerts) showError(result.message);
                    // Show error state in table
                    const tbody = document.getElementById('accountsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                                    L·ªói t·∫£i danh s√°ch t√†i kho·∫£n: ${result.message}
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading accounts:', error);
                if (!suppressAlerts) showError('L·ªói t·∫£i danh s√°ch t√†i kho·∫£n: ' + error.message);
                // Show error state in table
                const tbody = document.getElementById('accountsTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                                <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                                L·ªói k·∫øt n·ªëi: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Display accounts
        function displayAccounts(accounts) {
            console.log('üìä Displaying accounts:', accounts.length, 'accounts');
            
            const tbody = document.getElementById('accountsTableBody');
            if (!tbody) {
                console.error('‚ùå Cannot find accountsTableBody element');
                return;
            }
            
            tbody.innerHTML = '';

            if (!accounts || accounts.length === 0) {
                console.log('üìã No accounts to display');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <div class="empty-state-message">Kh√¥ng c√≥ t√†i kho·∫£n n√†o</div>
                        </td>
                    </tr>
                `;
                return;
            }

            accounts.forEach(account => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${account.username}</td>
                    <td><span class="role-badge ${account.role}">${account.role.toUpperCase()}</span></td>
                    <td>${new Date(account.createdAt).toLocaleDateString('vi-VN')}</td>
                    <td>
                        ${account.username !== 'admin' ? `
                            <select id="roleSelect_${account._id}" style="padding: 8px; border-radius: 6px; border: 2px solid #ddd;">
                                <option value="admin" ${account.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="checker" ${account.role === 'checker' ? 'selected' : ''}>Checker</option>
                                <option value="packer" ${account.role === 'packer' ? 'selected' : ''}>Packer</option>
                                <option value="warehouse_manager" ${account.role === 'warehouse_manager' ? 'selected' : ''}>Qu·∫£n l√Ω kho ph√¥i</option>
                                <option value="warehouse_staff" ${account.role === 'warehouse_staff' ? 'selected' : ''}>Nh√¢n vi√™n kho ph√¥i</option>
                                <option value="user" ${account.role === 'user' ? 'selected' : ''}>User</option>
                            </select>
                            <button class="btn-small btn-success" onclick="saveRole('${account._id}')">üíæ Save</button>
                            <button class="btn-small btn-warning" onclick="showChangePasswordModal('${account._id}', '${account.username}')">üîë ƒê·ªïi MK</button>
                            <button class="btn-small btn-danger" onclick="deleteAccount('${account._id}')">üóëÔ∏è X√≥a</button>
                        ` : 'T√†i kho·∫£n g·ªëc'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Save role
        async function saveRole(accountId) {
            const selectElement = document.getElementById(`roleSelect_${accountId}`);
            if (!selectElement) {
                showError('Kh√¥ng t√¨m th·∫•y dropdown role!');
                return;
            }
            
            const newRole = selectElement.value;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ role: newRole })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message || 'ƒê√£ l∆∞u quy·ªÅn th√†nh c√¥ng!');
                    loadAccounts();
                } else {
                    showError(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                showError('L·ªói l∆∞u quy·ªÅn: ' + error.message);
            }
        }
        
        // Delete account
        async function deleteAccount(accountId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y?\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Starting delete account process for:', accountId);
                
                // Show loading state
                showSuccess('ƒêang x√≥a t√†i kho·∫£n...');
                
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                console.log('üì° Delete response status:', response.status);
                
                const result = await response.json();
                console.log('üìÑ Delete response data:', result);
                
                if (result.success) {
                    showSuccess('X√≥a t√†i kho·∫£n th√†nh c√¥ng');
                    
                    console.log('üîÑ Refreshing accounts list...');
                    // Refresh accounts list with loading state
                    try {
                        await loadAccounts(true);
                        console.log('‚úÖ Accounts list refreshed successfully');
                    } catch (loadError) {
                        console.error('‚ùå Error refreshing accounts:', loadError);
                        showError('X√≥a t√†i kho·∫£n th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ refresh danh s√°ch. Vui l√≤ng reload trang.');
                    }
                    
                    console.log('üîÑ Refreshing stats...');
                    // Refresh stats
                    try {
                        await refreshStats();
                        console.log('‚úÖ Stats refreshed successfully');
                    } catch (statsError) {
                        console.error('‚ùå Error refreshing stats:', statsError);
                        // Stats error is not critical, don't show error to user
                    }
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('‚ùå Error deleting account:', error);
                showError('L·ªói x√≥a t√†i kho·∫£n: ' + error.message);
            }
        }
        
        // COM Port Management Functions
        async function loadComPortManagement(forceRefresh = false) {
            try {
                console.log('Loading COM Port Management...');
                
                // Load Users
                const usersResponse = await fetch('/api/accounts', {
                    credentials: 'include'
                });
                const usersResult = await usersResponse.json();
                
                if (!usersResult.success) {
                    showError('L·ªói t·∫£i danh s√°ch user: ' + usersResult.message);
                    return;
                }
                
                usersData = usersResult.data || [];
                console.log('Users loaded:', usersData.length);
                
                // Load users into dropdown
                loadUsersIntoDropdown();
                
                // Load all COM ports from database
                await loadAllComPorts();
                
                // Display data
                displayComManagementTable();
                displayComPortsTable();
                
                if (forceRefresh) {
                    showSuccess('ƒê√£ l√†m m·ªõi danh s√°ch!');
                }
                
            } catch (error) {
                console.error('Error loading COM management:', error);
                showError('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }
        
        // Load users into dropdown
        function loadUsersIntoDropdown() {
            const select = document.getElementById('selectedUserId');
            select.innerHTML = '<option value="">-- Ch·ªçn User --</option>';
            
            usersData.forEach(user => {
                if (user.username !== 'admin') { // Skip admin
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = `${user.username} (${user.role})`;
                    select.appendChild(option);
                }
            });
        }
        
        // Load all COM ports from database
        async function loadAllComPorts() {
            try {
                const response = await fetch('/api/admin/all-com-ports', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    comPortsData = result.data.ports || [];
                    console.log('All COM Ports loaded:', comPortsData.length);
                    
                    // Display stats
                    displayComStats(result.data);
                } else {
                    console.error('Failed to load COM ports:', result.message);
                    comPortsData = [];
                }
            } catch (error) {
                console.error('Error loading all COM ports:', error);
                comPortsData = [];
            }
        }
        
        // Add new COM port manually
        async function addNewComPort() {
            const portName = document.getElementById('newComPort').value.trim();
            const userId = document.getElementById('selectedUserId').value;
            
            if (!portName) {
                showError('Vui l√≤ng nh·∫≠p t√™n COM Port!');
                return;
            }
            
            if (!userId) {
                showError('Vui l√≤ng ch·ªçn User!');
                return;
            }
            
            // Validate COM port format
            if (!/^COM\d+$/i.test(portName)) {
                showError('COM Port ph·∫£i c√≥ ƒë·ªãnh d·∫°ng COM + s·ªë (VD: COM3, COM4)');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/add-com-port', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        portName: portName.toUpperCase(),
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`ƒê√£ ph√¢n quy·ªÅn COM Port ${portName} cho user ${userId} th√†nh c√¥ng!`);
                    
                    // Clear form
                    document.getElementById('newComPort').value = '';
                    document.getElementById('selectedUserId').value = '';
                    
                    // Refresh data
                    await loadAllComPorts();
                    displayComPortsTable();
                    displayComManagementTable();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('Error adding COM port:', error);
                showError('L·ªói ph√¢n quy·ªÅn COM Port: ' + error.message);
            }
        }

        // Display COM Stats
        function displayComStats(data) {
            const statsDiv = document.getElementById('comStats');
            const statsContent = document.getElementById('comStatsContent');
            
            if (!data.summary) {
                statsDiv.style.display = 'none';
                return;
            }
            
            const summary = data.summary;
            statsContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #667eea;">${summary.totalPorts}</div>
                        <div style="font-size: 14px; color: #666;">T·ªïng COM Port</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #28a745;">${summary.availablePorts}</div>
                        <div style="font-size: 14px; color: #666;">Kh·∫£ d·ª•ng</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${summary.assignedPorts}</div>
                        <div style="font-size: 14px; color: #666;">ƒê√£ ph√¢n quy·ªÅn</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${summary.scannerDevices}</div>
                        <div style="font-size: 14px; color: #666;">M√°y qu√©t</div>
                    </div>
                </div>
            `;
            statsDiv.style.display = 'block';
        }

        // Display COM Management Table
        function displayComManagementTable() {
            const tbody = document.getElementById('comManagementTableBody');
            
            if (usersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üë•</div>
                            <div>Kh√¥ng c√≥ user n√†o</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            usersData.forEach(user => {
                if (user.username === 'admin') return; // Skip admin
                
                // T√¨m COM port t·ª´ comPortsData (t·ª´ scannerassignments)
                const userAssignment = comPortsData.find(port => port.userId === user.username);
                const currentCom = userAssignment ? userAssignment.path : 'Ch∆∞a c√≥';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600; color: #333;">${user.username}</div>
                        <div style="font-size: 12px; color: #666;">ID: ${user._id}</div>
                    </td>
                    <td>
                        <span class="role-badge ${user.role}">${user.role.toUpperCase()}</span>
                    </td>
                    <td>
                        <div style="font-weight: 600; color: ${currentCom !== 'Ch∆∞a c√≥' ? '#28a745' : '#dc3545'};">
                            ${currentCom}
                        </div>
                        ${currentCom !== 'Ch∆∞a c√≥' ? 
                            `<div style="font-size: 11px; color: #666;">‚úÖ ƒê√£ ph√¢n quy·ªÅn</div>` : 
                            `<div style="font-size: 11px; color: #666;">‚ùå Ch∆∞a ph√¢n quy·ªÅn</div>`
                        }
                    </td>
                    <td>
                        <input type="text" id="comInput_${user._id}" 
                               value="${currentCom !== 'Ch∆∞a c√≥' ? currentCom : ''}" 
                               placeholder="Nh·∫≠p COM port (VD: COM3)" 
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            üí° Nh·∫≠p t√™n COM port th·ªß c√¥ng
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 12px; color: #666;">
                            ${currentCom !== 'Ch∆∞a c√≥' ? 'üü¢ ƒê√£ c√≥ COM' : 'üî¥ Ch∆∞a c√≥ COM'}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-success" onclick="saveComPermission('${user._id}', '${user.username}')" 
                                style="font-size: 12px; padding: 6px 12px;">
                            üíæ L∆∞u
                        </button>
                        ${currentCom !== 'Ch∆∞a c√≥' ? 
                            `<button class="btn btn-danger" onclick="removeComPermission('${user._id}', '${user.username}')" 
                                     style="font-size: 12px; padding: 6px 12px; margin-left: 5px;">
                                üóëÔ∏è X√≥a
                            </button>` : ''
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Display COM Ports Table
        function displayComPortsTable() {
            const tbody = document.getElementById('comPortsTableBody');
            
            if (comPortsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üîå</div>
                            <div>Ch∆∞a c√≥ COM Port n√†o. H√£y th√™m COM Port m·ªõi!</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            comPortsData.forEach(port => {
                const row = document.createElement('tr');
                
                // Confidence badge
                let confidenceBadge = '';
                if (port.confidence === 'high') {
                    confidenceBadge = '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">CAO</span>';
                } else if (port.confidence === 'medium') {
                    confidenceBadge = '<span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">TRUNG B√åNH</span>';
                } else {
                    confidenceBadge = '<span style="background: #9e9e9e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">TH·∫§P</span>';
                }
                
                // Status badge
                let statusBadge = '';
                if (port.isAvailable) {
                    statusBadge = '<span style="background: #4caf50; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">üü¢ KH·∫¢ D·ª§NG</span>';
                } else {
                    statusBadge = '<span style="background: #f44336; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">üî¥ ƒê√É PH√ÇN QUY·ªÄN</span>';
                }
                
                row.innerHTML = `
                    <td style="font-weight: 600; color: ${port.isAvailable ? '#667eea' : '#999'};">
                        <div style="font-size: 16px;">üì± ${port.path}</div>
                        ${port.isLikelyScanner ? '<div style="font-size: 11px; color: #4caf50; margin-top: 2px;">üîç Scanner</div>' : ''}
                    </td>
                    <td>${port.manufacturer || '<em style="color: #999;">Unknown</em>'}</td>
                    <td>${confidenceBadge}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${port.assignedToUser ? 
                            `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">üë§ ${port.assignedToUser}</span>` : 
                            '<span style="color: #999;">-</span>'
                        }
                    </td>
                    <td>
                        <div style="font-size: 12px; color: #666;">${port.note || port.path}</div>
                        ${port.deviceType ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">${port.deviceType}</div>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Save COM Permission
        async function saveComPermission(userId, username) {
            const comInput = document.getElementById(`comInput_${userId}`);
            const selectedCom = comInput.value.trim();
            
            if (!selectedCom) {
                showError('Vui l√≤ng nh·∫≠p COM Port!');
                return;
            }
            
            // Validate COM port format
            if (!/^COM\d+$/i.test(selectedCom)) {
                showError('COM Port ph·∫£i c√≥ ƒë·ªãnh d·∫°ng COM + s·ªë (VD: COM3, COM4)');
                return;
            }
            
            try {
                console.log(`Saving COM permission: ${selectedCom} for user ${username}`);
                
                const response = await fetch(`/api/accounts/${userId}/scanner-permissions`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        allowedScanners: [],
                        assignedScanner: null,
                        port: selectedCom,
                        allowedPorts: [selectedCom]
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`ƒê√£ ph√¢n quy·ªÅn COM ${selectedCom} cho user ${username}!`);
                    loadComPortManagement(); // Refresh data
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('Error saving COM permission:', error);
                showError('L·ªói ph√¢n quy·ªÅn COM: ' + error.message);
            }
        }

        // Remove COM Permission
        async function removeComPermission(userId, username) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën thu h·ªìi quy·ªÅn s·ª≠ d·ª•ng COM t·ª´ user ${username}?`)) {
                return;
            }
            
            try {
                console.log(`Removing COM permission from user ${username}`);
                
                const response = await fetch(`/api/accounts/${userId}/scanner-permissions`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        allowedScanners: [],
                        assignedScanner: null,
                        port: null,
                        allowedPorts: []
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`ƒê√£ thu h·ªìi quy·ªÅn COM t·ª´ user ${username}!`);
                    loadComPortManagement(); // Refresh data
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('Error removing COM permission:', error);
                showError('L·ªói thu h·ªìi quy·ªÅn: ' + error.message);
            }
        }

        // Load all orders for pagination
        async function loadAllOrders() {
            try {
                if (!authToken) {
                    console.error('‚ùå No auth token available for orders API');
                    return;
                }
                
                const response = await fetch('/api/orders?limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();

                if (result.success) {
                    allOrders = result.data.orders || [];
                    filteredOrders = [...allOrders];
                    totalOrders = allOrders.length;
                    displayOrdersWithPagination();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng: ' + error.message);
            }
        }

        // Load recent orders (for backward compatibility)
        async function loadRecentOrders() {
            await loadAllOrders();
        }

        // Display orders with pagination
        function displayOrdersWithPagination() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const ordersToShow = filteredOrders.slice(startIndex, endIndex);
            
            displayOrders(ordersToShow);
            updatePaginationInfo();
            renderPaginationButtons();
        }

        // Display orders in table
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #666; padding: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                            <div>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</div>
                        </td>
                    </tr>
                `;
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');
                
                // Format th·ªùi gian qu√©t
                let scanTime = '-';
                if (order.verified && order.verifiedAt) {
                    const scanDate = new Date(order.verifiedAt);
                    scanTime = scanDate.toLocaleDateString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }) + ' ' + scanDate.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
                
                // Hi·ªÉn th·ªã nh√¢n vi√™n qu√©t
                let scannerName = '-';
                if (order.verified && order.checkingBy) {
                    scannerName = order.checkingBy;
                }
                
                row.innerHTML = `
                    <td>${order.stt}</td>
                    <td>${order.maDongGoi}</td>
                    <td>${order.maVanDon}</td>
                    <td>${order.maDonHang}</td>
                    <td>${order.maHang}</td>
                    <td>${order.soLuong}</td>
                    <td>${order.verified ? '<span style="color: green; font-weight: bold;">‚úÖ ƒê√£ x√°c nh·∫≠n</span>' : '<span style="color: orange; font-weight: bold;">‚è≥ Ch∆∞a x√°c nh·∫≠n</span>'}</td>
                    <td>${scannerName}</td>
                    <td>${scanTime}</td>
                    <td>${new Date(order.importDate).toLocaleDateString('vi-VN')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display recent orders (for backward compatibility)
        function displayRecentOrders(orders) {
            displayOrders(orders);
        }

        // Refresh statistics
        async function refreshStats() {
            try {
                if (!authToken) {
                    console.error('‚ùå No auth token available for stats API');
                    return;
                }
                
                const [ordersResponse, accountsResponse] = await Promise.all([
                    fetch('/api/orders', { 
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('/api/accounts', { credentials: 'include' })
                ]);

                const ordersResult = await ordersResponse.json();
                const accountsResult = await accountsResponse.json();

                if (ordersResult.success && accountsResult.success) {
                    const orders = ordersResult.data.orders;
                    const accounts = accountsResult.data;

                    // T√≠nh s·ªë MaVanDon duy nh·∫•t (T·ªïng s·ªë ƒë∆°n h√†ng)
                    const uniqueMaVanDons = new Set(orders.map(o => o.maVanDon).filter(Boolean));
                    const totalUniqueVanDons = uniqueMaVanDons.size;
                    
                    // T√≠nh s·ªë MaVanDon ƒë√£ verify (duy nh·∫•t)
                    const verifiedMaVanDons = new Set(orders.filter(o => o.verified).map(o => o.maVanDon).filter(Boolean));
                    const totalVerifiedVanDons = verifiedMaVanDons.size;
                    
                    // T√≠nh s·ªë MaVanDon ƒëang qu√©t (duy nh·∫•t)
                    const inProgressMaVanDons = new Set(orders.filter(o => !o.verified && (o.scannedQuantity || 0) > 0).map(o => o.maVanDon).filter(Boolean));
                    const totalInProgressVanDons = inProgressMaVanDons.size;

                    // Update with animation
                    updateStatWithAnimation('totalOrders', totalUniqueVanDons);
                    updateStatWithAnimation('totalAccounts', accounts.length);
                    updateStatWithAnimation('verifiedOrders', totalVerifiedVanDons);
                    updateStatWithAnimation('processingOrders', totalInProgressVanDons);
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }

        // Update stat with animation
        function updateStatWithAnimation(elementId, newValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const currentValue = parseInt(element.textContent) || 0;
            if (currentValue === newValue) return;
            
            // Add animation class
            element.style.transform = 'scale(1.1)';
            element.style.color = '#667eea';
            
            // Update value
            element.textContent = newValue;
            
            // Remove animation after 300ms
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = '#333';
            }, 300);
        }

        // Clear all orders
        async function clearAllOrders() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ ƒë∆°n h√†ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }

            try {
                if (!authToken) {
                    showError('Kh√¥ng c√≥ token x√°c th·ª±c');
                    return;
                }
                
                const response = await fetch('/api/orders', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message);
                    loadRecentOrders();
                    refreshStats();
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('L·ªói x√≥a ƒë∆°n h√†ng: ' + error.message);
            }
        }

        // Search orders
        function searchOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value;
            
            filteredOrders = allOrders.filter(order => {
                // Search by multiple fields
                const matchesSearch = !searchTerm || 
                    order.maDonHang?.toLowerCase().includes(searchTerm) ||
                    order.maVanDon?.toLowerCase().includes(searchTerm) ||
                    order.maHang?.toLowerCase().includes(searchTerm) ||
                    order.maDongGoi?.toLowerCase().includes(searchTerm);
                
                // Filter by status
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'verified' && order.verified) ||
                    (statusFilter === 'pending' && !order.verified);
                
                return matchesSearch && matchesStatus;
            });
            
            currentPage = 1; // Reset to first page
            displayOrdersWithPagination();
            
            console.log(`üîç Search results: ${filteredOrders.length} orders found`);
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            filteredOrders = [...allOrders];
            currentPage = 1;
            displayOrdersWithPagination();
        }

        // Update pagination info
        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredOrders.length);
            const total = filteredOrders.length;
            
            document.getElementById('paginationInfo').textContent = 
                `Hi·ªÉn th·ªã ${startIndex} - ${endIndex} c·ªßa ${total} ƒë∆°n h√†ng`;
        }

        // Render pagination buttons
        function renderPaginationButtons() {
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            const container = document.getElementById('paginationButtons');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ Tr∆∞·ªõc</button>`;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="padding: 8px;">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Sau ‚Ä∫</button>`;
            
            container.innerHTML = html;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayOrdersWithPagination();
            }
        }

        // Export data
        function exportData() {
            showSuccess('T√≠nh nƒÉng xu·∫•t d·ªØ li·ªáu ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
        }

        // Show success message
        function showSuccess(message) {
            hideAlerts();
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideAlerts, 5000);
        }

        // Show error message
        function showError(message) {
            hideAlerts();
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(hideAlerts, 8000);
        }

        // Hide alerts
        function hideAlerts() {
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('errorAlert').style.display = 'none';
        }

        // All Machines COM Port Management
        let allMachinesData = [];

        // Load all machines COM ports
        async function loadAllMachines(forceRefresh = false) {
            try {
                const machinesList = document.getElementById('machinesList');
                const machinesStats = document.getElementById('machinesStats');
                
                machinesList.innerHTML = '<p class="loading">ƒêang t·∫£i danh s√°ch m√°y...</p>';
                
                const response = await fetch('/api/admin/all-machines' + (forceRefresh ? '?force=true' : ''), {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    const { machines, stats } = result.data;
                    
                    // Hi·ªÉn th·ªã th·ªëng k√™
                    document.getElementById('totalMachines').textContent = stats.totalMachines;
                    document.getElementById('onlineMachines').textContent = stats.onlineMachines;
                    document.getElementById('totalComPorts').textContent = stats.totalComPorts;
                    document.getElementById('availableComPorts').textContent = stats.totalAvailablePorts;
                    machinesStats.style.display = 'flex';
                    
                    // Hi·ªÉn th·ªã danh s√°ch m√°y
                    if (machines.length === 0) {
                        machinesList.innerHTML = '<p class="no-data">Ch∆∞a c√≥ m√°y n√†o truy c·∫≠p h·ªá th·ªëng</p>';
                        return;
                    }
                    
                    let html = '<div class="machines-grid">';
                    
                    machines.forEach(machine => {
                        const onlineStatus = machine.isOnline ? 'üü¢ Online' : 'üî¥ Offline';
                        const lastSeen = machine.timeSinceLastSeen < 1 ? 'V·ª´a xong' : 
                                        `${machine.timeSinceLastSeen} ph√∫t tr∆∞·ªõc`;
                        
                        html += `
                            <div class="machine-card">
                                <div class="machine-header">
                                    <h3>${machine.hostname || 'Unknown'}</h3>
                                    <span class="status ${machine.isOnline ? 'online' : 'offline'}">${onlineStatus}</span>
                                </div>
                                <div class="machine-info">
                                    <p><strong>IP:</strong> ${machine.ipAddress}</p>
                                    <p><strong>Platform:</strong> ${machine.platform}</p>
                                    <p><strong>L·∫ßn cu·ªëi:</strong> ${lastSeen}</p>
                                    <p><strong>Truy c·∫≠p:</strong> ${machine.accessCount} l·∫ßn</p>
                                </div>
                                <div class="com-ports-section">
                                    <h4>COM Ports (${machine.comPorts.length})</h4>
                                    ${machine.comPorts.length === 0 ? 
                                        '<p class="no-ports">Kh√¥ng c√≥ COM ports</p>' :
                                        machine.comPorts.map(port => `
                                            <div class="port-item ${port.isAvailable ? 'available' : 'unavailable'}">
                                                <span class="port-path">${port.path}</span>
                                                <span class="port-manufacturer">${port.manufacturer}</span>
                                                <span class="port-confidence ${port.confidence}">${port.confidence}</span>
                                                ${port.isLikelyScanner ? '<span class="scanner-badge">üì± Scanner</span>' : ''}
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    machinesList.innerHTML = html;
                    
                } else {
                    machinesList.innerHTML = `<p class="error">L·ªói: ${result.message}</p>`;
                }
                
            } catch (error) {
                console.error('Error loading machines:', error);
                document.getElementById('machinesList').innerHTML = '<p class="error">L·ªói t·∫£i danh s√°ch m√°y</p>';
            }
        }

        // View machine details
        function viewMachineDetails(username) {
            const machine = allMachinesData.find(m => m.username === username);
            if (!machine) {
                showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin m√°y');
                return;
            }
            
            const details = `
M√°y t√≠nh: ${machine.machineInfo.hostname}
IP: ${machine.machineInfo.ipAddress}
Platform: ${machine.machineInfo.platform}
User: ${machine.username} (${machine.role})
Tr·∫°ng th√°i: ${new Date() - new Date(machine.machineInfo.lastSeen) < 5 * 60 * 1000 ? 'ONLINE' : 'OFFLINE'}
T·ªïng COM: ${machine.totalPorts}
Kh·∫£ d·ª•ng: ${machine.availablePorts}
ƒê√£ ph√¢n quy·ªÅn: ${machine.assignedPorts}

COM Ports:
${machine.comPorts.map(port => 
    `- ${port.path} (${port.manufacturer}) ${port.isAssigned ? 'üîí' : 'üîì'} ${port.isLikelyScanner ? 'üîç' : ''}`
).join('\n')}
            `;
            
            alert(details);
        }

        // Refresh machine
        async function refreshMachine(username) {
            showSuccess(`ƒêang refresh m√°y ${username}...`);
            // C√≥ th·ªÉ g·ª≠i signal ƒë·ªÉ client t·ª± refresh COM ports
            loadAllMachines();
        }

        // Change Password Modal Functions
        function showChangePasswordModal(accountId, username) {
            console.log('üîë Opening change password modal for:', username);
            
            // Remove existing modal if any to avoid duplicates
            const existingModal = document.getElementById('changePasswordModal');
            if (existingModal) {
                existingModal.remove();
                console.log('üóëÔ∏è Removed existing modal');
            }
            
            // Create new modal
            createChangePasswordModal();
            
            const modalElement = document.getElementById('changePasswordModal');
            if (modalElement) {
                modalElement.style.display = 'block';
                console.log('‚úÖ Modal displayed');
                
                // Set account info
                document.getElementById('changePasswordAccountId').value = accountId;
                document.getElementById('changePasswordUsername').textContent = username;
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                console.log('‚úÖ Modal data set for account:', username);
            } else {
                console.error('‚ùå Failed to create modal');
            }
        }

        function createChangePasswordModal() {
            const modal = document.createElement('div');
            modal.id = 'changePasswordModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ƒê·ªïi m·∫≠t kh·∫©u</h3>
                        <span class="close" onclick="closeChangePasswordModal()">&times;</span>
                    </div>
                    <form id="changePasswordForm">
                        <input type="hidden" id="changePasswordAccountId" value="">
                        <div class="form-group">
                            <label>T√†i kho·∫£n: <span id="changePasswordUsername"></span></label>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" id="newPassword" name="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required>
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="btn" onclick="closeChangePasswordModal()" style="margin-right: 10px;">H·ªßy</button>
                            <button type="submit" class="btn btn-success">ƒê·ªïi m·∫≠t kh·∫©u</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add form submit handler
            document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
                handleChangePassword(e);
            });
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.style.display = 'none';
                // Clear form data
                const form = document.getElementById('changePasswordForm');
                if (form) {
                    form.reset();
                }
                console.log('‚úÖ Change password modal closed');
            }
        }

        async function handleChangePassword(e) {
            e.preventDefault();
            console.log('üîë Change password form submitted');
            
            const accountId = document.getElementById('changePasswordAccountId').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            console.log('Account ID:', accountId);
            console.log('New password length:', newPassword.length);
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showError('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
                return;
            }
            
            // Validate password not empty
            if (!newPassword.trim()) {
                showError('M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!');
                return;
            }
            
            // Disable submit button to prevent double submission
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            
            try {
                console.log('üîÑ Sending change password request...');
                
                const response = await fetch('/api/admin/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        accountId: accountId,
                        newPassword: newPassword
                    })
                });
                
                console.log('üì° Response status:', response.status);
                
                const result = await response.json();
                console.log('üìÑ Response data:', result);
                
                if (result.success) {
                    console.log('‚úÖ Password changed successfully, closing modal...');
                    closeChangePasswordModal();
                    // Show success message to the user
                    try {
                        showSuccess(result.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
                    } catch(e) { console.warn('Could not show success alert', e); }
                    // Also show modal confirmation (optional)
                    try { showSuccessModal(result.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng'); } catch(e) {}
                    // Refresh accounts list to show updated info (run in background so failures don't overwrite the success message)
                    loadAccounts(false, true).catch(err => console.warn('Failed to refresh accounts after password change:', err));
                } else {
                    console.log('‚ùå Password change failed:', result.message);
                    showError(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                console.error('‚ùå Error changing password:', error);
                showError('L·ªói ƒë·ªïi m·∫≠t kh·∫©u: ' + error.message);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('changePasswordModal');
            if (event.target === modal) {
                closeChangePasswordModal();
            }
        });

        // Success Modal Functions
        function showSuccessModal(message) {
            let successModal = document.getElementById('successModal');
            if (!successModal) {
                successModal = document.createElement('div');
                successModal.id = 'successModal';
                successModal.className = 'success-modal';
                successModal.innerHTML = `
                    <div class="success-modal-content">
                        <div class="success-icon">‚úÖ</div>
                        <div class="success-message">${message}</div>
                        <div style="margin-top: 15px; font-size: 14px; color: #666;">
                            Modal s·∫Ω t·ª± ƒë·ªông ƒë√≥ng sau <span id="countdown">2</span> gi√¢y...
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
            } else {
                // Update message if modal already exists
                const messageElement = successModal.querySelector('.success-message');
                if (messageElement) {
                    messageElement.textContent = message;
                }
            }
            
            successModal.style.display = 'block';
            
            // Auto close after 2 seconds with countdown
            let countdown = 2;
            const countdownElement = document.getElementById('countdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    closeSuccessModal();
                }
            }, 1000);
        }

        function closeSuccessModal() {
            const successModal = document.getElementById('successModal');
            if (successModal) {
                successModal.style.display = 'none';
            }
        }

        // Close success modal when clicking outside
        window.addEventListener('click', function(event) {
            const successModal = document.getElementById('successModal');
            if (event.target === successModal) {
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>