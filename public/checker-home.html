<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm đơn gói hàng</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'">
    <script src="/serial-scanner.js"></script>
    <style>
        :root { --primary:#667eea; --accent:#764ba2; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0b1020; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 100%; margin: 0; background: #fff; border-radius: 0; box-shadow: none; padding: 0; overflow: hidden; min-height: 100vh; }
        .header { display: flex; align-items: center; justify-content: flex-start; gap: 12px; margin-bottom: 12px; }
        h1 { color: var(--primary); font-size: 22px; margin: 0; }
        .right { display: flex; align-items: center; gap: 8px; }
        .btn { padding: 14px 20px; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: #fff; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 700; }
        .btn.secondary { background: #edf2ff; color: #3b5bdb; }
        .btn.danger { background: #e83e8c; }
        .input { width: 420px; max-width: 100%; font-size: 18px; padding: 16px 18px; border: 2px solid #eaeaea; border-radius: 12px; outline: none; background:#fff; font-weight: 500; }
        .input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }
        .hint { color: #555; margin: 8px 0 0; font-size: 16px; font-weight: 500; }
        .status { margin-top: 14px; font-size: 18px; font-weight: 600; }
        .status.ok { color: var(--ok); }
        .status.warn { color: var(--warn); }
        .status.err { color: var(--err); }
        .meta { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .tag { background:#f3f4f6; color:#111827; border-radius: 8px; padding: 6px 10px; font-size: 13px; }
        .row { display: grid; grid-template-columns: 1fr 1fr 1.2fr 1.6fr 1fr 0.9fr 0.9fr; gap: 12px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f1f5f9; }
        .row.header { font-weight: 700; color: #334155; background: #f8fafc; border-radius: 8px; position: sticky; top: 0; z-index: 2; }
        .rows { margin-top: 12px; max-height: calc(100vh - 260px); overflow: auto; border: 1px solid #f1f5f9; border-radius: 10px; }
        .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
         .b-pending { background:#f8fafc; color:#475569; border: 2px solid #cbd5e1; font-weight: 600; }
         .b-progress { background:#fef3c7; color:#92400e; border: 2px solid #f59e0b; font-weight: 600; }
         .b-done { background:#d1fae5; color:#065f46; border: 2px solid #34d399; font-weight: 600; }
         .b-ready { background:#dbeafe; color:#1e40af; border: 2px solid #60a5fa; font-weight: 600; }
         .b-info { background:#e0f2fe; color:#0369a1; border: 2px solid #38bdf8; font-weight: 600; }
         .b-completed { background:#dcfce7; color:#166534; border: 2px solid #22c55e; font-weight: 700; box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2); }
         .b-processing { background:#fef3c7; color:#92400e; border: 2px solid #f59e0b; font-weight: 700; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .b-error { background:#fee2e2; color:#b91c1c; border: 1px solid #ef4444; }
        .row-done { background:#f0fdf4; }
        .row-progress { background:#fff7ed; }
         
         /* Row colors based on status */
         .row.status-pending { background:#fafbfc; border-left: 4px solid #d1d5db; }
         .row.status-processing { background:#fffbeb; border-left: 4px solid #f59e0b; }
         .row.status-completed { background:#f0fdf4; border-left: 4px solid #22c55e; }
         
         /* Hover effects for rows */
         .row:hover { background:#f8fafc; transition: background-color 0.2s ease; }
         .row.status-pending:hover { background:#f1f5f9; }
         .row.status-processing:hover { background:#fef3c7; }
         .row.status-completed:hover { background:#dcfce7; }
         
         /* Status indicator dots */
         .status-indicator {
             display: inline-block;
             width: 8px;
             height: 8px;
             border-radius: 50%;
             margin-right: 6px;
         }
         .status-indicator.pending { background: #9ca3af; }
         .status-indicator.processing { background: #f59e0b; }
         .status-indicator.completed { background: #22c55e; }
        .progress { margin-top: 10px; height: 10px; background:#f3f4f6; border-radius: 999px; overflow: hidden; }
        .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #34d399, #10b981); transition: width .25s ease; }
        .empty { text-align:center; color:#64748b; padding: 28px; }
        .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 80vh; }
        .sidebar { background:#0f172a; color:#cbd5e1; height: 100%; padding: 16px; }
        .sidebar .nav-btn { width: 100%; text-align: left; background: transparent; border: 1px solid rgba(148,163,184,.2); color:#e2e8f0; padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        .sidebar .nav-btn.active { background:#1e293b; border-color:#334155; }
        .sidebar .nav-btn:disabled { opacity: .5; cursor: not-allowed; }
        .content { padding: 20px 24px; }
        .flash { animation: flashBg 1200ms ease-out; }
        @keyframes flashBg { 0% { background:#ecfdf5; } 100% { background:transparent; } }
        .spinner { width:16px; height:16px; border:2px solid #e5e7eb; border-top-color:#6366f1; border-radius:50%; animation: spin .8s linear infinite; display:none; }
        .spinner.show { display:inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .banner { padding: 12px 14px; border-radius: 10px; margin: 10px 0; font-size: 14px; }
        .banner.warn { background:#fffbeb; color:#92400e; border:1px solid #f59e0b33; }
        .banner.err { background:#fef2f2; color:#991b1b; border:1px solid #ef444433; }
        .dropzone { border:2px dashed #475569; border-radius: 10px; padding: 18px; color:#e2e8f0; text-align:center; background:#0b1220; }
        .dropzone.drag { background:#0e1a31; border-color:#64748b; }
        .upload-actions { display:flex; gap:10px; margin-top:12px; justify-content:center; }
        .filename { margin-top: 10px; color:#e2e8f0; font-size: 14px; }
        .progress-line { margin-top: 12px; height: 10px; background:#1f2937; border-radius: 999px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #60a5fa, #34d399); transition: width .2s ease; }
        .toast { position: fixed; right: 16px; bottom: 16px; background: #111827; color:#e5e7eb; padding: 10px 14px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.25); display:none; }
        .toast.show { display:block; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 600px;
            width: 95%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            animation: modalSlideIn 0.3s ease-out forwards;
        }
        
        .modal.compact {
            padding: 40px;
            max-width: 500px;
        }
        
        .modal-icon {
            display: none !important;
        }
        
        .modal-icon.success { color: #22c55e; }
        .modal-icon.error { color: #ef4444; }
        .modal-icon.warning { color: #f59e0b; }
        .modal-icon.info { color: #3b82f6; }
        
        /* Modal background colors */
        .modal.success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 3px solid #22c55e;
            box-shadow: 0 20px 40px rgba(34, 197, 94, 0.2);
        }
        
        .modal.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 3px solid #ef4444;
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.2);
        }
        
        .modal.warning {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 3px solid #f59e0b;
            box-shadow: 0 20px 40px rgba(245, 158, 11, 0.2);
        }
        
        .modal.info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 3px solid #3b82f6;
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
        }
        
        .modal.question {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 3px solid #64748b;
            box-shadow: 0 20px 40px rgba(100, 116, 139, 0.2);
        }
        
        /* Modal animations */
        .modal {
            transition: all 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Pulse animation for success modal */
        .modal.success {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { transform: scale(0.9); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Shake animation for error modal */
        .modal.error {
            animation: errorShake 0.6s ease-out;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Bounce animation for warning modal */
        .modal.warning {
            animation: warningBounce 0.6s ease-out;
        }
        
        @keyframes warningBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .modal-title {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .modal-message {
            font-size: 1.5rem;
            color: #374151;
            line-height: 1.8;
            margin-bottom: 35px;
            font-weight: 500;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .modal-btn {
            padding: 18px 36px;
            border: none;
            border-radius: 15px;
            font-size: 1.4rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }
        
        .modal-btn.danger {
            background: #ef4444;
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-btn:active {
            transform: translateY(0);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        @media (max-width: 600px) {
            .modal {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .modal-icon {
                font-size: 3rem;
            }
            
            .modal-title {
                font-size: 1.5rem;
            }
            
            .modal-message {
                font-size: 1.1rem;
            }
            
            .modal-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .modal-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        .queue { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 0; }
        .qitem { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius: 999px; background:#eef2ff; color:#3730a3; border:2px solid #e5e7eb; font-weight: 600; font-size: 14px; }
        .qitem.active { background:#dbeafe; border-color:#3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
        .qitem.pending { background:#f3f4f6; color:#374151; border-color:#9ca3af; }
        .qitem.processing { background:#fef3c7; color:#92400e; border-color:#f59e0b; }
        .qitem.completed { background:#dcfce7; color:#166534; border-color:#22c55e; }
        .qtext { cursor:pointer; font-size: 16px; font-weight: 700; }
        .qbtn { cursor:pointer; color:#991b1b; background:#fee2e2; border:1px solid #fecaca; padding:2px 6px; border-radius: 8px; font-size: 12px; }
    </style>
    <script>
        // Lấy token cho tab hiện tại (ưu tiên auth_token, fallback checkerAuthToken)
        function getAuthToken() {
            return sessionStorage.getItem('auth_token') || sessionStorage.getItem('checkerAuthToken') || '';
        }

        // Hàm lưu user behaviour
        async function saveUserBehaviour(method, description, metadata = {}) {
            try {
                const response = await fetch('/api/user-behaviour', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: JSON.stringify({
                        method,
                        description,
                        metadata
                    })
                });
                
                const result = await response.json();
                if (!result.success) {
                }
            } catch (error) {
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="layout" id="layout">
            <div class="sidebar" id="sidebar">
                <div class="header" style="margin-bottom:12px;">
                    <h1 style="color:#e2e8f0;">Checker</h1>
                </div>
                <button id="viewBtn" class="nav-btn active">Xem đơn hàng</button>
                <button id="cancelledBtn" class="nav-btn">Xem đơn hủy</button>
                <button id="uploadBtn" class="nav-btn">Upload file</button>
                <button id="checkBtn" class="nav-btn">Check đơn</button>
                <div style="height:16px;"></div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <span class="tag" id="userTag">...</span>
                    <span class="tag" id="maVanDonTag">Chưa chọn</span>
                </div>
                <button id="logoutBtn" class="btn danger" style="margin-top:18px;">Đăng xuất</button>
            </div>
            <div class="content" id="content">
                <div id="metaWrap" class="meta">
                    <span id="progressText" style="font-size: 16px; font-weight: 600;">0/0 hoàn thành · 0/0 đã quét</span>
                    <div class="progress"><div class="bar" id="bar"></div></div>
                </div>
                <div id="queue" class="queue"></div>
                
                <!-- Scanner Info Section -->
                <div class="scanner-info" style="margin: 18px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <h4 style="margin-bottom: 10px; color: #495057; font-size: 16px;">🔧 Thông tin máy quét</h4>
                    <div id="scannerInfo" style="padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                        <div id="noScannerInfo" style="color: #666; text-align: center;">
                            <p>📋 Admin chưa phân quyền máy quét cho bạn</p>
                            <p style="font-size: 14px; margin-top: 5px;">Liên hệ admin để được phân quyền máy quét</p>
                        </div>
                        <div id="scannerDetails" style="display: none;">
                            <div style="margin-bottom: 10px;">
                                <strong>Máy quét được phép:</strong> <span id="allowedScanners"></span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Máy quét hiện tại:</strong> <span id="currentAssignedScanner"></span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>Cổng:</strong> <span id="assignedPort"></span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e9ecef;">
                                <button id="connectComBtn" class="btn" style="font-size: 14px; padding: 10px 16px; background: #2196f3;">
                                    🔌 Kết nối máy quét COM
                                </button>
                                <span id="comStatus" style="margin-left: 10px; font-weight: 600;"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="inputWrap" style="margin-top:18px;">
                    <input id="codeInput" class="input" placeholder="Nhập mã vận đơn hoặc mã hàng..." autocomplete="off" />
                    <span id="spin" class="spinner"></span>
                </div>
                <div id="status" class="status"></div>
                <div id="rows" class="rows"></div>
                <div id="uploadPanel" style="display:none;margin-top:18px;">
                    <div class="dropzone" id="dropzone">Kéo thả file Excel đơn hàng vào đây hoặc chọn file bên dưới</div>
                    <div class="upload-actions">
                        <input type="file" id="filePicker" accept=".xlsx,.xls" style="display:inline-block;" />
                        <button id="doUpload" class="btn">Upload đơn hàng</button>
                    </div>
                    <div id="fileName" class="filename"></div>
                    <div class="progress-line" style="display:none;width:100%;"><div class="progress-bar" id="uploadBar"></div></div>
                </div>
                <div id="uploadMasterPanel" style="display:none;margin-top:18px;">
                    <div class="dropzone" id="dropzoneMaster">Kéo thả file MasterData Excel vào đây hoặc chọn file bên dưới</div>
                    <div class="upload-actions">
                        <input type="file" id="fileMasterPicker" accept=".xlsx,.xls" style="display:inline-block;" />
                        <button id="doUploadMaster" class="btn">Upload MasterData</button>
                    </div>
                    <div id="fileMasterName" class="filename"></div>
                    <div class="progress-line" style="display:none;width:100%;"><div class="progress-bar" id="uploadMasterBar"></div></div>
                </div>
                <div id="uploadComboPanel" style="display:none;margin-top:18px;">
                    <div class="dropzone" id="dropzoneCombo">Kéo thả file ComboData Excel vào đây hoặc chọn file bên dưới</div>
                    <div class="upload-actions">
                        <input type="file" id="fileComboPicker" accept=".xlsx,.xls" style="display:inline-block;" />
                        <button id="doUploadCombo" class="btn">Upload ComboData</button>
                        <button id="fixComboData" class="btn secondary" style="margin-left:8px;">Fix ComboData</button>
                    </div>
                    <div id="fileComboName" class="filename"></div>
                    <div class="progress-line" style="display:none;width:100%;"><div class="progress-bar" id="uploadComboBar"></div></div>
                </div>
                
                <div id="toast" class="toast"></div>
            </div>
        </div>
        
        <!-- Modal Container -->
        <div id="modalOverlay" class="modal-overlay">
            <div id="modal" class="modal">
                <div id="modalIcon" class="modal-icon"></div>
                <div id="modalTitle" class="modal-title"></div>
                <div id="modalMessage" class="modal-message"></div>
                <div id="modalButtons" class="modal-buttons"></div>
            </div>
        </div>
    </div>
    <script>
        let currentMaVanDon = '';
let currentPage = 1;
let pageSize = 20;
        let cacheOrders = [];
        let isLoading = false;
        let activeView = 'view'; // 'view' | 'upload' | 'check'
        let userRole = 'checker';
        const queueMap = new Map(); // maVanDon -> { orders:[], completed:boolean }
        const queueList = []; // giữ thứ tự đơn đang xử lý
        
        // Trạng thái quy trình check đơn
        let orderCheckState = 'idle'; // 'idle', 'scanning', 'completed'
        let scannedItems = []; // Danh sách các mặt hàng đã quét
        let currentVanDonStatus = null; // Lưu trạng thái của maVanDon hiện tại
        let waitingForNewOrder = false; // Đang chờ input đơn mới (đơn hiện tại đã hoàn thành)
        let pollingInterval = null; // Interval cho polling định kỳ
        let lastPollingTime = 0; // Thời gian polling cuối cùng
        
        // ========== STATE MACHINE PATTERN ==========
        
        // Định nghĩa các trạng thái
        const CheckStates = {
            IDLE: 'idle',
            ORDER_ACTIVE: 'order_active',
            SCANNING: 'scanning',
            ORDER_COMPLETED: 'order_completed'
        };
        
        // Class State Machine cho Order Check
        class OrderCheckStateMachine {
            constructor() {
                this.state = CheckStates.IDLE;
                this.currentOrder = null;
                this.scannedItems = [];
                this.cacheOrders = [];
                this.isLoading = false;
            }
            
            // Kiểm tra input có hợp lệ không
            isValidInput(code) {
                return code && code.length >= 3;
            }
            
            // Kiểm tra xem code có vẻ như mã vận đơn không
            looksLikeVanDon(code) {
                const dashCount = (code.match(/-/g) || []).length;
                return dashCount === 0; // Không có dấu gạch ngang = mã đơn
            }
            
            // Phân loại input
            classifyInput(code) {
                if (!this.isValidInput(code)) {
                    return 'INVALID_INPUT';
                }
                
                const isVanDonCode = this.looksLikeVanDon(code);
                
                if (isVanDonCode) {
                    if (code === this.currentOrder?.maVanDon) {
                        // Quét lại đơn hiện tại = CHECK-IN lại (tiếp tục quét)
                        return 'CURRENT_ORDER_CHECKIN';
                    } else if (this.currentOrder) {
                        // Quét đơn khác = KHÔNG cho phép chuyển, yêu cầu hoàn thành đơn hiện tại
                        return 'DIFFERENT_ORDER_BLOCKED';
                    } else {
                        // Chưa có đơn nào = check-in đơn mới
                        return 'NEW_ORDER_CHECKIN';
                    }
                } else {
                    if (this.currentOrder) {
                        // Kiểm tra xem code có phải là mã hàng trong đơn hiện tại không
                        const isValidItem = this.isValidItemInCurrentOrder(code);
                        if (isValidItem) {
                            return 'ITEM_SCAN';
                        } else {
                            return 'INVALID_ITEM_FOR_ORDER';
                        }
                    } else {
                        return 'ITEM_WITHOUT_ORDER';
                    }
                }
            }
            
            // Kiểm tra mã hàng có hợp lệ trong đơn hiện tại không
            isValidItemInCurrentOrder(code) {
                if (!this.currentOrder || !this.cacheOrders.length) {
                    return false;
                }
                
                // Kiểm tra xem code có match với pattern mã hàng trong đơn không
                return this.cacheOrders.some(order => {
                    if (!order.maHang) return false;
                    
                    // Kiểm tra exact match trước
                    if (order.maHang === code) {
                        return true;
                    }
                    
                    // Kiểm tra combo item pattern
                    if (this.isComboItem(code, order.maHang)) {
                        return true;
                    }
                    
                    // Kiểm tra partial match (code có chứa maHang base)
                    const baseMaHang = order.maHang.split('-')[0]; // Lấy phần base
                    if (code.includes(baseMaHang) && code.includes('-')) {
                        return true;
                    }
                    
                    return false;
                });
            }
            
            // Kiểm tra xem có phải combo item không
            isComboItem(code, maHang) {
                // Logic kiểm tra combo item (có thể cần điều chỉnh theo yêu cầu cụ thể)
                if (!maHang || !code) return false;
                
                // Kiểm tra pattern combo: maHang-base + code-suffix
                const dashCount = (code.match(/-/g) || []).length;
                if (dashCount >= 2) {
                    // Có thể là combo item
                    return true;
                }
                
                return false;
            }
            
            // Kiểm tra đơn có hoàn thành không
            isOrderCompleted() {
                if (!this.currentOrder || !this.cacheOrders.length) return false;
                
                const totalRequired = this.cacheOrders.reduce((sum, order) => sum + order.soLuong, 0);
                const uniqueProducts = new Set(this.scannedItems.map(item => item.maHang));
                const totalScanned = Array.from(uniqueProducts).reduce((sum, maHang) => {
                    const scannedItemsForThisProduct = this.scannedItems.filter(item => item.maHang === maHang);
                    if (scannedItemsForThisProduct.length > 0) {
                        const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                        return sum + (latestItem.soLuongDaQuet || 0);
                    }
                    return sum;
                }, 0);
                
                return totalScanned >= totalRequired;
            }
            
            // Kiểm tra đơn có đang được quét không
            isOrderInProgress() {
                return this.state === CheckStates.SCANNING && this.scannedItems.length > 0;
            }
            
            // Xử lý input chính
            async handleInput(code) {
                if (this.isLoading) {
                    return;
                }
                
                try {
                    this.isLoading = true;
                    
                    // Kiểm tra nếu đang ở trạng thái IDLE (trang rỗng) và input là mã vận đơn
                    if (this.state === CheckStates.IDLE && this.looksLikeVanDon(code)) {
                        await this.checkinOrder(code);
                        return;
                    }
                    
                    const inputType = this.classifyInput(code);
                    
                    switch (inputType) {
                        case 'INVALID_INPUT':
                            this.showError('Input không hợp lệ. Vui lòng nhập lại.');
                            break;
                            
                        case 'ITEM_WITHOUT_ORDER':
                            this.showError('Chưa chọn mã vận đơn. Hãy nhập mã vận đơn trước.');
                            break;
                            
                        case 'INVALID_ITEM_FOR_ORDER':
                            this.showError(`Mã hàng "${code}" không thuộc đơn ${this.currentOrder.maVanDon}. Vui lòng quét mã hàng đúng hoặc quét đơn khác.`);
                            break;
                            
                        case 'DIFFERENT_ORDER_BLOCKED':
                            await this.handleDifferentOrderBlocked(code);
                            break;
                            
                        case 'CURRENT_ORDER_CHECKIN':
                            await this.handleCurrentOrderCheckin();
                            break;
                            
                        case 'NEW_ORDER_CHECKIN':
                            await this.checkinOrder(code);
                            break;
                            
                        case 'ITEM_SCAN':
                            await this.scanItem(code);
                            break;
                            
                        default:
                            this.showError('Loại input không được hỗ trợ.');
                    }
                    
                } catch (error) {
                    this.showError(error.message || 'Có lỗi xảy ra');
                } finally {
                    this.isLoading = false;
                    // Chỉ focus input nếu không có modal đang hiển thị
                    if (!document.getElementById('modalOverlay').classList.contains('show')) {
                        this.ensureInputFocus();
                    }
                }
            }
            
            // Xử lý quét lại đơn hiện tại
            async handleCurrentOrderCheckin() {
                // Đóng modal nếu đang hiển thị
                hideModal();
                
                // Kiểm tra trạng thái đơn hiện tại
                const isCompleted = this.isOrderCompleted();
                
                if (isCompleted) {
                    // Đơn đã hoàn thành - tự động hoàn thành đơn
                    await this.completeOrder();
                } else {
                    // Đơn chưa hoàn thành - tự động hủy đơn và hiển thị modal như cũ
                    await this.cancelOrder();
                }
            }



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































            
                        
            // Xử lý khi quét đơn khác (KHÔNG cho phép chuyển)
            async handleDifferentOrderBlocked(newMaVanDon) {
                // Hiển thị thông báo không cho phép chuyển đơn
                this.showWarning(
                    `Không thể chuyển sang đơn ${newMaVanDon}.`,
                    `Đang xử lý đơn ${this.currentOrder.maVanDon}. Vui lòng hoàn thành đơn hiện tại trước khi chuyển đơn khác.\n\nHướng dẫn:\n• Quét lại đơn ${this.currentOrder.maVanDon} để hoàn thành\n• Hoặc quét lại đơn ${this.currentOrder.maVanDon} để hủy`
                );
                
                // Focus lại input để tiếp tục quét mã hàng của đơn hiện tại
                this.ensureInputFocus();
            }
            
            // Xử lý đơn khác (checkout đơn hiện tại và checkin đơn mới) - KHÔNG CÒN SỬ DỤNG
            async handleDifferentOrder(newMaVanDon) {
                // Đóng modal nếu đang hiển thị
                hideModal();
                
                // Lưu thông tin đơn hiện tại
                const oldMaVanDon = this.currentOrder?.maVanDon;
                
                // 1. Kiểm tra xem đơn mới có tồn tại không trước khi rollback đơn cũ
                const response = await fetch(`/api/orders/by-van-don/${encodeURIComponent(newMaVanDon)}`, {
                    credentials: 'include',
                    headers: { 'Authorization': 'Bearer ' + getAuthToken() }
                });
                const result = await response.json();
                
                if (!result.success) {
                    // Nếu đơn mới không tồn tại, không rollback đơn cũ - chỉ hiển thị lỗi và giữ nguyên trạng thái
                    if (result.message && result.message.includes('Không tìm thấy đơn hàng với mã vận đơn này')) {
                        this.showError(`Không tìm thấy đơn hàng với mã vận đơn ${newMaVanDon}. Tiếp tục quét đơn hiện tại ${oldMaVanDon}.`);
                        return;
                    }
                    // Các lỗi khác (ví dụ: đơn đã hoàn thành)
                    if (result.message && result.message.includes('đã được quét hoàn tất')) {
                        this.showWarning(`Đơn ${newMaVanDon} đã được quét hoàn tất. Tiếp tục quét đơn hiện tại ${oldMaVanDon}.`);
                        return;
                    }
                    // Lỗi khác
                    this.showError(`Lỗi tải đơn ${newMaVanDon}: ${result.message}. Tiếp tục quét đơn hiện tại ${oldMaVanDon}.`);
                    return;
                }
                
                // 2. Nếu đơn mới tồn tại, rollback đơn hiện tại (checkout)
                try {
                    await this.rollbackCurrentOrder();
                } catch (error) {
                    // Ignore rollback errors
                }
                
                // 3. Reset state
                this.reset();
                
                // 4. Check-in đơn mới
                await this.checkinOrder(newMaVanDon);
            }
            
            // Hiển thị modal xác nhận chuyển đơn (không còn sử dụng)
            async showSwitchConfirmation(newMaVanDon) {
                // Logic này không còn sử dụng vì chỉ cho phép chuyển đơn sau checkout
                this.showError('Vui lòng checkout đơn hiện tại trước khi chuyển đơn khác.');
            }
            
            // Chuyển sang đơn mới (sau khi checkout)
            async switchToNewOrder(newMaVanDon) {
                try {
                    // Check-in đơn mới (đã checkout rồi nên không cần rollback)
                    await this.checkinOrder(newMaVanDon);
                    
                } catch (error) {
                    throw new Error(`Lỗi chuyển đơn: ${error.message}`);
                }
            }
            
            // Rollback đơn hiện tại
            async rollbackCurrentOrder() {
                try {
                    if (!this.currentOrder) return;
                    
                    const maVanDon = this.currentOrder.maVanDon;
                    
                    // Unblock đơn trên server
                    await fetch('/api/orders/unblock-van-don', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({ maVanDon })
                    });
                    
                } catch (error) {
                    // Không throw error vì rollback không phải lỗi nghiêm trọng
                }
            }
            
            // Check-in đơn hàng
            async checkinOrder(maVanDon) {
                try {
                    
                    // Load đơn hàng từ server
                    const response = await fetch(`/api/orders/by-van-don/${encodeURIComponent(maVanDon)}`, {
                        credentials: 'include',
                        headers: { 'Authorization': 'Bearer ' + getAuthToken() }
                    });
                    const result = await response.json();
                    
                    if (!result.success) {
                        // Kiểm tra nếu đơn đã hoàn thành
                        if (result.message && result.message.includes('đã được quét hoàn tất')) {
                            this.showWarning(`Đơn ${maVanDon} đã được quét hoàn tất. Vui lòng chọn đơn khác.`);
                            return;
                        }
                        
                        // Kiểm tra nếu không tìm thấy đơn hàng - không rollback, chỉ hiển thị lỗi
                        if (result.message && result.message.includes('Không tìm thấy đơn hàng với mã vận đơn này')) {
                            this.showError(`Không tìm thấy đơn hàng với mã vận đơn ${maVanDon}. Vui lòng kiểm tra lại mã vận đơn.`);
                            return;
                        }
                        
                        throw new Error(result.message || 'Không thể tải đơn hàng');
                    }
                    
                    // Cập nhật state
                    this.currentOrder = { maVanDon, ...result.data };
                    this.cacheOrders = result.data.orders || [];
                    this.scannedItems = [];
                    this.state = CheckStates.ORDER_ACTIVE;
                    
                    // Cập nhật UI
                    this.updateUI();
                    
                    // Hiển thị thông báo ngắn gọn
                    const verifiedCount = result.data.alreadyVerifiedItems?.length || 0;
                    this.showInfo(`Đã check-in ${this.cacheOrders.length} mặt hàng cho đơn ${maVanDon}. Bắt đầu quét hàng.`);
                    
                    // Lưu user behaviour
                    await this.saveUserBehaviour('scanner', `Check-in đơn hàng: ${maVanDon} - ${this.cacheOrders.length} mặt hàng`, {
                        maVanDon: maVanDon,
                        orderCount: this.cacheOrders.length,
                        verifiedItemsCount: verifiedCount,
                        action: 'checkin_order'
                    });
                    
                    // Đảm bảo reset loading state sau khi hoàn thành
                    this.isLoading = false;
                    
                } catch (error) {
                    // Đảm bảo reset loading state khi có lỗi
                    this.isLoading = false;
                    
                    // Kiểm tra nếu lỗi là "Không tìm thấy đơn hàng với mã vận đơn này" - không rollback, chỉ hiển thị lỗi
                    if (error.message && error.message.includes('Không tìm thấy đơn hàng với mã vận đơn này')) {
                        this.showError(`Không tìm thấy đơn hàng với mã vận đơn ${maVanDon}. Vui lòng kiểm tra lại mã vận đơn.`);
                        return;
                    }
                    
                    throw new Error(`Lỗi check-in đơn: ${error.message}`);
                }
            }
            
            // Check-out đơn hàng (hiển thị modal xác nhận)
            async handleCheckout() {
                
                const uniqueProducts = new Set(this.scannedItems.map(item => item.maHang));
                const scannedCount = Array.from(uniqueProducts).reduce((sum, maHang) => {
                    const scannedItemsForThisProduct = this.scannedItems.filter(item => item.maHang === maHang);
                    if (scannedItemsForThisProduct.length > 0) {
                        const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                        return sum + (latestItem.soLuongDaQuet || 0);
                    }
                    return sum;
                }, 0);
                const totalRequired = this.cacheOrders.reduce((sum, order) => sum + order.soLuong, 0);
                const isCompleted = scannedCount >= totalRequired;
                
                this.showModal({
                    type: 'info',
                    title: 'Check-out đơn hàng',
                    message: `Đơn ${this.currentOrder.maVanDon} đã quét ${scannedCount}/${totalRequired} mã hàng${isCompleted ? ' (Hoàn thành)' : ' (Chưa hoàn thành)'}.\n\nHướng dẫn:\n• Quét đơn khác để chuyển đơn\n• Nhấn Enter để xác nhận checkout`,
                    buttons: [
                        {
                            text: 'Xác nhận checkout',
                            class: 'primary',
                            onclick: () => {
                                this.reset();
                                this.showInfo(`Đã checkout đơn ${this.currentOrder?.maVanDon || 'hiện tại'}. Sẵn sàng quét đơn mới.`);
                            }
                        }
                    ]
                });
            }
            
            // Quét mã hàng
            async scanItem(maHang) {
                try {
                    
                    const response = await fetch('/api/orders/scan', {
                        credentials: 'include',
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({ 
                            maVanDon: this.currentOrder.maVanDon, 
                            maHang 
                        })
                    });
                    const result = await response.json();
                    
                    if (!result.success) {
                        // Kiểm tra nếu không tìm thấy đơn hàng - không rollback, chỉ hiển thị lỗi và tiếp tục quét
                        if (result.message && result.message.includes('Không tìm thấy đơn hàng với mã vận đơn này')) {
                            this.showError(`Không tìm thấy đơn hàng với mã vận đơn ${this.currentOrder.maVanDon}. Vui lòng kiểm tra lại mã vận đơn.`);
                            // Không throw error để không rollback, giữ nguyên trạng thái đơn hiện tại
                            this.isLoading = false;
                            return;
                        }
                        
                        throw new Error(result.message || 'Quét không thành công');
                    }
                    
                    // Thêm vào danh sách đã quét
                    this.scannedItems.push({
                        maHang: result.data.maHang,
                        timestamp: new Date(),
                        soLuongDaQuet: result.data.soLuongDaQuet,
                        soLuongYeuCau: result.data.soLuongYeuCau
                    });
                    
                    // Cập nhật UI ngay lập tức
                    this.updateUI();
                    
                    // Hiển thị thông báo quét thành công
                    const progress = result.data.progress;
                    const progressText = progress ? `${progress.scannedItems}/${progress.totalItems}` : `${result.data.soLuongDaQuet}/${result.data.soLuongYeuCau}`;
                    this.showInfo(` Đã quét: ${result.data.maHang} (${progressText})`);
                    
                    // Lưu user behaviour
                    await this.saveUserBehaviour('scanner', `Quét mã hàng: ${result.data.maHang} - Tiến độ: ${result.data.soLuongDaQuet}/${result.data.soLuongYeuCau}`, {
                        maVanDon: this.currentOrder.maVanDon,
                        maHang: result.data.maHang,
                        originalMaHang: result.data.originalMaHang,
                        scannedQuantity: result.data.soLuongDaQuet,
                        requiredQuantity: result.data.soLuongYeuCau,
                        verified: result.data.verified,
                        isCombo: result.data.isCombo,
                        action: 'scan_item'
                    });
                    
                    // Kiểm tra đơn có hoàn thành không
                    if (result.data.progress && result.data.progress.isCompleted) {
                        this.state = CheckStates.ORDER_COMPLETED;
                        await this.showCompletionModal();
                    } else {
                        this.state = CheckStates.SCANNING;
                        // Tự động tiếp tục quét, không hiển thị modal
                        this.showInfo(`Tiếp tục quét đơn ${this.currentOrder.maVanDon}`);
                    }
                    
                    // Đảm bảo reset loading state sau khi hoàn thành
                    this.isLoading = false;
                    
                } catch (error) {
                    // Kiểm tra nếu lỗi là "Không tìm thấy đơn hàng với mã vận đơn này" - không rollback, chỉ hiển thị lỗi
                    if (error.message && error.message.includes('Không tìm thấy đơn hàng với mã vận đơn này')) {
                        this.showError(`Không tìm thấy đơn hàng với mã vận đơn ${this.currentOrder.maVanDon}. Tiếp tục quét đơn hiện tại.`);
                        this.isLoading = false;
                        return;
                    }
                    
                    // Các lỗi khác - hiển thị lỗi nhưng không rollback đơn hiện tại
                    this.showError(`Lỗi quét mã hàng: ${error.message}. Tiếp tục quét đơn hiện tại ${this.currentOrder.maVanDon}.`);
                    this.isLoading = false;
                }
            }
            
            // Hiển thị modal hoàn thành đơn (tự động hoàn thành)
            async showCompletionModal() {
                // Tự động hoàn thành đơn thay vì hiển thị modal
                try {
                    await this.completeOrder();
                } catch (error) {
                    this.showError(`Lỗi hoàn thành đơn: ${error.message}`);
                }
                
                return Promise.resolve();
            }
            
            // Hiển thị modal tiếp tục quét (không còn sử dụng)
            async showContinueModal() {
                // Không còn sử dụng modal này, tự động tiếp tục quét
                return Promise.resolve();
            }
            
            // Hủy đơn hàng
            async cancelOrder() {
                try {
                    const orderToCancel = this.currentOrder.maVanDon;
                    
                    // Lưu UserBehaviour trước khi rollback
                    await this.saveUserBehaviour('scanner', `Hủy đơn ${orderToCancel}`, {
                        maVanDon: orderToCancel,
                        action: 'cancel_order',
                        missingItems: checkMissingItems()
                    });
                    
                    // Rollback đơn trên server
                    await this.rollbackCurrentOrder();
                    
                    // Reset state
                    this.reset();
                    
                    // Hiển thị modal thông báo hủy đơn
                    this.showModal({
                        type: 'warning',
                        title: 'Đã hủy đơn hàng',
                        message: `Đơn ${orderToCancel} đã được hủy thành công.\n\nSẵn sàng quét đơn mới.`,
                        timeout: 2000
                    });
                    
                    // Sau 2 giây, về trang check đơn rỗng
                    setTimeout(() => {
                        this.showInfo('Sẵn sàng quét đơn mới');
                    }, 2000);
                    
                } catch (error) {
                    this.showError(`Lỗi hủy đơn: ${error.message}`);
                }
            }
            
            // Hoàn thành đơn hàng
            async completeOrder() {
                try {
                    const response = await fetch('/api/orders/complete-van-don', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({
                            maVanDon: this.currentOrder.maVanDon
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const completedOrder = this.currentOrder.maVanDon;
                        
                        // Reset state trước
                        this.reset();
                        
                        // Hiển thị modal thông báo hoàn thành
                        this.showModal({
                            type: 'success',
                            title: 'Đơn hàng hoàn tất',
                            message: `Đơn ${completedOrder} đã được quét hoàn tất thành công.\n\nSẵn sàng quét đơn mới.`,
                            timeout: 2000
                        });
                        
                        // Sau 2 giây, về trang check đơn rỗng
                        setTimeout(() => {
                            this.showInfo('Sẵn sàng quét đơn mới');
                        }, 2000);
                        
                    } else {
                        throw new Error(result.message);
                    }
                    
                } catch (error) {
                    throw new Error(`Lỗi hoàn thành đơn: ${error.message}`);
                }
            }
            
            // Reset state machine
            reset() {
                // Unblock đơn hiện tại nếu có
                if (this.currentOrder) {
                    this.rollbackCurrentOrder().catch(error => {
                        // Ignore rollback errors during reset
                    });
                }
                
                // Reset state
                this.state = CheckStates.IDLE;
                this.currentOrder = null;
                this.scannedItems = [];
                this.cacheOrders = [];
                
                // Cập nhật UI
                this.updateUI();
                
                // Đảm bảo input được focus để sẵn sàng quét tiếp
                this.ensureInputFocus();
            }
            
            // Cập nhật UI
            updateUI() {
                // Cập nhật currentMaVanDon global
                currentMaVanDon = this.currentOrder?.maVanDon || '';
                cacheOrders = this.cacheOrders;
                scannedItems = [...this.scannedItems]; // Copy array để đồng bộ
                orderCheckState = this.state;
                
                // Cập nhật DOM
                document.getElementById('maVanDonTag').textContent = currentMaVanDon || 'Chưa chọn';
                renderQueue();
                renderOrders();
                updateProgress();
            }
            
            // Hiển thị lỗi
            showError(message) {
                setStatus(message, 'err');
                this.showModal({
                    type: 'error',
                    title: 'Lỗi',
                    message: message,
                    buttons: [{
                        text: 'OK',
                        class: 'primary',
                        onclick: () => this.ensureInputFocus()
                    }]
                });
            }
            
            // Hiển thị cảnh báo
            showWarning(message) {
                setStatus(message, 'warn');
                this.showModal({
                    type: 'warning',
                    title: 'Cảnh báo',
                    message: message,
                    timeout: 3000
                });
            }
            
            // Hiển thị thông tin
            showInfo(message) {
                setStatus(message, 'info');
                // Không hiển thị modal cho thông tin, chỉ update status
                // Auto hide sau 3 giây
                setTimeout(() => {
                    setStatus('', '');
                }, 3000);
            }
            
            // Hiển thị thành công
            showSuccess(title, message) {
                setStatus(message, 'ok');
                this.showModal({
                    type: 'success',
                    title: title,
                    message: message,
                    timeout: 2000
                });
            }
            
            // Hiển thị modal
            showModal(options) {
                // Implementation sẽ sử dụng hàm showModal hiện có
                showModal(options);
            }
            
            // Đảm bảo input được focus
            ensureInputFocus() {
                const input = document.getElementById('codeInput');
                if (input) {
                    input.value = '';
                    input.focus();
                    input.click();
                    
                    // Thêm visual feedback
                    input.style.borderColor = '#667eea';
                    setTimeout(() => {
                        input.style.borderColor = '';
                    }, 1000);
                }
            }
            
            // Lưu user behaviour
            async saveUserBehaviour(method, description, metadata = {}) {
                try {
                    const response = await fetch('/api/user-behaviour', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({
                            method,
                            description,
                            metadata
                        })
                    });
                    
                    const result = await response.json();
                    if (!result.success) {
                    }
                } catch (error) {
                }
            }
        }
        
        // Khởi tạo State Machine
        const orderCheckSM = new OrderCheckStateMachine();
        
        // Hàm kiểm tra thiếu hàng
        function checkMissingItems() {
            const missingItems = [];
            const currentScannedItems = orderCheckSM.scannedItems || scannedItems;
            cacheOrders.forEach(order => {
                const scannedItemsForThisProduct = currentScannedItems.filter(item => item.maHang === order.maHang);
                let scannedQty = 0;
                
                if (scannedItemsForThisProduct.length > 0) {
                    const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                    scannedQty = latestItem.soLuongDaQuet || 0;
                }
                
                if (scannedQty < order.soLuong) {
                    missingItems.push({
                        maHang: order.maHang,
                        soLuongYeuCau: order.soLuong,
                        soLuongDaQuet: scannedQty,
                        soLuongThieu: order.soLuong - scannedQty
                    });
                }
            });
            return missingItems;
        }
        
        // Hàm hiển thị modal thiếu hàng
        function showMissingItemsModal(missingItems) {
            let message = 'Đơn hàng bị thiếu các mặt hàng sau:\n\n';
            missingItems.forEach(item => {
                message += `• Mã hàng: ${item.maHang}\n`;
                message += `  Yêu cầu: ${item.soLuongYeuCau}\n`;
                message += `  Đã quét: ${item.soLuongDaQuet}\n`;
                message += `  Thiếu: ${item.soLuongThieu}\n\n`;
            });
            message += 'Chọn hành động tiếp theo:';
            
            showModal({
                type: 'warning',
                title: 'Đơn hàng bị thiếu hàng',
                message: message,
                buttons: [
                    {
                        text: 'Quét lại đơn',
                        class: 'primary',
                        onclick: () => {
                            orderCheckState = 'scanning';
                            scannedItems = [];
                            setStatus('Đã reset. Hãy quét lại mã vận đơn để tiếp tục.', 'ok');
                            ensureInputFocus();
                        }
                    },
                    {
                        text: 'Quét đơn khác',
                        class: 'secondary',
                        onclick: () => {
                            orderCheckState = 'idle';
                            scannedItems = [];
                            currentMaVanDon = '';
                            cacheOrders = [];
                            currentVanDonStatus = null;
                            waitingForNewOrder = false;
                            document.getElementById('maVanDonTag').textContent = 'Chưa chọn';
                            setStatus('Đã hủy đơn hiện tại. Hãy nhập mã vận đơn mới.', 'info');
                            ensureInputFocus();
                            renderQueue();
                            renderOrders();
                        }
                    }
                ]
            });
        }

        async function ensureChecker() {
            // Robust check that tolerates browser cookie timing and per-tab JWT races.
            // Strategy:
            // 1) Try cookie+Authorization (if token present).
            // 2) If that fails and a token exists, try token-only.
            // 3) Retry with exponential backoff (both cookie+token and token-only) for a short window.
            // 4) Before final redirect, give a last short wait to allow Set-Cookie to apply in the browser.
            try {
                let data = null;
                const tryOnce = async (useCredentials, token) => {
                    const headers = {};
                    if (token) headers['Authorization'] = 'Bearer ' + token;
                    try {
                        const res = await fetch('/api/me', useCredentials ? { credentials: 'include', headers } : { headers });
                        return await res.json();
                    } catch (e) {
                        return null;
                    }
                };

                const token = getAuthToken();
                // 1) Immediate attempt: credentials + token (if any)
                data = await tryOnce(true, token);

                // 2) If that didn't work and we have a token, try token-only immediately
                if ((!data || !data.success) && token) {
                    const tdata = await tryOnce(false, token);
                    if (tdata && tdata.success) data = tdata;
                }

                // 3) Retry loop with exponential backoff (total ~1s)
                const backoffs = [150, 200, 300, 400]; // ms
                for (let i = 0; (!data || !data.success) && i < backoffs.length; i++) {
                    await new Promise(r => setTimeout(r, backoffs[i]));
                    const tkn = getAuthToken();
                    // prefer cookie+Authorization first
                    const d1 = await tryOnce(true, tkn);
                    if (d1 && d1.success) { data = d1; break; }
                    // then try token-only
                    if (tkn) {
                        const d2 = await tryOnce(false, tkn);
                        if (d2 && d2.success) { data = d2; break; }
                    }
                }

                // 4) Final short wait to let browser apply Set-Cookie (helps some browsers)
                if (!data || !data.success) {
                    await new Promise(r => setTimeout(r, 120));
                    const finalToken = getAuthToken();
                    const finalTry = await tryOnce(true, finalToken);
                    if (finalTry && finalTry.success) data = finalTry;
                    else if (finalToken) {
                        const finalTry2 = await tryOnce(false, finalToken);
                        if (finalTry2 && finalTry2.success) data = finalTry2;
                    }
                }

                if (!data || !data.success || !['checker','packer'].includes(data.role)) {
                    // No auth -> show overlay and redirect
                    showForbiddenOverlay();
                    setTimeout(() => { location.href = '/login'; }, 2200);
                    return false;
                }

                userRole = data.role;
                const roleName = data.role === 'packer' ? 'packer' : 'checker';
                document.getElementById('userTag').textContent = data.username + ' (' + roleName + ')';
                const titleRole = data.role === 'packer' ? 'Packer' : 'Checker';
                document.title = titleRole + ' - Một trang duy nhất';
                const h1 = document.querySelector('h1');
                if (h1) h1.textContent = titleRole;
                return true;
            } catch (e) {
                // In case of unexpected failure, redirect to login (safe fallback)
                try { console && console.error && console.error('ensureChecker error', e); } catch(e){}
                location.href = '/login';
                return false;
            }
        }

        function setStatus(text, type = '') {
            const el = document.getElementById('status');
            el.className = 'status ' + (type || '');
            el.textContent = text || '';
        }

        // Modal functions
        function showModal(options) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('modal');
            const icon = document.getElementById('modalIcon');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const buttons = document.getElementById('modalButtons');
            
            if (!overlay || !modal) {
                return;
            }
            
            // Remove all color classes first
            modal.classList.remove('success', 'error', 'warning', 'info', 'question');
            
            // Add the appropriate color class based on type
            if (options.type) {
                modal.classList.add(options.type);
            }
            
            // Luôn ẩn icon
            icon.style.display = 'none';
            
            // Set title
            title.textContent = options.title || '';
            
            // Set message
            message.textContent = options.message || '';
            
            // Set buttons (ẩn nút nếu có timeout - tự động đóng)
            buttons.innerHTML = '';
            if (options.timeout) {
                buttons.style.display = 'none';
            } else {
                buttons.style.display = 'flex';
                if (options.buttons) {
                    options.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.textContent = btn.text;
                        button.className = `modal-btn ${btn.class || 'primary'}`;
                        button.onclick = () => {
                            if (btn.onclick) {
                                btn.onclick();
                            }
                            hideModal();
                        };
                        buttons.appendChild(button);
                    });
                } else {
                    // Default OK button
                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'OK';
                    okBtn.className = 'modal-btn primary';
                    okBtn.onclick = hideModal;
                    buttons.appendChild(okBtn);
                }
            }
            
            // Add compact class if has timeout (no icon, no buttons)
            const modalElement = overlay.querySelector('.modal');
            if (options.timeout) {
                modalElement.classList.add('compact');
            } else {
                modalElement.classList.remove('compact');
            }
            
            // Show modal
            overlay.classList.add('show');
            
            // Auto hide after timeout if specified
            if (options.timeout) {
                setTimeout(hideModal, options.timeout);
            }
        }
        
        function hideModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.classList.remove('show');
            // Đảm bảo input được focus sau khi đóng modal
            setTimeout(ensureInputFocus, 100);
        }

        // Function đảm bảo input luôn được focus
        function ensureInputFocus() {
            const input = document.getElementById('codeInput');
            if (input) {
                // Clear value trước khi focus
                input.value = '';
                // Focus và click để đảm bảo sẵn sàng nhận input
                input.focus();
                input.click();
                // Đảm bảo cursor ở cuối input
                setTimeout(() => {
                    input.setSelectionRange(0, 0);
                }, 10);
            }
        }


        
        // Convenience functions for different modal types
        function showSuccessModal(title, message, timeout = null) {
            showModal({
                type: 'success',
                title: title,
                message: message,
                timeout: timeout
            });
        }
        
        function showErrorModal(title, message) {
            showModal({
                type: 'error',
                title: title,
                message: message
            });
        }
        
        function showWarningModal(title, message) {
            showModal({
                type: 'warning',
                title: title,
                message: message
            });
        }
        
        function showConfirmModal(title, message, onConfirm, onCancel = null) {
            showModal({
                type: 'question',
                title: title,
                message: message,
                buttons: [
                    {
                        text: 'Hủy',
                        class: 'secondary',
                        onclick: onCancel
                    },
                    {
                        text: 'Xác nhận',
                        class: 'danger',
                        onclick: onConfirm
                    }
                ]
            });
        }
        
        // Close modal when clicking overlay
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                hideModal();
            }
        });

        function renderQueue() {
            const el = document.getElementById('queue');
            if (!el) return;
            el.innerHTML = '';
            
            // Chỉ hiển thị đơn hiện tại (không còn queue nữa)
            if (currentMaVanDon) {
                const currentScannedItems = orderCheckSM.scannedItems || scannedItems;
                const uniqueProducts = new Set(currentScannedItems.map(item => item.maHang));
                const scannedCount = Array.from(uniqueProducts).reduce((sum, maHang) => {
                    const scannedItemsForThisProduct = currentScannedItems.filter(item => item.maHang === maHang);
                    if (scannedItemsForThisProduct.length > 0) {
                        const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                        return sum + (latestItem.soLuongDaQuet || 0);
                    }
                    return sum;
                }, 0);
                const totalRequired = cacheOrders.reduce((sum, order) => sum + order.soLuong, 0);
                const isDone = orderCheckState === 'completed';
                // const isConfirming = orderCheckState === 'confirming'; // Không còn cần thiết
                
                const item = document.createElement('span');
                let statusClass = 'pending';
                let statusText = '';
                
                // Kiểm tra trạng thái quét
                if (orderCheckState === 'scanning') {
                    statusClass = 'processing';
                    statusText = ' (Đang xử lý)';
                } else if (orderCheckState === 'completed') {
                    statusClass = 'completed';
                    statusText = ' (Hoàn thành)';
                } else {
                    statusClass = 'pending';
                    statusText = ' (Chưa xử lý)';
                }
                
                item.className = `qitem ${statusClass} active`;
                const text = document.createElement('span');
                text.className = 'qtext';
                text.textContent = `${currentMaVanDon} (${scannedCount}/${totalRequired})${statusText}`;
                text.onclick = () => {
                    let statusMsg = '';
                    if (orderCheckState === 'completed') {
                        statusMsg = `Đơn ${currentMaVanDon} đã hoàn thành`;
                    } else if (orderCheckState === 'scanning') {
                        statusMsg = `Đang xử lý đơn ${currentMaVanDon}`;
                    } else {
                        statusMsg = `Đơn ${currentMaVanDon} chưa xử lý`;
                    }
                    setStatus(statusMsg, '');
                };
                const btn = document.createElement('button');
                btn.className = 'qbtn';
                btn.textContent = 'Hủy';
                btn.title = 'Hủy đơn hiện tại (mở khóa)';
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    try {
                        // Lưu UserBehaviour trước khi hủy đơn
                        const missingItems = checkMissingItems();
                        await fetch('/api/user-behaviour', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAuthToken() },
                            body: JSON.stringify({
                                method: 'scanner',
                                description: `Hủy đơn ${currentMaVanDon}`,
                                metadata: {
                                    maVanDon: currentMaVanDon,
                                    action: 'cancel_order',
                                    missingItems: missingItems
                                }
                            })
                        });
                        
                        await fetch('/api/orders/unblock-van-don', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAuthToken() },
                            body: JSON.stringify({ maVanDon: currentMaVanDon })
                        });
                        
                        // Tự động refresh nếu đang ở chế độ view
                        autoRefreshIfInViewMode();
                    } catch {}
                    
                    // Reset về trạng thái ban đầu
                    const oldMaVanDon = currentMaVanDon;
                    currentMaVanDon = '';
                    cacheOrders = [];
                    orderCheckState = 'idle';
                    scannedItems = [];
                    currentVanDonStatus = null;
                    document.getElementById('maVanDonTag').textContent = 'Chưa chọn';
                    renderQueue();
                    renderOrders();
                    setStatus(`Đã hủy đơn ${oldMaVanDon}`, 'ok');
                    ensureInputFocus();
                };
                item.appendChild(text);
                item.appendChild(btn);
                el.appendChild(item);
            }
        }

        function renderOrders() {
            const body = document.getElementById('rows');
            body.innerHTML = '';
            // Header
            const header = document.createElement('div');
            header.className = 'row header';
            header.style.display = 'flex';
            header.style.fontSize = '18px';
            header.innerHTML = `
                <div style="flex:0 0 48px;min-width:40px;text-align:center;font-weight:600;padding:8px 4px;">STT</div>
                <div style="flex:0 0 160px;min-width:120px;font-weight:600;padding:8px 8px;">Mã vận đơn</div>
                <div style="flex:0 0 130px;min-width:100px;font-weight:600;padding:8px 8px;">Mã hàng</div>
                <div style="flex:0 0 56px;min-width:40px;text-align:center;font-weight:600;padding:8px 4px;">SL</div>
                <div style="flex:0 0 120px;min-width:80px;font-weight:600;padding:8px 8px;">Mẫu Vải</div>
                <div style="flex:1 1 320px;min-width:180px;font-weight:600;padding:8px 12px;">Tên phiên bản sản phẩm</div>
                <div style="flex:0 0 120px;min-width:80px;font-weight:600;padding:8px 8px;">Trạng thái</div>
            `;
            body.appendChild(header);
            if (!cacheOrders.length) {
                body.innerHTML += '<div class="empty">Không có dữ liệu để hiển thị.</div>';
                updateProgress();
                return;
            }
            // Phân trang
            const totalPages = Math.ceil(cacheOrders.length / pageSize);
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, cacheOrders.length);
            for (let i = startIdx; i < endIdx; i++) {
                const o = cacheOrders[i];
                const r = document.createElement('div');
                const status = getStatus(o);
                
                // Áp dụng màu sắc cho hàng dựa trên trạng thái
                let rowClass = 'row';
                if (status.badge === 'b-completed') {
                    rowClass += ' status-completed';
                } else if (status.badge === 'b-processing') {
                    rowClass += ' status-processing';
                } else {
                    rowClass += ' status-pending';
                }
                
                r.className = rowClass;
                r.style.display = 'flex';
                r.style.fontSize = '17px';
                r.innerHTML = `
                    <div style="flex:0 0 48px;min-width:40px;text-align:center;padding:8px 4px;">${o.stt}</div>
                    <div style="flex:0 0 160px;min-width:120px;padding:8px 8px;">${escapeHtml(o.maVanDon)}</div>
                    <div style="flex:0 0 130px;min-width:100px;padding:8px 8px;">${escapeHtml(o.maHang)}</div>
                    <div style="flex:0 0 56px;min-width:40px;text-align:center;padding:8px 4px;">${o.soLuong}</div>
                    <div style="flex:0 0 120px;min-width:80px;padding:8px 8px;">${escapeHtml(o.mauVai)}</div>
                    <div style="flex:1 1 320px;min-width:180px;padding:8px 12px;">${escapeHtml(o.tenPhienBan)}</div>
                    <div style="flex:0 0 120px;min-width:80px;padding:8px 8px;">
                        <span class="badge ${status.badge}" title="${status.tooltip || status.text}">
                            <span class="status-indicator ${status.badge.replace('b-', '')}"></span>
                            ${status.text}
                        </span>
                    </div>
                `;
                body.appendChild(r);
            }
            // Nút chuyển trang cố định
            // Xóa pager cố định nếu có
            const oldPager = document.getElementById('fixed-pager');
            if (oldPager) oldPager.remove();

            // Tạo thanh phân trang ngay dưới bảng
            if (totalPages > 1) {
                const pager = document.createElement('div');
                pager.id = 'order-pager';
                pager.style.display = 'flex';
                pager.style.justifyContent = 'center';
                pager.style.gap = '12px';
                pager.style.margin = '18px 0 0 0';
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '← Trang trước';
                prevBtn.className = 'btn';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => { currentPage--; renderOrders(); };
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Trang sau →';
                nextBtn.className = 'btn';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => { currentPage++; renderOrders(); };
                const info = document.createElement('span');
                info.textContent = `Trang ${currentPage} / ${totalPages}`;
                info.style.fontWeight = 'bold';
                info.style.fontSize = '16px';
                pager.appendChild(prevBtn);
                pager.appendChild(info);
                pager.appendChild(nextBtn);
                body.appendChild(pager);
            }
// Ẩn hoàn toàn thanh phân trang khi chuyển sang chức năng khác ngoài Xem đơn hàng
window.hideOrderPager = function() {
    const pager = document.getElementById('fixed-pager');
    if (pager) pager.style.display = 'none';
}

// Ẩn thanh phân trang khi chuyển sang chức năng khác
window.showOrderPager = function(show) {
    const pager = document.getElementById('fixed-pager');
    if (pager) pager.style.visibility = show ? 'visible' : 'hidden';
}
// Gọi showOrderPager(false) khi chuyển sang chức năng khác ngoài Xem đơn hàng
            updateProgress();
        }

        function getStatus(o) {
            // Nếu đang ở chế độ view (xem đơn), hiển thị trạng thái theo logic mới
            if (activeView === 'view') {
                return getOrderStatus(o);
            }
            
            // Nếu đang ở chế độ check, hiển thị tiến độ quét chi tiết
            const currentScannedItems = orderCheckSM.scannedItems || scannedItems;
            const scannedItemsForThisProduct = currentScannedItems.filter(item => item.maHang === o.maHang);
            
            let scanned = 0;
            if (scannedItemsForThisProduct.length > 0) {
                // Lấy soLuongDaQuet từ item mới nhất (backend trả về tổng số đã quét)
                const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                scanned = latestItem.soLuongDaQuet || 0;
            } else {
                // Fallback: sử dụng scannedQuantity từ cacheOrders nếu có
                scanned = o.scannedQuantity || 0;
            }
            const required = o.soLuong;
            
            // Xác định trạng thái và màu sắc dựa trên tiến độ quét
            if (scanned === 0) {
                // Chưa quét gì
                return { 
                    text: `0/${required}`, 
                    badge: 'b-pending',
                    tooltip: 'Chưa quét'
                };
            } else if (scanned < required) {
                // Đang quét một phần
                return { 
                    text: `${scanned}/${required}`, 
                    badge: 'b-progress',
                    tooltip: `Đang quét (còn thiếu ${required - scanned})`
                };
            } else if (scanned >= required) {
                // Đã quét đủ hoặc thừa
                return { 
                    text: `${scanned}/${required}`, 
                    badge: 'b-done',
                    tooltip: scanned > required ? `Đã quét đủ (thừa ${scanned - required})` : 'Đã quét đủ'
                };
            }
            
            // Fallback
            return { text: `${scanned}/${required}`, badge: 'b-info' };
        }
        
        function getOrderStatus(o) {
            // Logic trạng thái đơn hàng dựa trên trạng thái của toàn bộ maVanDon:
            // [Chưa xử lý]: maVanDon chưa hoàn thành và không có block
            // [Đang xử lý]: maVanDon chưa hoàn thành và có block  
            // [Hoàn thành]: maVanDon đã hoàn thành (tất cả maHang đã verified = true)
            
            // Kiểm tra trạng thái của toàn bộ maVanDon
            const vanDonOrders = cacheOrders.filter(order => order.maVanDon === o.maVanDon);
            const totalItems = vanDonOrders.length;
            const completedItems = vanDonOrders.filter(order => order.verified).length;
            const isVanDonCompleted = totalItems > 0 && totalItems === completedItems;
            
            if (isVanDonCompleted) {
                return { text: 'Hoàn thành', badge: 'b-completed' };
            } else if (o.block && !isVanDonCompleted) {
                return { text: 'Đang xử lý', badge: 'b-processing' };
            } else {
                return { text: 'Chưa xử lý', badge: 'b-pending' };
            }
        }

        // Hàm load dữ liệu đơn hủy từ UserBehaviour
        async function loadCancelledOrders() {
            try {
                setStatus('Đang tải danh sách đơn hủy...', 'info');
                
                // Gọi API để lấy user behaviour với action "Hủy đơn"
                const response = await fetch('/api/user-behaviour?method=scanner&limit=500', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Lỗi khi tải dữ liệu');
                }
                
                // Lọc các behaviour có chứa "Hủy đơn" trong description
                const behaviours = result.data?.behaviours || result.data || [];
                const cancelledBehaviours = behaviours.filter(behaviour => 
                    behaviour.description && behaviour.description.includes('Hủy đơn')
                );
                
                // Chuyển đổi dữ liệu để hiển thị
                const cancelledOrders = cancelledBehaviours.map(behaviour => {
                    // Parse thông tin từ description
                    const description = behaviour.description;
                    const maVanDonMatch = description.match(/đơn\s+([A-Z0-9]+)/i);
                    const maVanDon = maVanDonMatch ? maVanDonMatch[1] : 'N/A';
                    
                    // Parse số lượng hàng thiếu từ metadata hoặc description
                    let missingQuantity = 0;
                    if (behaviour.metadata && behaviour.metadata.missingItems) {
                        missingQuantity = behaviour.metadata.missingItems.reduce((sum, item) => sum + (item.soLuongThieu || 0), 0);
                    } else {
                        // Fallback: parse từ description
                        const missingMatch = description.match(/thiếu\s+(\d+)/i);
                        if (missingMatch) {
                            missingQuantity = parseInt(missingMatch[1]);
                        }
                    }
                    
                    return {
                        id: behaviour._id,
                        maVanDon: maVanDon,
                        user: behaviour.user,
                        time: new Date(behaviour.time),
                        description: description,
                        missingQuantity: missingQuantity,
                        metadata: behaviour.metadata || {}
                    };
                });
                
                // Cập nhật cacheOrders để hiển thị
                cacheOrders = cancelledOrders;
                
                // Render danh sách đơn hủy
                renderCancelledOrders();
                updateProgress();
                
                setStatus(`Đã tải ${cancelledOrders.length} đơn hủy`, 'success');
                
            } catch (error) {
                console.error('Lỗi load đơn hủy:', error);
                setStatus('Lỗi khi tải danh sách đơn hủy: ' + error.message, 'err');
                cacheOrders = [];
                renderCancelledOrders();
            }
        }
        
        // Hàm render danh sách đơn hủy
        function renderCancelledOrders() {
            const body = document.getElementById('rows');
            body.innerHTML = '';
            
            // Header cho đơn hủy
            const header = document.createElement('div');
            header.className = 'row header';
            header.style.display = 'flex';
            header.style.fontSize = '18px';
            header.innerHTML = `
                <div style="flex:0 0 160px;min-width:120px;font-weight:600;padding:8px 8px;">Mã vận đơn</div>
                <div style="flex:0 0 120px;min-width:100px;font-weight:600;padding:8px 8px;">User hủy</div>
                <div style="flex:0 0 150px;min-width:120px;font-weight:600;padding:8px 8px;">Thời gian hủy</div>
                <div style="flex:0 0 100px;min-width:80px;font-weight:600;padding:8px 8px;">Hàng thiếu</div>
                <div style="flex:1 1 400px;min-width:200px;font-weight:600;padding:8px 12px;">Mô tả</div>
            `;
            body.appendChild(header);
            
            if (!cacheOrders.length) {
                body.innerHTML += '<div class="empty">Không có đơn hủy nào.</div>';
                updateProgress();
                return;
            }
            
            // Hiển thị danh sách đơn hủy (không phân trang)
            cacheOrders.forEach((order, index) => {
                const r = document.createElement('div');
                r.className = 'row status-pending';
                r.style.display = 'flex';
                r.style.fontSize = '17px';
                r.innerHTML = `
                    <div style="flex:0 0 160px;min-width:120px;padding:8px 8px;font-weight:600;">${escapeHtml(order.maVanDon)}</div>
                    <div style="flex:0 0 120px;min-width:100px;padding:8px 8px;">${escapeHtml(order.user)}</div>
                    <div style="flex:0 0 150px;min-width:120px;padding:8px 8px;">${order.time.toLocaleString('vi-VN')}</div>
                    <div style="flex:0 0 100px;min-width:80px;padding:8px 8px;text-align:center;color:#dc2626;font-weight:600;">${order.missingQuantity}</div>
                    <div style="flex:1 1 400px;min-width:200px;padding:8px 12px;">${escapeHtml(order.description)}</div>
                `;
                body.appendChild(r);
            });
            
            updateProgress();
        }

        function updateProgress() {
            const total = cacheOrders.length;
            
            let scanned = 0;
            let completed = 0;
            let inProgress = 0;
            
            // Nếu đang ở chế độ check (scanning), tính từ scannedItems
            if (activeView === 'check' && orderCheckSM.scannedItems) {
                const currentScannedItems = orderCheckSM.scannedItems || scannedItems;
                
                // Tính tổng số lượng đã quét
                const uniqueProducts = new Set(currentScannedItems.map(item => item.maHang));
                scanned = Array.from(uniqueProducts).reduce((sum, maHang) => {
                    const scannedItemsForThisProduct = currentScannedItems.filter(item => item.maHang === maHang);
                    if (scannedItemsForThisProduct.length > 0) {
                        const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                        return sum + (latestItem.soLuongDaQuet || 0);
                    }
                    return sum;
                }, 0);
                
                // Tính số sản phẩm đã quét đủ và đang quét
                cacheOrders.forEach(order => {
                    const scannedItemsForThisProduct = currentScannedItems.filter(item => item.maHang === order.maHang);
                    let scannedCount = 0;
                    
                    if (scannedItemsForThisProduct.length > 0) {
                        // Lấy soLuongDaQuet từ item mới nhất
                        const latestItem = scannedItemsForThisProduct[scannedItemsForThisProduct.length - 1];
                        scannedCount = latestItem.soLuongDaQuet || 0;
                    }
                    
                    if (scannedCount >= order.soLuong) {
                        completed++;
                    } else if (scannedCount > 0) {
                        inProgress++;
                    }
                });
            } else {
                // Nếu đang ở chế độ view, tính từ cacheOrders (verified từ DB)
                completed = cacheOrders.filter(x => x.verified).length;
                scanned = cacheOrders.reduce((sum, order) => {
                    return sum + (order.scannedQuantity || 0);
                }, 0);
            }
            
            const required = cacheOrders.reduce((s, x) => s + x.soLuong, 0);
            
            // Tính phần trăm dựa trên số sản phẩm đã hoàn thành
            const percent = total ? Math.round((completed / total) * 100) : 0;
            
            // Hiển thị thông tin chi tiết hơn
            let progressText = '';
            if (activeView === 'cancelled') {
                // Đơn hủy: hiển thị tổng số đơn hủy
                const totalMissing = cacheOrders.reduce((sum, order) => sum + (order.missingQuantity || 0), 0);
                progressText = `${total} đơn hủy · ${totalMissing} hàng thiếu`;
            } else if (activeView === 'check') {
                progressText = `${completed}/${total} hoàn thành · ${scanned}/${required} đã quét`;
                if (inProgress > 0) {
                    progressText += ` · ${inProgress} đang quét`;
                }
            } else {
                progressText = `${completed}/${total} hoàn thành · ${scanned}/${required} đã quét`;
            }
            
            document.getElementById('progressText').textContent = progressText;
            document.getElementById('bar').style.width = percent + '%';
        }

        // Hàm load dữ liệu real-time từ database cho chế độ view
        async function loadAllOrdersFromDB(showStatus = true) {
            try {
                if (showStatus) {
                    setStatus('Đang tải dữ liệu real-time...', '');
                }
                const response = await fetch('/api/orders', {
                    credentials: 'include',
                    headers: { 'Authorization': 'Bearer ' + getAuthToken() }
                });
                const result = await response.json();
                
                if (result.success && result.data && result.data.orders) {
                    const oldOrdersCount = cacheOrders.length;
                    const newOrders = result.data.orders;
                    
                    // Kiểm tra xem có thay đổi không
                    const hasChanges = oldOrdersCount !== newOrders.length || 
                                     JSON.stringify(cacheOrders.map(o => ({ id: o._id, verified: o.verified, block: o.block }))) !== 
                                     JSON.stringify(newOrders.map(o => ({ id: o._id, verified: o.verified, block: o.block })));
                    
                    cacheOrders = newOrders;
                    renderOrders();
                    
                    if (hasChanges) {
                        
                        if (showStatus) {
                            setStatus(`Đã cập nhật ${cacheOrders.length} đơn hàng từ database (real-time)`, 'ok');
                        }
                    } else if (showStatus) {
                        setStatus(`Đã tải ${cacheOrders.length} đơn hàng từ database (real-time)`, 'ok');
                    }
                } else {
                    if (showStatus) {
                        setStatus('Không thể tải dữ liệu từ database', 'err');
                    ensureInputFocus();
                    }
                    console.error('Lỗi load dữ liệu:', result.message);
                }
            } catch (error) {
                if (showStatus) {
                    setStatus('Lỗi kết nối database: ' + error.message, 'err');
                    ensureInputFocus();
                }
                console.error('Lỗi kết nối:', error);
            }
        }

        // Hàm tự động refresh khi có thao tác trên database (chỉ khi ở chế độ view)
        function autoRefreshIfInViewMode() {
            if (activeView === 'view') {
                lastPollingTime = Date.now();
                loadAllOrdersFromDB();
            }
        }

        // Hàm bắt đầu polling định kỳ để phát hiện thay đổi từ nhân viên khác
        function startPolling() {
            stopPolling();
            pollingInterval = setInterval(() => {
                if (activeView === 'view') {
                    const now = Date.now();
                    // Chỉ polling nếu đã qua ít nhất 3 giây từ lần polling cuối
                    if (now - lastPollingTime >= 3000) {
                        lastPollingTime = now;
                        loadAllOrdersFromDB(false);
                    } else {
                    }
                }
            }, 5000);
        }

        // Hàm dừng polling
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }


        // Hàm kiểm tra xem code có vẻ như mã vận đơn không
        function looksLikeVanDon(code) {
            const dashCount = (code.match(/-/g) || []).length;
            return dashCount === 0;
        }

        // Hàm kiểm tra input có hợp lệ không
        function isValidInput(code) {
            // Kiểm tra độ dài tối thiểu
            if (!code || code.length < 3) return false;
            
            // Kiểm tra ký tự đặc biệt không hợp lệ
            const invalidChars = /[<>:"/\\|?*]/;
            if (invalidChars.test(code)) return false;
            
            // Kiểm tra chỉ chứa khoảng trắng
            if (code.trim().length === 0) return false;
            
            return true;
        }

        // ========== STATE MACHINE HANDLER ==========

        async function handleEnter(value) {
            const code = value.trim();
            
            if (!code) {
                    return;
                }
                    
            // Đóng modal nếu đang hiển thị
                                        hideModal();
            
            // Chỉ sử dụng State Machine khi ở chế độ check
            const shouldUseStateMachine = (activeView === 'check' || userRole === 'packer');
            
            try {
                if (shouldUseStateMachine) {
                    // Sử dụng State Machine Pattern
                    await orderCheckSM.handleInput(code);
                            } else {
                    await handleEnterLegacy(code);
                            }
                        } catch (error) {
                setStatus(`Lỗi xử lý input: ${error.message}`, 'err');
            }
        }
        
        // Logic cũ cho các chế độ không phải check
        async function handleEnterLegacy(code) {
            if (isLoading) return;
            
            // Kiểm tra input có hợp lệ không
            if (!isValidInput(code)) {
                setStatus('Input không hợp lệ. Vui lòng nhập lại.', 'err');
                        ensureInputFocus();
                        return;
                    }
                    
            isLoading = true;
            try {
                // Logic cũ cho view mode - chỉ hiển thị thông báo
                setStatus('Chế độ view - không hỗ trợ quét', 'warn');
                        ensureInputFocus();
            } catch (e) {
                setStatus(e.message || 'Có lỗi xảy ra', 'err');
                ensureInputFocus();
            } finally {
                isLoading = false;
            }
        }

        async function reloadCurrentVanDon() {
            if (!currentMaVanDon) return;
            const res = await fetch(`/api/orders/by-van-don/${encodeURIComponent(currentMaVanDon)}`, {
                credentials: 'include',
                headers: { 'Authorization': 'Bearer ' + getAuthToken() }
            });
            const data = await res.json();
            if (data.success) {
                cacheOrders = data.data.orders || [];
            }
        }

        async function loadAllOrders() {
            try {
                const token = typeof getAuthToken === 'function' ? getAuthToken() : (sessionStorage.getItem('jwt') || '');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                const res = await fetch('/api/orders?limit=1000', { credentials: 'include', headers });
                const data = await res.json();
                if (data.success && data.data && data.data.orders) {
                    cacheOrders = data.data.orders;
                    renderOrders();
                }
            } catch (e) {
                // ignore
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function resetPage() {
            if (currentMaVanDon) {
                try {
                    await fetch('/api/orders/unblock-van-don', {
                        credentials: 'include',
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({ maVanDon: currentMaVanDon })
                    });
                } catch {}
            }
            currentMaVanDon = '';
            cacheOrders = [];
            document.getElementById('maVanDonTag').textContent = 'Chưa chọn';
            setStatus('Đã hủy khóa đơn hiện tại. Nhập mã vận đơn mới.', '');
            renderOrders();
            ensureInputFocus();
        }

        window.addEventListener('beforeunload', async () => {
            // Dừng polling
            stopPolling();
            
            // Unblock đơn hàng nếu có
            if (currentMaVanDon) {
                try {
                    navigator.sendBeacon && navigator.sendBeacon('/api/orders/unblock-van-don', new Blob([JSON.stringify({ maVanDon: currentMaVanDon })], { type: 'application/json' }));
                } catch {}
            }
        });

        // Hàm unlock đơn hiện tại với error handling
        async function unlockCurrentOrder(maVanDonToUnlock = null) {
            const orderToUnlock = maVanDonToUnlock || currentMaVanDon;
            
            if (!orderToUnlock) {
                return false;
            }
            
            try {
                
                const response = await fetch('/api/orders/unblock-van-don', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: JSON.stringify({ maVanDon: orderToUnlock })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    setStatus(`Đã mở khóa đơn ${orderToUnlock}`, 'ok');
                    return true;
                } else {
                    setStatus(`Lỗi mở khóa đơn ${orderToUnlock}: ${result.message}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('[UNLOCK] Error unlocking order:', error);
                setStatus(`Lỗi mở khóa đơn ${orderToUnlock}: ${error.message}`, 'error');
                return false;
            }
        }

        async function switchView(view) {
            // Nếu đang ở chế độ check và chuyển sang view khác, unlock đơn hiện tại
            if (activeView === 'check' && view !== 'check' && currentMaVanDon) {
                // Lưu lại currentMaVanDon trước khi reset
                const currentOrderToUnlock = currentMaVanDon;
                
                // Reset trạng thái đơn hiện tại
                currentMaVanDon = '';
                cacheOrders = [];
                currentVanDonStatus = null;
                orderCheckState = 'idle';
                scannedItems = [];
                waitingForNewOrder = false;
                document.getElementById('maVanDonTag').textContent = 'Chưa chọn';
                
                // Reset State Machine
                if (orderCheckSM) {
                    orderCheckSM.reset();
                }
                
                // Unlock đơn trên server
                await unlockCurrentOrder(currentOrderToUnlock);
                
                // Cập nhật giao diện
                renderQueue();
                renderOrders();
            }
            
            activeView = view;
            if (userRole === 'checker') {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.getElementById(view + 'Btn');
                if (activeBtn) activeBtn.classList.add('active');
                
                // Dừng polling nếu không ở chế độ view
                if (view !== 'view') {
                    stopPolling();
                }
            }
            const input = document.getElementById('codeInput');
            const spin = document.getElementById('spin');
            const uploadPanel = document.getElementById('uploadPanel');
            const uploadMasterPanel = document.getElementById('uploadMasterPanel');
            const uploadComboPanel = document.getElementById('uploadComboPanel');
            const rows = document.getElementById('rows');
            const inputWrap = document.getElementById('inputWrap');
            const metaWrap = document.getElementById('metaWrap');
            if (view === 'upload') {
                uploadPanel.style.display = '';
                uploadMasterPanel.style.display = '';
                uploadComboPanel.style.display = '';
                rows.style.display = 'none';
                inputWrap.style.display = 'none';
                metaWrap.style.display = 'none';
            } else if (view === 'check') {
                // Only input + result
                uploadPanel.style.display = 'none';
                uploadMasterPanel.style.display = 'none';
                uploadComboPanel.style.display = 'none';
                rows.style.display = '';
                inputWrap.style.display = '';
                metaWrap.style.display = '';
                // đảm bảo danh sách đang hiển thị đúng theo đơn đang hoạt động
                if (currentMaVanDon && queueMap.has(currentMaVanDon)) {
                    const info = queueMap.get(currentMaVanDon);
                    cacheOrders = info.orders || [];
                }
                
                // Đảm bảo State Machine được khôi phục đúng cách
                if (orderCheckSM && !orderCheckSM.currentOrder && currentMaVanDon) {
                    // Nếu có đơn hiện tại nhưng State Machine chưa có, khôi phục State Machine
                    orderCheckSM.currentOrder = { maVanDon: currentMaVanDon };
                    orderCheckSM.cacheOrders = cacheOrders || [];
                    orderCheckSM.state = orderCheckState === 'idle' ? orderCheckSM.CheckStates.IDLE : orderCheckSM.CheckStates.ORDER_ACTIVE;
                    orderCheckSM.updateUI();
                }
                
                input.placeholder = currentMaVanDon ? 'Nhập mã hàng rồi nhấn Enter' : 'Nhập mã vận đơn rồi nhấn Enter';
                setStatus(currentMaVanDon ? 'Nhập mã hàng để quét.' : 'Nhập mã vận đơn để tải đơn và khóa đơn.', '');
            } else if (view === 'cancelled') {
                // cancelled: hiển thị danh sách đơn hủy
                uploadPanel.style.display = 'none';
                uploadMasterPanel.style.display = 'none';
                uploadComboPanel.style.display = 'none';
                rows.style.display = '';
                inputWrap.style.display = 'none';
                metaWrap.style.display = '';
                // Load dữ liệu đơn hủy
                loadCancelledOrders();
                setStatus('', '');
            } else {
                // view: only list all orders - load real-time data from database
                uploadPanel.style.display = 'none';
                uploadMasterPanel.style.display = 'none';
                uploadComboPanel.style.display = 'none';
                rows.style.display = '';
                inputWrap.style.display = 'none';
                metaWrap.style.display = '';
                // Load dữ liệu real-time từ database
                loadAllOrdersFromDB();
                setStatus('', '');
                // Ensure list shows all
                loadAllOrders();
                // Bắt đầu polling để phát hiện thay đổi từ nhân viên khác
                startPolling();
            }
            ensureInputFocus();
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Diagnostic overlay for login/token issues
            function showDiagnostics(token, meResult, error) {
                let diag = document.getElementById('diagnosticOverlay');
                if (!diag) {
                    diag = document.createElement('div');
                    diag.id = 'diagnosticOverlay';
                    diag.style.position = 'fixed';
                    diag.style.top = '10px';
                    diag.style.right = '10px';
                    diag.style.zIndex = '9999';
                    diag.style.background = '#fff';
                    diag.style.border = '2px solid #667eea';
                    diag.style.borderRadius = '10px';
                    diag.style.padding = '14px 18px';
                    diag.style.fontSize = '13px';
                    diag.style.color = '#222';
                    diag.style.boxShadow = '0 2px 12px #667eea33';
                    diag.style.maxWidth = '420px';
                    diag.style.wordBreak = 'break-all';
                    document.body.appendChild(diag);
                }
                diag.innerHTML = `<b>Diagnostic:</b><br>
                    <b>Token:</b> <span style='color:#764ba2'>${token ? token : '(none)'}</span><br>
                    <b>/api/me:</b> <span style='color:#22c55e'>${meResult ? JSON.stringify(meResult) : '(no response)'}</span><br>
                    <b>Last error:</b> <span style='color:#ef4444'>${error ? error : '(none)'}</span><br>
                    <button style='margin-top:8px;padding:4px 10px;border-radius:6px;background:#667eea;color:#fff;border:none;cursor:pointer;' onclick='this.parentElement.style.display="none"'>Ẩn overlay</button>`;
            }

            // Run diagnostics before ensureChecker
            let diagToken = getAuthToken();
            let diagMe = null;
            let diagErr = null;
            try {
                const headers = diagToken ? { 'Authorization': 'Bearer ' + diagToken } : {};
                const res = await fetch('/api/me', { credentials: 'include', headers });
                diagMe = await res.json();
            } catch (e) { diagErr = e.message; }
            showDiagnostics(diagToken, diagMe, diagErr);

            const ok = await ensureChecker();
            if (!ok) return;
            // PACKER: ẩn sidebar, không cần chọn chức năng
            if (userRole === 'packer') {
                const sidebar = document.getElementById('sidebar');
                const layout = document.getElementById('layout');
                if (sidebar) sidebar.style.display = 'none';
                if (layout) layout.style.gridTemplateColumns = '1fr';
                const hint = document.getElementById('hint');
                if (hint) hint.textContent = '- Nhập mã vận đơn (Enter) để tải đơn, sau đó nhập mã hàng để quét. Mọi thao tác trong 1 ô nhập.';
                // Thêm nút logout cho packer nếu chưa có
                let logoutPacker = document.getElementById('logoutBtnPacker');
                if (!logoutPacker) {
                    logoutPacker = document.createElement('button');
                    logoutPacker.id = 'logoutBtnPacker';
                    logoutPacker.textContent = 'Đăng xuất';
                    logoutPacker.className = 'btn danger';
                    logoutPacker.style.margin = '18px 0';
                    document.body.appendChild(logoutPacker);
                }
                logoutPacker.style.display = '';
                logoutPacker.onclick = async () => {
                    showConfirmModal(
                        'Xác nhận đăng xuất',
                        'Bạn có chắc chắn muốn đăng xuất?\nĐơn hàng hiện tại sẽ được mở khóa.',
                        async () => {
                            try {
                                // Gửi yêu cầu mở khóa cho đơn hiện tại
                                if (currentMaVanDon) {
                                    await fetch('/api/orders/unblock-van-don', {
                                method: 'POST',
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAuthToken() },
                                        body: JSON.stringify({ maVanDon: currentMaVanDon })
                                    });
                                }
                        } catch {}
                        await fetch('/api/logout', { method: 'POST', credentials: 'include', headers: { 'Authorization': 'Bearer ' + getAuthToken() } });
                        sessionStorage.removeItem('auth_token');
                        sessionStorage.removeItem('checkerAuthToken');
                        location.href = '/login';
                    }
                    );
                };
            }
            const input = document.getElementById('codeInput');
            ensureInputFocus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const val = input.value;
                    input.value = '';
                    
                    // Lưu user behaviour cho việc input
                    saveUserBehaviour('keyboard', `Input: ${val}`, {
                        input: val,
                        action: 'enter_key',
                        timestamp: new Date().toISOString()
                    });
                    
                    handleEnter(val);
                }
            });
            // Vào trang: checker -> Xem đơn hàng; packer -> Check đơn (một chức năng duy nhất)
            if (userRole === 'checker') {
                await switchView('view');
            } else {
                await switchView('check');
            }
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.addEventListener('click', resetPage);
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                showConfirmModal(
                    'Xác nhận đăng xuất',
                    'Bạn có chắc chắn muốn đăng xuất?\nĐơn hàng hiện tại sẽ được mở khóa.',
                    async () => {
                        try {
                            // Gửi yêu cầu mở khóa cho đơn hiện tại
                            if (currentMaVanDon) {
                                await fetch('/api/orders/unblock-van-don', {
                                method: 'POST',
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAuthToken() },
                                    body: JSON.stringify({ maVanDon: currentMaVanDon })
                                });
                            }
                    } catch {}
                        
                        // Ngắt kết nối COM port nếu đang kết nối
                        if (currentComPort) {
                            try {
                                
                                // Xóa bản ghi port cụ thể
                                try {
                                    await fetch('/api/delete-port', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ comPort: currentComPort })
                                    });
                                } catch (error) {
                                }
                                
                                // Đóng COM port
                                if (currentPort) {
                                    await currentPort.close();
                                }
                                
                                // Stop heartbeat
                                stopHeartbeat();
                                
                                // Reset trạng thái
                                isComConnected = false;
                                currentComPort = null;
                                currentPort = null;
                                isListening = false;
                                
                            } catch (error) {
                            }
                        }
                        
                        // Xóa hoàn toàn tất cả bản ghi port của user hiện tại (fallback)
                        try {
                            const currentUser = getCurrentUsername();
                            if (currentUser) {
                                // Gọi API để xóa hoàn toàn tất cả bản ghi port của user hiện tại
                                const response = await fetch('/api/delete-all-user-ports', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId: currentUser })
                                });
                                const result = await response.json();
                            }
                        } catch (error) {
                            console.error('[LOGOUT] Lỗi xóa tất cả bản ghi port:', error);
                        }
                        
                        // Reset trạng thái
                        orderCheckState = 'idle';
                        scannedItems = [];
                        currentVanDonStatus = null;
                        waitingForNewOrder = false;
                    await fetch('/api/logout', { method: 'POST', credentials: 'include', headers: { 'Authorization': 'Bearer ' + getAuthToken() } });
                    location.href = '/login';
                }
                );
            });
            if (userRole === 'checker') {
                // Đảm bảo các nút chức năng luôn hoạt động
                const uploadBtn = document.getElementById('uploadBtn');
                const checkBtn = document.getElementById('checkBtn');
                const viewBtn = document.getElementById('viewBtn');
                const filePicker = document.getElementById('filePicker');
                const drop = document.getElementById('dropzone');
                const fileNameEl = document.getElementById('fileName');
                const progressBar = document.getElementById('uploadBar');
                const toast = document.getElementById('toast');
                // Upload MasterData
                const fileMasterPicker = document.getElementById('fileMasterPicker');
                const fileMasterName = document.getElementById('fileMasterName');
                const uploadMasterBar = document.getElementById('uploadMasterBar');
                const doUploadMaster = document.getElementById('doUploadMaster');
                
                // Upload ComboData
                const fileComboPicker = document.getElementById('fileComboPicker');
                const fileComboName = document.getElementById('fileComboName');
                const uploadComboBar = document.getElementById('uploadComboBar');
                const doUploadCombo = document.getElementById('doUploadCombo');
                const fixComboData = document.getElementById('fixComboData');
                function showToast(msg, ok) {
                    toast.textContent = msg;
                    toast.style.background = ok ? '#065f46' : '#7f1d1d';
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 2500);
                }
                function setProgress(pct) { progressBar.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
                async function uploadFileWithProgress(file) {
                    const form = new FormData();
                    form.append('file', file);
                    let token = '';
                    if (typeof getAuthToken === 'function') token = getAuthToken();
                    else if (sessionStorage.getItem('jwt')) token = sessionStorage.getItem('jwt');
                    try {
                        const res = await fetch('/api/checker/upload', {
                            method: 'POST',
                            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                            body: form
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(()=>({message:'Lỗi server'}));
                            throw new Error(err.message || 'Upload thất bại');
                        }
                        return await res.json();
                    } catch (e) {
                        return { success: false, message: 'Lỗi upload: ' + (e.message || e) };
                    }
                }
                viewBtn.addEventListener('click', async () => await switchView('view'));
                cancelledBtn.addEventListener('click', async () => await switchView('cancelled'));
                uploadBtn.addEventListener('click', async () => await switchView('upload'));
                checkBtn.addEventListener('click', async () => await switchView('check'));
                
                
                filePicker.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    fileNameEl.textContent = 'Đã chọn: ' + file.name;
                });
                // Explicit Upload button inside panel
                const uploadActionBtn = document.getElementById('doUpload');
                if (uploadActionBtn) uploadActionBtn.addEventListener('click', () => {
                    if (!filePicker.files || !filePicker.files[0]) {
                        setStatus('Vui lòng chọn hoặc kéo thả tệp trước khi upload.', 'warn');
                        ensureInputFocus();
                        return;
                    }
                    uploadActionBtn.disabled = true;
                    setProgress(0);
                    document.querySelector('.progress-line').style.display = '';
                    setStatus('Đang tải file lên...', '');
                    let loadingInterval = null;
                    let loadingStep = 0;
                    function showPendingEffect() {
                        loadingInterval = setInterval(() => {
                            loadingStep = (loadingStep + 1) % 4;
                            setStatus('Đang xử lý dữ liệu' + '.'.repeat(loadingStep), '');
                            ensureInputFocus();
                        }, 700);
                    }
                    showPendingEffect();
                    (async () => {
                        try {
                            const result = await uploadFileWithProgress(filePicker.files[0]);
                            clearInterval(loadingInterval);
                            setStatus('Đang hoàn tất...', '');
                            setTimeout(async () => {
                                if (result.success) {
                                    setStatus(result.message || 'Upload thành công', 'ok');
                                    ensureInputFocus();
                                    
                                    // Hiển thị modal thông báo upload thành công
                                    showSuccessModal(
                                        'Upload thành công!',
                                        result.message || 'Dữ liệu đã được tải lên thành công.\nSẵn sàng để kiểm tra.',
                                        3000
                                    );
                                    
                                    // Hiển thị kết quả chi tiết
                                    if (result.data && result.data.errors && result.data.errors.length) {
                                        let errHtml = '<div style="color:#991b1b;font-size:14px;margin-top:8px;">Có lỗi xảy ra:</div>';
                                        for (const err of result.data.errors) {
                                            errHtml += `<div>- ${escapeHtml(err)}</div>`;
                                        }
                                        document.getElementById('rows').innerHTML = errHtml;
                                    } else {
                                        document.getElementById('rows').innerHTML = '<div style="color:#065f46;font-size:14px;margin-top:8px;">Dữ liệu đã được tải lên thành công. Sẵn sàng để kiểm tra.</div>';
                                    }
                                    // Tự động chuyển sang tab Xem đơn hàng
                                    await switchView('view');
                                    // Auto-refresh sẽ được gọi trong switchView('view')
                                } else {
                                    setStatus(result.message || 'Upload không thành công', 'err');
                                    ensureInputFocus();
                                    showErrorModal(
                                        'Upload thất bại',
                                        result.message || 'Có lỗi xảy ra khi upload file. Vui lòng thử lại.'
                                    );
                                }
                            }, 300);
                        } catch (e) {
                            clearInterval(loadingInterval);
                            setStatus('Có lỗi xảy ra khi tải lên', 'err');
                            ensureInputFocus();
                            showErrorModal(
                                'Lỗi upload',
                                'Có lỗi xảy ra khi tải file lên server.\nVui lòng kiểm tra kết nối và thử lại.'
                            );
                        }
                    })();
                });
                const dropHandler = async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const files = e.dataTransfer.files;
                    if (files && files.length) {
                        filePicker.files = files;
                        fileNameEl.textContent = 'Đã chọn: ' + files[0].name;
                        uploadActionBtn.click();
                    }
                };
                drop.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
                drop.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
                drop.addEventListener('drop', dropHandler);

                // Drag & Drop for ComboData
                const dropzoneCombo = document.getElementById('dropzoneCombo');
                if (dropzoneCombo) {
                    const dropHandlerCombo = async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const files = e.dataTransfer.files;
                        if (files && files.length) {
                            fileComboPicker.files = files;
                            fileComboName.textContent = 'Đã chọn: ' + files[0].name;
                        }
                    };
                    dropzoneCombo.addEventListener('dragover', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        dropzoneCombo.classList.add('drag'); 
                    });
                    dropzoneCombo.addEventListener('dragleave', (e) => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        dropzoneCombo.classList.remove('drag'); 
                    });
                    dropzoneCombo.addEventListener('drop', dropHandlerCombo);
                }

                // Upload MasterData
                if (fileMasterPicker) fileMasterPicker.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    fileMasterName.textContent = 'Đã chọn: ' + file.name;
                });
                if (doUploadMaster) doUploadMaster.addEventListener('click', () => {
                    if (!fileMasterPicker.files || !fileMasterPicker.files[0]) {
                        showToast('Vui lòng chọn file MasterData!', false);
                        return;
                    }
                    doUploadMaster.disabled = true;
                    uploadMasterBar.style.width = '0%';
                    document.querySelectorAll('.progress-line')[1].style.display = '';
                    showToast('Đang tải MasterData...', true);
                    (async () => {
                        try {
                            const form = new FormData();
                            form.append('file', fileMasterPicker.files[0]);
                            const token = getAuthToken();
                            
                            const res = await fetch('/api/checker/upload-masterdata', {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + token
                                },
                                body: form
                            });
                            uploadMasterBar.style.width = '100%';
                            const result = await res.json();
                            showToast(result.message || 'Upload MasterData thành công', result.success);
                            fileMasterPicker.value = '';
                            fileMasterName.textContent = '';
                        } catch (err) {
                            showToast('Lỗi upload MasterData!', false);
                        }
                        document.querySelectorAll('.progress-line')[1].style.display = 'none';
                        doUploadMaster.disabled = false;
                    })();
                });
                
                // Upload ComboData
                if (fileComboPicker) fileComboPicker.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    fileComboName.textContent = 'Đã chọn: ' + file.name;
                });
                
                if (doUploadCombo) doUploadCombo.addEventListener('click', () => {
                    if (!fileComboPicker.files || !fileComboPicker.files[0]) {
                        showToast('Vui lòng chọn file ComboData!', false);
                        return;
                    }
                    doUploadCombo.disabled = true;
                    uploadComboBar.style.width = '0%';
                    document.querySelectorAll('.progress-line')[2].style.display = '';
                    showToast('Đang tải ComboData...', true);
                    (async () => {
                        try {
                            const form = new FormData();
                            form.append('file', fileComboPicker.files[0]);
                            let token = '';
                            if (typeof getAuthToken === 'function') token = getAuthToken();
                            else if (sessionStorage.getItem('jwt')) token = sessionStorage.getItem('jwt');
                            const res = await fetch('/api/checker/upload-combodata', {
                                method: 'POST',
                                headers: token ? { 'Authorization': 'Bearer ' + token } : {},
                                body: form
                            });
                            uploadComboBar.style.width = '100%';
                            const result = await res.json();
                            showToast(result.message || 'Upload ComboData thành công', result.success);
                            fileComboPicker.value = '';
                            fileComboName.textContent = '';
                        } catch (err) {
                            showToast('Lỗi upload ComboData!', false);
                        }
                        document.querySelectorAll('.progress-line')[2].style.display = 'none';
                        doUploadCombo.disabled = false;
                    })();
                });

                // Fix ComboData
                if (fixComboData) fixComboData.addEventListener('click', async () => {
                    if (!confirm('Bạn có chắc muốn fix ComboData collection? Điều này sẽ xóa index cũ và tạo index mới.')) {
                        return;
                    }
                    
                    fixComboData.disabled = true;
                    showToast('Đang fix ComboData collection...', true);
                    
                    try {
                        let token = '';
                        if (typeof getAuthToken === 'function') token = getAuthToken();
                        else if (sessionStorage.getItem('jwt')) token = sessionStorage.getItem('jwt');
                        
                        const res = await fetch('/api/checker/fix-combodata', {
                            method: 'POST',
                            headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                        });
                        
                        const result = await res.json();
                        showToast(result.message || 'Fix ComboData thành công', result.success);
                        
                        if (result.success && result.indexes) {
                        }
                        
                    } catch (err) {
                        showToast('Lỗi fix ComboData!', false);
                        console.error('Fix ComboData error:', err);
                    }
                    
                    fixComboData.disabled = false;
                });
            }
            
            // Khởi tạo scanner info
            try {
                await loadMyScannerPermissions();
            } catch (error) {
            }
        });

        function showForbiddenOverlay() {
            let diag = document.getElementById('diagnosticOverlay');
            if (!diag) {
                diag = document.createElement('div');
                diag.id = 'diagnosticOverlay';
                diag.style.position = 'fixed';
                diag.style.top = '50%';
                diag.style.left = '50%';
                diag.style.transform = 'translate(-50%,-50%)';
                diag.style.zIndex = '9999';
                diag.style.background = '#fff';
                diag.style.border = '2px solid #ef4444';
                diag.style.borderRadius = '10px';
                diag.style.padding = '24px 32px';
                diag.style.fontSize = '16px';
                diag.style.color = '#b91c1c';
                diag.style.boxShadow = '0 2px 12px #ef444433';
                diag.style.maxWidth = '420px';
                diag.style.wordBreak = 'break-all';
                diag.innerHTML = `<b>Lỗi truy cập (403)</b><br><br>Bạn không có quyền truy cập vào trang này.<br>Vui lòng đăng nhập lại hoặc liên hệ quản trị viên.<br><br><button style='margin-top:12px;padding:8px 18px;border-radius:6px;background:#ef4444;color:#fff;border:none;cursor:pointer;' onclick='location.href="/login"'>Đăng nhập lại</button>`;
                document.body.appendChild(diag);
            }
        }

        // ==================== SCANNER INFO FUNCTIONS ====================
        
        // Lấy thông tin máy quét được phân quyền cho user hiện tại
        async function loadMyScannerPermissions() {
            try {
                
                const response = await fetch('/api/me', {
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // User info loaded successfully
                    
                    // Tạo scannerPermissions giả để hiển thị button
                    result.scannerPermissions = {
                        allowedScanners: ['COM_PORT_AVAILABLE'],
                        assignedScanner: 'COM_PORT_AVAILABLE',
                        port: 'COM_PORT_AVAILABLE'
                    };
                    
                    // Tạo danh sách scanners giả để tương thích với displayScannerPermissions
                    const mockScanners = [{
                        scannerId: 'COM_PORT_AVAILABLE',
                        scannerName: 'Máy quét COM Port',
                        status: 'available',
                        assignedTo: result.username,
                        sessionId: null,
                        assignedAt: new Date().toISOString(),
                        expiresAt: null,
                        realPort: {
                            path: 'COM_PORT_AVAILABLE',
                            manufacturer: 'Unknown',
                            vendorId: null,
                            productId: null
                        },
                        isConnected: false,
                        portInfo: {
                            path: 'COM_PORT_AVAILABLE',
                            manufacturer: 'Unknown',
                            vendorId: null,
                            productId: null
                        },
                        isNewPort: true,
                        confidence: 100,
                        deviceType: 'scanner',
                        note: 'Click để chọn thiết bị COM port'
                    }];
                    
                    displayScannerPermissions(result, mockScanners);
                } else {
                    console.error('[LOAD-SCANNER] /api/me failed:', result.message);
                    console.error('[LOAD-SCANNER] User chưa login hoặc session hết hạn!');
                }
            } catch (error) {
                console.error('[LOAD-SCANNER] Exception:', error);
                console.error('[LOAD-SCANNER] Stack:', error.stack);
            }
        }

        // Hiển thị thông tin máy quét được phân quyền
        function displayScannerPermissions(userInfo, allScanners) {
            const noScannerInfo = document.getElementById('noScannerInfo');
            const scannerDetails = document.getElementById('scannerDetails');
            const allowedScannersSpan = document.getElementById('allowedScanners');
            const currentAssignedScannerSpan = document.getElementById('currentAssignedScanner');
            const assignedPortSpan = document.getElementById('assignedPort');

            // Kiểm tra conflict máy quét
            if (userInfo.scannerConflict) {
                showToast(userInfo.scannerConflict.message, false);
                
                // Hiển thị thông báo conflict
                const conflictDiv = document.createElement('div');
                conflictDiv.style.cssText = 'margin-top: 10px; padding: 10px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; font-size: 14px;';
                conflictDiv.innerHTML = `
                    <strong>⚠️ Cảnh báo:</strong><br>
                    ${userInfo.scannerConflict.message}<br>
                    <small>Liên hệ admin để giải quyết</small>
                `;
                
                const scannerInfo = document.getElementById('scannerInfo');
                scannerInfo.appendChild(conflictDiv);
            }

            // Kiểm tra xem user có quyền máy quét không
            if (!userInfo.scannerPermissions || !userInfo.scannerPermissions.allowedScanners || userInfo.scannerPermissions.allowedScanners.length === 0) {
                noScannerInfo.style.display = 'block';
                scannerDetails.style.display = 'none';
                return;
            }

            // Hiển thị thông tin máy quét được phép
            const allowedScannerNames = userInfo.scannerPermissions.allowedScanners.map(scannerId => {
                const scanner = allScanners.find(s => s.scannerId === scannerId);
                return scanner ? scanner.scannerName : scannerId;
            });

            allowedScannersSpan.textContent = allowedScannerNames.join(', ');

            // Hiển thị máy quét hiện tại được assign
            if (userInfo.scannerPermissions.assignedScanner) {
                const assignedScanner = allScanners.find(s => s.scannerId === userInfo.scannerPermissions.assignedScanner);
                currentAssignedScannerSpan.textContent = assignedScanner ? assignedScanner.scannerName : userInfo.scannerPermissions.assignedScanner;
                currentAssignedScannerSpan.style.color = '#28a745';
                currentAssignedScannerSpan.style.fontWeight = 'bold';
            } else {
                currentAssignedScannerSpan.textContent = 'Chưa được assign';
                currentAssignedScannerSpan.style.color = '#999';
            }

            // Hiển thị button kết nối COM port cho tất cả user (giống debug-client.html)
            
            // Hiển thị thông tin
            assignedPortSpan.textContent = 'Click để chọn thiết bị';
            assignedPortSpan.style.color = '#007bff';
            assignedPortSpan.style.fontWeight = 'bold';

            noScannerInfo.style.display = 'none';
            scannerDetails.style.display = 'block';
            
        }

        // Hiển thị modal blocking khi chưa được phân quyền máy quét
        function showBlockingModal() {
            showModal({
                type: 'warning',
                title: '⚠️ Chưa có quyền sử dụng máy quét',
                message: 'Admin chưa phân quyền máy quét COM cho bạn.\n\nVui lòng liên hệ admin để được cấp quyền sử dụng máy quét trước khi thực hiện công việc.',
                buttons: [
                    {
                        text: 'Làm mới trang',
                        class: 'primary',
                        onclick: () => {
                            location.reload();
                        }
                    },
                    {
                        text: 'Đăng xuất',
                        class: 'secondary',
                        onclick: async () => {
                            await fetch('/api/logout', { method: 'POST', credentials: 'include' });
                            location.href = '/login';
                        }
                    }
                ]
            });

            // Disable tất cả input và nút
            const input = document.getElementById('codeInput');
            if (input) input.disabled = true;
            
            const allButtons = document.querySelectorAll('.btn');
            allButtons.forEach(btn => {
                if (!btn.textContent.includes('Làm mới') && !btn.textContent.includes('Đăng xuất')) {
                    btn.disabled = true;
                }
            });
        }

        // ==================== SERIAL SCANNER COM PORT INTEGRATION ====================
        let serialScanner = null;
        let isComConnected = false;
        let userAssignedPort = null; // Cổng COM được admin phân quyền
        let currentPort = null; // Port hiện tại đang kết nối
        let currentComPort = null; // Tên COM port hiện tại đang kết nối
        let isListening = false; // Trạng thái đang lắng nghe
        let isConnecting = false; // Trạng thái đang kết nối (tránh claim port liên tục)
        
        // Machine and session tracking
        let machineId = null;
        let sessionId = null;
        let heartbeatInterval = null;

        // Generate unique machine ID (based on browser fingerprint)
        function generateMachineId() {
            if (machineId) return machineId;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Machine ID', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL()
            ].join('|');
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            machineId = 'MACHINE_' + Math.abs(hash).toString(36);
            return machineId;
        }
        
        // Generate unique session ID (unique per browser tab/window)
        function generateSessionId() {
            if (sessionId) return sessionId;
            
            // Tạo session ID dựa trên timestamp + random + tab ID để đảm bảo unique
            const tabId = Math.random().toString(36).substr(2, 8);
            sessionId = 'SESSION_' + Date.now() + '_' + tabId;
            return sessionId;
        }
        
        // Start heartbeat to keep port alive
        function startHeartbeat() {
            if (heartbeatInterval) return;
            
            heartbeatInterval = setInterval(async () => {
                if (currentComPort && isComConnected) {
                    try {
                        await fetch('/api/update-heartbeat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ comPort: currentComPort })
                        });
                    } catch (error) {
                    }
                }
            }, 10000); // Update every 10 seconds
            
        }
        
        // Stop heartbeat
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Khởi tạo SerialScanner
        function initSerialScanner() {

            // Kiểm tra browser support
            if (!navigator.serial) {
                console.warn('⚠️  Browser không hỗ trợ Web Serial API');
                const statusEl = document.getElementById('comStatus');
                if (statusEl) statusEl.innerHTML = '<span style="color: #f44336;">Browser không hỗ trợ</span>';
                const btnEl = document.getElementById('connectComBtn');
                if (btnEl) btnEl.disabled = true;
                return;
            }


            // Xử lý nút kết nối (dùng để ngắt kết nối hoặc kết nối lại)
            const connectBtn = document.getElementById('connectComBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', handleComConnection);
            }
        }

        // Xử lý kết nối/ngắt kết nối COM port
        async function handleComConnection() {
            
            if (isConnecting) {
                return;
            }
            
            if (isComConnected) {
                await disconnectCom();
            } else {
                // Flow mới: Gọi API lấy danh sách COM ports → User chọn → Connect
                await showComPortSelection();
            }
        }
        
        // Hiển thị dialog chọn COM port (giống debug-client.html)
        async function showComPortSelection() {
            try {
                
                // Set flag đang kết nối
                isConnecting = true;
                
                // Kiểm tra hỗ trợ Web Serial API
                if (!navigator.serial) {
                    alert('Trình duyệt không hỗ trợ Web Serial API. Vui lòng sử dụng Chrome/Edge mới nhất.');
                    isConnecting = false;
                    return;
                }
                
                // Yêu cầu user chọn thiết bị COM port (giống debug-client.html)
                const port = await navigator.serial.requestPort();
                
                const portInfo = port.getInfo();
                
                // Lấy tên COM port từ port info hoặc sử dụng tên mặc định
                let comPortName = 'COM_UNKNOWN';
                
                
                // Tạo tên unique cho mỗi port để tránh trùng giữa các user trên cùng máy
                const machineId = generateMachineId();
                const sessionId = generateSessionId();
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 5);
                
                if (portInfo.path) {
                    // Sử dụng path + session ID để phân biệt user trên cùng máy
                    comPortName = `${portInfo.path}_${sessionId}`;
                } else {
                    // Tạo tên unique dựa trên timestamp + random + session ID
                    comPortName = `COM_${timestamp}_${random}_${sessionId}`;
                }
                
                
                // Claim port trực tiếp (atomic operation, không cần check trước)
                const claimResult = await claimPort(comPortName, machineId, sessionId);
                if (!claimResult.success) {
                    alert(claimResult.message);
                    isConnecting = false;
                    return;
                }
                
                // Kết nối với COM port đã chọn
                await connectToSelectedComPort(comPortName, port);
                
                // Reset flag đang kết nối
                isConnecting = false;
                
            } catch (error) {
                console.error('Error selecting COM port:', error);
                
                // Reset trạng thái khi có lỗi
                isComConnected = false;
                currentComPort = null;
                currentPort = null;
                isListening = false;
                isConnecting = false;
                
                let errorMsg = 'Lỗi chọn COM port: ' + error.message;
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'Bạn đã từ chối quyền truy cập. Vui lòng thử lại và chọn "Cho phép".';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'Không tìm thấy COM port. Vui lòng kiểm tra kết nối thiết bị.';
                }
                
                alert(errorMsg);
            }
        }
        
        // Kết nối với COM port đã chọn (giống debug-client.html)
        async function connectToSelectedComPort(comPort, port) {
            const statusSpan = document.getElementById('comStatus');
            const connectBtn = document.getElementById('connectComBtn');
            
            try {
                statusSpan.innerHTML = `<span style="color: #2196f3;">⏳ Đang kết nối ${comPort}...</span>`;
                connectBtn.disabled = true;
                
                // Kiểm tra hỗ trợ Web Serial API
                if (!navigator.serial) {
                    throw new Error('Browser không hỗ trợ Web Serial API');
                }
                
                // Đóng port cũ nếu đang mở
                if (currentPort) {
                    try {
                        await currentPort.close();
                    } catch (closeError) {
                    }
                    currentPort = null;
                }
                
                // Kiểm tra port đã mở chưa
                if (port.readable) {
                    try {
                        await port.close();
                    } catch (closeError) {
                    }
                }
                
                // Kiểm tra xem port đã được claim bởi chính user hiện tại chưa
                const currentUser = getCurrentUsername();
                const isPortInUse = await checkPortUsage(comPort);
                
                if (isPortInUse) {
                    throw new Error(`COM port ${comPort} đang được sử dụng bởi user khác`);
                }
                
                // Mở port với cấu hình tối ưu cho scanner
                // Thử nhiều baud rate phổ biến cho scanner
                const baudRates = [9600, 115200, 38400, 19200, 4800];
                let connected = false;
                
                for (const baudRate of baudRates) {
                    try {
                        await port.open({ 
                            baudRate: baudRate,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none',
                            flowControl: 'none'
                        });
                        console.log(`✅ Kết nối thành công với baud rate: ${baudRate}`);
                        connected = true;
                        break;
                    } catch (openError) {
                        console.log(`⚠️ Không thể kết nối với baud rate ${baudRate}:`, openError.message);
                        // Đóng port trước khi thử baud rate khác
                        try {
                            await port.close();
                        } catch (closeError) {
                            // Ignore close errors
                        }
                    }
                }
                
                if (!connected) {
                    throw new Error('Không thể kết nối với bất kỳ baud rate nào. Vui lòng kiểm tra thiết bị scanner.');
                }
                
                
                // Lưu port và tên COM port để sử dụng sau này
                currentPort = port;
                currentComPort = comPort;
                
                // Cập nhật status thành công
                isComConnected = true;
                statusSpan.innerHTML = `<span style="color: #4caf50;"> Đã kết nối ${comPort}</span>`;
                connectBtn.textContent = '🔌 Ngắt kết nối COM';
                connectBtn.style.background = '#f44336';
                connectBtn.disabled = false;
                
                // Start heartbeat để keep port alive
                startHeartbeat();
                
                // Bắt đầu đọc dữ liệu với buffer để xử lý dữ liệu đầy đủ
                let dataBuffer = '';
                const reader = port.readable.getReader();
                isListening = true;
                
                console.log('🔍 Bắt đầu đọc dữ liệu từ COM port với buffer...');
                
                // Lắng nghe dữ liệu liên tục
                while (isListening) {
                    try {
                        const { value, done } = await reader.read();
                        
                        if (done) {
                            console.log('📡 COM port reader đã đóng');
                            break;
                        }
                        
                        // Chuyển đổi dữ liệu thành string và thêm vào buffer
                        const chunk = new TextDecoder().decode(value);
                        dataBuffer += chunk;
                        
                        console.log('📥 Nhận chunk từ COM:', chunk, '(buffer hiện tại:', dataBuffer, ')');
                        
                        // Kiểm tra ký tự kết thúc (thường là \r\n, \n, hoặc \r)
                        if (dataBuffer.includes('\n') || dataBuffer.includes('\r')) {
                            // Tách dữ liệu hoàn chỉnh từ buffer
                            const lines = dataBuffer.split(/[\r\n]+/);
                            
                            // Xử lý tất cả dòng hoàn chỉnh (trừ dòng cuối nếu chưa kết thúc)
                            for (let i = 0; i < lines.length - 1; i++) {
                                const line = lines[i].trim();
                                
                                if (line) {
                                    console.log('✅ Dữ liệu hoàn chỉnh từ COM:', line);
                                    
                                    // Gửi dữ liệu lên server để log
                                    sendComInputToServer(currentComPort, line);
                                    
                                    // Đưa dữ liệu vào input field và tự động xử lý
                                    const input = document.getElementById('codeInput');
                                    if (input) {
                                        // Tự động đóng modal trước khi xử lý dữ liệu
                                        hideModal();
                                        
                                        // Focus vào input field
                                        input.focus();
                                        
                                        // Điền dữ liệu
                                        input.value = line;
                                        
                                        // Trigger input event để các listener khác có thể xử lý
                                        input.dispatchEvent(new Event('input', { bubbles: true }));
                                        
                                        // Tự động xử lý dữ liệu sau 100ms
                                        setTimeout(() => {
                                            try {
                                                // Đảm bảo modal được đóng trước khi xử lý
                                                hideModal();
                                                handleEnter(line);
                                            } catch (e) {
                                                console.error('Lỗi xử lý dữ liệu:', e);
                                            }
                                        }, 100);
                                    }
                                }
                            }
                            
                            // Giữ lại phần dữ liệu chưa hoàn chỉnh trong buffer
                            dataBuffer = lines[lines.length - 1];
                        }
                        
                    } catch (readError) {
                        console.error('❌ Lỗi đọc từ COM port:', readError);
                        break;
                    }
                }
                
            } catch (error) {
                statusSpan.innerHTML = `<span style="color: #f44336;">Lỗi kết nối ${comPort}: ${error.message}</span>`;
                
                // Reset trạng thái khi có lỗi
                isComConnected = false;
                currentComPort = null;
                currentPort = null;
                isListening = false;
                isConnecting = false;
                
                connectBtn.textContent = '🔌 Kết nối máy quét COM';
                connectBtn.style.background = '#2196f3';
                connectBtn.disabled = false;
            }
        }
        
        // Gửi dữ liệu COM port lên server
        async function sendComInputToServer(comPort, inputData) {
            try {
                const username = getCurrentUsername();
                const currentSessionId = generateSessionId();
                
                
                const response = await fetch('/api/com-input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: username || 'unknown_user',
                        comPort: comPort,
                        inputData: inputData.trim(),
                        timestamp: new Date().toISOString(),
                        sessionId: currentSessionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                } else {
                }
                
            } catch (error) {
            }
        }
        
        // Lấy username hiện tại
        function getCurrentUsername() {
            try {
                const token = sessionStorage.getItem('auth_token') || sessionStorage.getItem('checkerAuthToken');
                if (token) {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.username;
                }
                return null;
            } catch (error) {
                console.error('Error getting username:', error);
                return null;
            }
        }

        // Kết nối COM port
        async function connectCom() {
            const statusSpan = document.getElementById('comStatus');
            const connectBtn = document.getElementById('connectComBtn');

            try {
                statusSpan.innerHTML = '<span style="color: #2196f3;">⏳ Đang kết nối...</span>';
                connectBtn.disabled = true;

                // Yêu cầu chọn port
                await serialScanner.requestPort();

                // Kết nối với baudRate 9600 (có thể điều chỉnh)
                await serialScanner.connect(9600);

                // Bắt đầu đọc dữ liệu
                serialScanner.startReading((scannedData) => {
                    
                    // Tự động đóng modal trước khi xử lý dữ liệu
                    hideModal();
                    
                    const input = document.getElementById('codeInput');
                    if (input) {
                        input.value = scannedData;
                        try {
                            // Đảm bảo modal được đóng trước khi xử lý
                            hideModal();
                            handleEnter(scannedData);
                        } catch (e) {
                            console.error('Lỗi:', e);
                        }
                        input.value = '';
                    }
                });

                isComConnected = true;
                statusSpan.innerHTML = '<span style="color: #4caf50;"> Đã kết nối</span>';
                connectBtn.textContent = '🔌 Ngắt kết nối COM';
                connectBtn.style.background = '#f44336';
                connectBtn.disabled = false;

                
            } catch (error) {
                statusSpan.innerHTML = '<span style="color: #f44336;">' + error.message + '</span>';
                connectBtn.disabled = false;
                isComConnected = false;
            }
        }

        // Ngắt kết nối COM port
        async function disconnectCom() {
            const statusSpan = document.getElementById('comStatus');
            const connectBtn = document.getElementById('connectComBtn');

            try {
                statusSpan.innerHTML = '<span style="color: #ff9800;">⏳ Đang ngắt kết nối...</span>';
                
                // Dừng việc đọc dữ liệu trước
                isListening = false;
                
                // Release port từ database
                if (currentComPort) {
                    try {
                        await releasePort(currentComPort);
                    } catch (releaseError) {
                        console.warn('⚠️ [DISCONNECT] Lỗi release port:', releaseError.message);
                    }
                }
                
                // Ngắt kết nối COM port
                if (currentPort) {
                    try {
                        await currentPort.close();
                    } catch (closeError) {
                    }
                    currentPort = null;
                } else {
                }
                
                // Stop heartbeat
                stopHeartbeat();
                
                // Cập nhật trạng thái
                isComConnected = false;
                currentComPort = null; // Reset COM port name
                currentPort = null; // Reset COM port object
                isListening = false; // Reset listening state
                isConnecting = false; // Reset connecting state
                statusSpan.innerHTML = '<span style="color: #999;">⚫ Chưa kết nối</span>';
                connectBtn.textContent = '🔌 Kết nối máy quét COM';
                connectBtn.style.background = '#2196f3';
                connectBtn.disabled = false;

                
            } catch (error) {
                console.error('[DISCONNECT] Lỗi ngắt kết nối:', error);
                statusSpan.innerHTML = '<span style="color: #f44336;">Lỗi ngắt kết nối</span>';
                
                // Force reset trạng thái ngay cả khi có lỗi
                isComConnected = false;
                isListening = false;
                currentPort = null;
                isConnecting = false;
                connectBtn.textContent = '🔌 Kết nối máy quét COM';
                connectBtn.style.background = '#2196f3';
                connectBtn.disabled = false;
            }
        }

        // Kiểm tra xem COM port đã được sử dụng chưa (deprecated - dùng atomic claim thay thế)
        async function checkPortUsage(comPortName) {
            try {
                
                // Gọi API kiểm tra port usage
                const response = await fetch('/api/check-port-usage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comPort: comPortName })
                });
                
                const result = await response.json();
                
                // Kiểm tra xem port có đang được sử dụng bởi user khác không
                if (result.isInUse && result.currentUser && result.currentUser !== getCurrentUsername()) {
                    return true;
                }
                
                return false;
                
            } catch (error) {
                // Nếu không kiểm tra được, từ chối kết nối để tránh conflict
                return true;
            }
        }
        
        // Claim port khi kết nối (atomic operation)
        async function claimPort(comPortName, machineIdParam = null, sessionIdParam = null) {
            try {
                
                // Sử dụng machineId và sessionId được truyền vào hoặc tạo mới
                const machineId = machineIdParam || generateMachineId();
                const sessionId = sessionIdParam || generateSessionId();
                const screenId = 'main'; // Default screen, could be enhanced for multiple screens
                
                // Gọi API claim port với atomic transaction
                const response = await fetch('/api/claim-port', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        comPort: comPortName,
                        machineId: machineId,
                        sessionId: sessionId,
                        screenId: screenId
                    })
                });
                
                const result = await response.json();
                
                return result;
                
            } catch (error) {
                return {
                    success: false,
                    message: 'Lỗi claim port: ' + error.message
                };
            }
        }
        
        // Release port khi ngắt kết nối
        async function releasePort(comPortName) {
            try {
                
                // Gọi API release port cho bất kỳ user nào
                const response = await fetch('/api/release-port-any', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comPort: comPortName })
                });
                
                const result = await response.json();
                
                return result;
                
            } catch (error) {
                console.error('[RELEASE-PORT] Lỗi release port:', error);
                return {
                    success: false,
                    message: 'Lỗi release port: ' + error.message
                };
            }
        }
        
        // Release port cho bất kỳ user nào (dùng khi logout)
        async function releasePortForAnyUser(comPortName) {
            try {
                
                // Gọi API release port cho bất kỳ user nào
                const response = await fetch('/api/release-port-any', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comPort: comPortName })
                });
                
                const result = await response.json();
                
                return result;
                
            } catch (error) {
                console.error('[RELEASE-PORT-ANY] Lỗi release port:', error);
                return {
                    success: false,
                    message: 'Lỗi release port: ' + error.message
                };
            }
        }
        
        // Kiểm tra trạng thái COM port
        function checkComPortStatus() {
            
            const statusSpan = document.getElementById('comStatus');
            const connectBtn = document.getElementById('connectComBtn');
            
            // Kiểm tra port usage trong database
            if (currentComPort) {
                checkPortUsage(currentComPort).then(result => {
                });
            }
        }
        
        // ========== STATE MACHINE COMPATIBILITY FUNCTIONS ==========
        
        // Xác nhận hoàn thành đơn vận đơn (tương thích với State Machine)
        async function confirmVanDonComplete() {
            try {
                if (orderCheckSM.currentOrder) {
                    // Sử dụng State Machine
                    await orderCheckSM.completeOrder();
                } else {
                    // Fallback cho logic cũ
                    const response = await fetch('/api/orders/complete-van-don', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getAuthToken()
                        },
                        body: JSON.stringify({
                            maVanDon: currentMaVanDon
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setStatus('Đã xác nhận hoàn thành đơn vận đơn!', 'ok');
                        ensureInputFocus();
                        
                        // Reset trạng thái quét sau khi xác nhận hoàn thành
                        orderCheckState = 'idle';
                        scannedItems = [];
                        currentMaVanDon = '';
                        cacheOrders = [];
                        waitingForNewOrder = false;
                        
                        showModal({
                            type: 'success',
                            title: 'Hoàn thành!',
                            message: result.message,
                            timeout: 2000
                        });
                    } else {
                        setStatus('Lỗi xác nhận: ' + result.message, 'err');
                        ensureInputFocus();
                        
                        showModal({
                            type: 'error',
                            title: 'Lỗi xác nhận',
                            message: result.message
                        });
                    }
                }
                
            } catch (error) {
                setStatus('Lỗi xác nhận đơn vận đơn: ' + error.message, 'err');
                ensureInputFocus();
                
                showModal({
                    type: 'error',
                    title: 'Lỗi kết nối',
                    message: 'Lỗi xác nhận đơn vận đơn: ' + error.message
                });
            }
        }
        
        // Chuyển sang đơn khác (tương thích với State Machine)
        function switchToNewOrder() {
            if (orderCheckSM.currentOrder) {
                // Sử dụng State Machine
                orderCheckSM.reset();
                setStatus('Đã reset. Hãy tìm đơn hàng mới.', 'info');
                ensureInputFocus();
            } else {
                // Fallback cho logic cũ
                // KHÔNG cho phép chuyển đơn khi đã có đơn hàng trong qtext
                if (currentMaVanDon) {
                    setStatus(`Đã có đơn ${currentMaVanDon} đang xử lý, không thể chuyển đơn khác`, 'err');
                    showModal({
                        type: 'warning',
                        title: 'Không thể chuyển đơn',
                        message: `Đã có đơn ${currentMaVanDon} đang xử lý. Vui lòng hoàn thành hoặc hủy đơn hiện tại trước khi chuyển đơn khác.`
                    });
                    return;
                }
                
                // Unblock đơn hiện tại trước khi chuyển
                if (currentMaVanDon) {
                    fetch('/api/orders/unblock-van-don', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': 'Bearer ' + getAuthToken() 
                        },
                        body: JSON.stringify({ maVanDon: currentMaVanDon })
                    }).catch(e => console.log('Lỗi unblock:', e));
                }
                
                // Reset trạng thái quét
                orderCheckState = 'idle';
                scannedItems = [];
                currentMaVanDon = '';
                cacheOrders = [];
                currentVanDonStatus = null;
                waitingForNewOrder = true; // Cho phép input đơn mới
                document.getElementById('maVanDonTag').textContent = 'Chưa chọn';
                
                // Cập nhật giao diện
                renderQueue();
                renderOrders();
                setStatus('Đã reset. Hãy tìm đơn hàng mới.', 'info');
                ensureInputFocus();
            }
        }
        
        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initSerialScanner();
                loadScannerInfo();
            }, 500);
        });
        
        // Đóng tất cả ports khi trang được unload
        window.addEventListener('beforeunload', async function() {
            if (isComConnected && currentComPort) {
                try {
                    
                    // Dừng đọc dữ liệu
                    isListening = false;
                    
                    // Stop heartbeat
                    stopHeartbeat();
                    
                    // Xóa bản ghi port từ database
                    if (currentComPort) {
                        try {
                            await fetch('/api/delete-port', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ comPort: currentComPort })
                            });
                        } catch (deleteError) {
                        }
                    }
                    
                    // Đóng COM port
                    if (currentPort) {
                        await currentPort.close();
                    }
                    
                    // Reset trạng thái
                    isComConnected = false;
                    currentComPort = null;
                    currentPort = null;
                    
                } catch (error) {
                }
            }
        });

        // ==================== END SCANNER INFO FUNCTIONS ====================
    </script>
</body>
</html>
