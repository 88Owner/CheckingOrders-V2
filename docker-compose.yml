services:
  mongodb:
    image: mongo:7.0
    container_name: ordercheck-mongodb-v2
    ports:
      - "0.0.0.0:27017:27017"  # Bind trên tất cả interfaces để cho phép remote access
    volumes:
      - mongodb_data:/data/db
      - ./init-data.js:/docker-entrypoint-initdb.d/init-data.js:ro
    restart: unless-stopped
    networks:
      - ordercheck-network
    command: mongod --bind_ip_all  # Cho phép kết nối từ tất cả IP, không có authentication

  ordercheck:
    build: .
    container_name: ordercheck-app-v2
    ports:
      - "3001:3001"
    environment:
      MONGODB_URI: mongodb://mongodb:27017/OrderDetailing
      SESSION_SECRET: change_this_session_secret_in_production
      PORT: 3001
      NODE_ENV: production
      # ERPNext Configuration
      # Nếu ERPNext chạy trên máy host (không trong Docker), dùng host.docker.internal
      # Nếu ERPNext chạy trong Docker khác, dùng tên service hoặc IP container
      ERPNEXT_URL: ${ERPNEXT_URL:-http://host.docker.internal:8080}
      ERPNEXT_API_KEY: ${ERPNEXT_API_KEY:-7da6579c83ee8ff}
      ERPNEXT_API_SECRET: ${ERPNEXT_API_SECRET:-406e4001191ddc0}
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    restart: unless-stopped
    depends_on:
      - mongodb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ordercheck-network

volumes:
  mongodb_data:

networks:
  ordercheck-network:
    driver: bridge
